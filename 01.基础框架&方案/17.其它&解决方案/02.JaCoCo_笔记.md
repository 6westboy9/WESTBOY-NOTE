JaCoCo使用插桩的方式来记录覆盖率数据。一般有两种插桩模式：

- 离线模式（offline）：一般在**单元测试**中试用。
- 在线模式（on-the-fly）：对于启动时指定`-javaagent:jacocoagent.jar`时，javaagent会在ClassLoader装载一个class前判断是否需要修改，并将探针插入class文件，探针不改变原有方法的行为，只是记录是否已经执行。

## 操作步骤

### 1.准备

下载JaCoCo相关文件，官网下载地址：[https://www.eclemma.org/jacoco](https://www.eclemma.org/jacoco/)

准备目标应用，在此准备的应用是`data_sync`，并编译打包完成。

```shell
$ mvn clean package -DskipTests
```

两个项目所在路径：

![[Pasted image 20231024170734.png|500]]
### 2.启动

<font color="#f79646">注意：运行命令的当前路径是D:/IdeaProjects2/data_sync（即项目的根目录下），下文中如果没有特殊说明，都将在此路径下运行所有命令~</font>

```shell
# 注意:并非后台运行方式
$ java -javaagent:../jacoco-0.8.11/lib/jacocoagent.jar=includes=*,output=tcpserver,port=6301,address=localhost,append=false -jar data-sync-web/target/WRMSSync.jar
```

### 3.转储-dump

```shell
# 因为上面并非后台运行方式，所以需要另起Console执行
$ java -jar ../jacoco-0.8.11/lib/jacococli.jar dump --address localhost --port 6301 --destfile jacoco-sync.exec
[INFO] Connecting to localhost/127.0.0.1:6301.
[INFO] Writing execution data to D:\IdeaProjects2\data_sync\jacoco-sync.exec.
```

### 4生成报告-report

```shell
# 乱码问题，使用--encoding utf-8
$ java -jar ../jacoco-0.8.11/lib/jacococli.jar report jacoco-sync.exec --classfiles data-sync-web/target/classes --sourcefiles data-sync-web/target/source --html report --encoding utf-8
```

在当前路径下找到report文件下的index.html文件，点击打开。

![[Pasted image 20231023235945.png|1000]]

**注意**：发现只有`data-sync-web`模块下的代码，而没有`data-sync-controller`和`data-sync-service`下的代码。这个问题和解决方案参考问题汇总的多模块问题部分。

### 5.扩展-classinfo

```shell
$ java -jar ../jacoco-0.8.11/lib/jacococli.jar classinfo jacoco-sync.exec data-sync-controller/target/classes/com/lachesis/datasync/controller/PumaTestController.class
  INST   BRAN   LINE   METH   CXTY   ELEMENT
    26      2      7      5      6   class 0x767e643bb868b314 com/lachesis/datasync/controller/PumaTestController
```

## 报告说明


TODO

## 问题汇总

记录过程中的遇到的问题与解决方案。
### 中文乱码问题


只需要在命令后面跟上`--encoding utf-8`即可解决。
### 多模块问题

使用JaCoCo时，使用javaagent的方式，应用软件打包为`data-sync-web.jar`，data_sync项目是通过maven构建，`data-sync-web`依赖了`data-sync-controller`和`data-sync-service`模块，在执行测试覆盖率的报告中并没有`data-sync-controller`和`data-sync-service`两个模块代码的覆盖信息。

1.在所有模块的pom.xml文件中新增如下插件。

```xml
<!-- 作用：在构建过程中生成包含项目源代码的JAR文件 -->
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-source-plugin</artifactId>
    <version>2.1.2</version>
    <executions>
        <execution>
            <id>attach-sources</id>
            <phase>package</phase>
            <goals>
                <goal>jar</goal>
            </goals>
        </execution>
    </executions>
</plugin>
```

**注意**：所有模块都添加，包括`data-sync-web`模块。执行maven构建后，每个模块下的target目录下都会到看到一个`xxx-sources.jar`的文件。

2.在`data-sync-web`模块的`pom.xml`文件中新增插件：

```xml
<!-- 该插件的作用是从项目依赖中提取源代码文件，并将这些源代码文件解压到指定的目录中 -->
<plugin>
    <groupId>org.apache.maven.plugins</groupId>
    <artifactId>maven-dependency-plugin</artifactId>
    <executions>
        <execution>
            <id>classes-merge</id>
            <phase>package</phase>
            <goals>
                <goal>unpack</goal>
            </goals>
            <configuration>
                <artifactItems>
                    <artifactItem>
                        <groupId>com.lachesis.etl</groupId>
                        <artifactId>data-sync-controller</artifactId>
                        <version>${parent.version}</version>
                        <type>jar</type>
                        <overWrite>false</overWrite>
                    </artifactItem>
                    <artifactItem>
                        <groupId>com.lachesis.etl</groupId>
                        <artifactId>data-sync-service</artifactId>
                        <version>${parent.version}</version>
                        <type>jar</type>
                        <overWrite>false</overWrite>
                    </artifactItem>
                </artifactItems>
                <includes>**/*.class</includes>
                <outputDirectory>${project.build.directory}/classes</outputDirectory>
            </configuration>
        </execution>
        <execution>
            <id>source-merge</id>
            <phase>package</phase>
            <goals>
                <goal>unpack-dependencies</goal>
            </goals>
            <configuration>
                <classifier>sources</classifier>
                <failOnMissingClassifierArtifact>false</failOnMissingClassifierArtifact>
                <includes>**/*.java</includes>
                <includeArtifactIds>data-sync-controller,data-sync-service,data-sync-web
                </includeArtifactIds>
                <outputDirectory>${project.build.directory}/source</outputDirectory>
            </configuration>
        </execution>
    </executions>
</plugin>
```

**注意**：在项目中使用的话，还需要修改`assembly`插件。因为目前在发布的软件包中并不包含`${project.build.directory}/source`和`${project.build.directory}/classes`下的文件。

