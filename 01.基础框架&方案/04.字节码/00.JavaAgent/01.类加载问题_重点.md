# 问题复现

<font color="#f79646">TODO</font>

# 遇到问题

## javassit.NotFoundException

使用java -jar命令执行时报错：

![[Pasted image 20231103143641.png|1200]]

当注释掉划下部分代码时，就会出现上述报错。

<font color="#f79646">原因分析</font>

NotFoundException异常通常是因为Javassist库无法找到或者加载类。

<font color="#f79646">解决办法</font>

打开划下部分代码。

<font color="#f79646">疑惑与参考资料</font>

显然上面的答复难以信服，所以还是基础不牢固，需要思考到底为什么？

查阅可参考的资料

* https://segmentfault.com/q/1010000011264092

## java.lang.ClassNotFoundException

![[Pasted image 20231103143131.png|1200]]

<font color="#f79646">原因分析</font>

![[Pasted image 20231101231839.png|700]]

当使用java -jar命令启动时，包中类加载情况：

```
xxx.jar
├ BOOT-INF
│  ├ classes                        <=== 当前项目的class文件和配置文件，由LaunchedURLClassLoader加载
│  │  └ com
│  │      └ learn
│  │          └ boot
│  │              └ web
│  └ lib                            <=== 当前项目所依赖的jar包，由LaunchedURLClassLoader加载
├ META-INF
│  └ maven
│      └ com.learn
│          └ boot-web
└ org                               <=== 由AppClassLoader加载
    └ springframework
        └ boot
            └ loader
                ├ archive
                ├ data
                ├ jar
                ├ jarmode
                └ util
```

当使用IDEA进行启动时，所有class文件均由AppClassLoader加载，所以不会出现上述问题。

# 解决方案

## 思路一

将agent.jar也加载到LaunchedURLClassLoader呢？

>在`agent1/MyBatisAgent2`中~

![[Pasted image 20231101225802.png|500]]

![[Pasted image 20231101225839.png|750]]

![[Pasted image 20231101231900.png|650]]

再次运行依然报错，在Spring Boot中不行的！<font color="#c00000"><font color="#f79646">并没有解决问题，因为优先会访问父类！</font></font>

<font color="#f79646">但是~</font>

在Tomcat中时可以的，因为Tomcat自定义类加载器<font color="#f79646">打破了双亲委派机制</font>，优先访问自己其次再访问父类。

![[Pasted image 20231101231944.png|650]]

## 思路二

不再直接获取BoundSql对象，而是通过<font color="#f79646">适配器反射</font>获取：

![[Pasted image 20231101232556.png|500]]

![[Pasted image 20231101232719.png|500]]

那为啥<font color="#4bacc6">父类加载的类</font>可以通过<font color="#4bacc6">反射</font>的方式访问<font color="#4bacc6">子类加载的类</font>呢？

直接回避了上述问题？

## 思路三


![[Pasted image 20231101234207.png|1000]]

也就是[[收藏_01_How_To_Write_a_JavaAgent#1.依赖冲突]]问题

## 思路四

[[收藏_01_How_To_Write_a_JavaAgent#2.Class Not Found]]中的解决方案

>但是还没相通怎么回事，无从落地实现~

## 思路五

>可否借鉴JDBC线程上下文类加载器思想去解决呢？TODO~

不行，因为MyBatisAgent类是由AppClassLoader加载的，它的begin方法中需要访问的org.apache.ibatis.mapping.BoundSql是由LaunchedURLClassLoader加载的，AppClassLoader是LaunchedURLClassLoader父类加载器，因此没法访问到org.apache.ibatis.mapping.BoundSql类。

那JDBC的中思路为啥不能适用呢？


## 开源方案调研

TODO

## 方案总结

TODO
