

# 需求说明

采集指定包或类下所有⽅法的执⾏性能，并打印出⽇志。

* **采集范围**：基于<font color="#f79646">通配符匹配</font>采集范围，并通过javaagent参数传递配置信息。
* **实现流程**：
	* 编写参数解析⽅法
	* 编写监控起始⽅法
	* 编写监控结束⽅法
	* 基于Javassit实现插桩

>项目源码参见：https://github.com/6westboy9/learn-center/tree/main/basis-javaagent

# 需求实现


## 前置_通配符匹配


借助JaCoCo的通配符匹配组件[WildcardMatcher](https://github.com/jacoco/jacoco/blob/eea740644aac4395cd755f350e3565a4f59e1e39/org.jacoco.core/src/org/jacoco/core/runtime/WildcardMatcher.java#L23)，通过该组件完成目标路径代码匹配。

## 1.监控组件实现


``` java
public class ServiceCollector implements ClassFileTransformer {  
  
    private WildcardMatcher excludeMatcher = null;  
    private WildcardMatcher includeMatcher = null;  
  
    private static final String VOID_SOURCE_CODE_TEMPLATE = ""  
        + "{\n"  
        + "    %s\n"  
        + "    try {\n"  
        + "        %s$agent($$);\n"  
        + "    } catch (Throwable e) {\n"  
        + "        %s\n"  
        + "        throw e;\n"  
        + "    } finally {\n"  
        + "        %s\n"  
        + "    }\n"  
        + "}\n";  
  
    private static final String SOURCE_CODE_TEMPLATE = ""  
        + "{\n"  
        + "    %s\n"  
        + "    Object result = null;\n"  
        + "    try {\n"  
        + "        result = ($w)%s$agent($$);\n"  
        + "    } catch (Throwable e) {\n"  
        + "        %s\n"  
        + "        throw e;\n"  
        + "    } finally {\n"  
        + "        %s\n"  
        + "    }\n"  
        + "    return ($r)result;\n"  
        + "}\n";  
  
    private static final String beginSrc;  
    private static final String endSrc;  
    private static final String errorSrc;  
  
    static {  
        beginSrc = "com.lachesis.base.javaagent.agent.service.ServiceInfo info = com.lachesis.base.javaagent.agent.service.ServiceCollector.begin(\"%s\",\"%s\");";  
        endSrc = "com.lachesis.base.javaagent.agent.service.ServiceCollector.end(info);";  
        errorSrc = "com.lachesis.base.javaagent.agent.service.ServiceCollector.error(info,e);";  
    }  
  
    public void setExcludeMatcher(WildcardMatcher excludeMatcher) {  
        this.excludeMatcher = excludeMatcher;  
    }  
  
    public void setIncludeMatcher(WildcardMatcher includeMatcher) {  
        this.includeMatcher = includeMatcher;  
    }  
  
    @Override  
    public byte[] transform(ClassLoader loader, String className, Class<?> classBeingRedefined, ProtectionDomain protectionDomain, byte[] classfileBuffer) {  
        if (className == null) {  
            return null;  
        }  
        className = className.replaceAll("/", ".");  
        if (exclude(className)) {  
            return null;  
        }  
        try {  
            ClassPool classPool = new ClassPool();
            classPool.insertClassPath(new LoaderClassPath(loader));  
            CtClass ctClass = classPool.get(className);  
            if (ctClass.isInterface()) {  
                return null;  
            }  
            CtMethod[] methods = ctClass.getDeclaredMethods();  
            for (CtMethod method : methods) {  
                // 屏蔽非公共方法  
                if (!Modifier.isPublic(method.getModifiers())) {  
                    continue;  
                }  
                // 屏蔽静态方法  
                if (Modifier.isStatic(method.getModifiers())) {  
                    continue;  
                }  
                // 屏蔽本地方法  
                if (Modifier.isNative(method.getModifiers())) {  
                    continue;  
                }  
                String beginSrcCode = String.format(beginSrc, className, method.getName());  
                String methodName = method.getName();  
                CtMethod agentMethod = CtNewMethod.copy(method, methodName, ctClass, null);  
                agentMethod.setName(methodName + "$agent");  
                ctClass.addMethod(agentMethod);  
                String template = method.getReturnType().getName().equals("void") ? VOID_SOURCE_CODE_TEMPLATE : SOURCE_CODE_TEMPLATE;  
                String src = String.format(template, beginSrcCode, method.getName(), errorSrc, endSrc);  
                method.setBody(src);  
            }  
            return ctClass.toBytecode();  
        } catch (Exception e) {  
            e.printStackTrace();  
            return null;  
        }  
    }  
  
    private boolean exclude(String className) {  
        if (includeMatcher == null) {  
            return true;  
        } else if (!includeMatcher.matches(className)) {  
            return true;  
        } else {  
            return excludeMatcher != null && excludeMatcher.matches(className);  
        }  
    }  
  
    public static ServiceInfo begin(String className, String methodName) {  
        ServiceInfo serviceInfo = new ServiceInfo();  
        serviceInfo.setBeginTime(System.currentTimeMillis());  
        serviceInfo.setServiceName(className);  
        serviceInfo.setMethodName(methodName);  
        serviceInfo.setSimpleName(className.substring(className.lastIndexOf(".") + 1));  
        return serviceInfo;  
    }  
  
    public static void error(ServiceInfo serviceInfo, Throwable e) {  
        serviceInfo.setErrorType(e.getClass().getSimpleName());  
        serviceInfo.setErrorMsg(e.getMessage());  
        System.out.println(JSONUtil.toJsonStr(serviceInfo));  
    }  
  
    public static void end(ServiceInfo serviceInfo) {  
        serviceInfo.setUseTime(System.currentTimeMillis() - serviceInfo.getBeginTime());  
        System.out.println(JSONUtil.toJsonStr(serviceInfo));  
    }  
}
```

<font color="#f79646">注意：如果修改了JavaAgent，记得重新打包。</font>

==思考：上述代码中classPool.insertClassPath(new LoaderClassPath(loader))行的作用是？其中ClassPool的作用又是？需要补充这里关于ClassPath的知识==

## 2.监控组件注册

```java
public class MyJavaAgent {  
  
    public static Properties config = new Properties();  
  
    public static void premain(String agentOps, Instrumentation instrumentation) {  
        parseOps(agentOps);  
        ServiceCollector serviceCollector = new ServiceCollector();  
        String include = config.getProperty("service.include");  
        if (StrUtil.isNotEmpty(include)) {  
            serviceCollector.setIncludeMatcher(new WildcardMatcher(include));  
        }  
        String exclude = config.getProperty("service.exclude");  
        if (StrUtil.isNotEmpty(exclude)) {  
            serviceCollector.setExcludeMatcher(new WildcardMatcher(exclude));  
        }  
        instrumentation.addTransformer(serviceCollector);  
    }  
  
    private static void parseOps(String agentOps) {  
        if (StrUtil.isNotEmpty(agentOps)) {  
            try {  
                config.load(new ByteArrayInputStream(agentOps.replaceAll(",", "\n").getBytes()));  
            } catch (IOException e) {  
                e.printStackTrace();  
                throw new RuntimeException(e);  
            }  
        }  
    }  
}
```

## 4.实现原理

这里拿UserService中的testReturnVoid方法来解释下底层的工作原理。

![[Pasted image 20231024174949.png|650]]

通过DeBug也可以查看我们生成的源码：

```java
{  
    com.lachesis.base.javaagent.agent.service.ServiceInfo info = com.lachesis.base.javaagent.agent.service.ServiceCollector.begin("org.lachesis.springboot.web.service.UserService","testReturnVoid");  
    try {  
        testReturnVoid$agent($$);  
    } catch (Throwable e) {  
        com.lachesis.base.javaagent.agent.service.ServiceCollector.error(info,e);  
        throw e;  
    } finally {  
        com.lachesis.base.javaagent.agent.service.ServiceCollector.end(info);  
    }  
}
```

带有返回值的另外一个方法：

```java
{
    com.lachesis.base.javaagent.agent.service.ServiceInfo info = com.lachesis.base.javaagent.agent.service.ServiceCollector.begin("org.lachesis.springboot.web.service.UserService","testReturnObj");
    Object result = null;
    try {
        result = ($w)testReturnObj$agent($$);
    } catch (Throwable e) {
        com.lachesis.base.javaagent.agent.service.ServiceCollector.error(info,e);
        throw e;
    } finally {
        com.lachesis.base.javaagent.agent.service.ServiceCollector.end(info);
    }
    return ($r)result;
}
```

同时，也可以借助Arthas进行验证：

![[Pasted image 20231024175516.png|900]]
## 5.测试

使用JVM启动时加载：

```
-javaagent:D:\IdeaProjects\mine\westboy-hub\base-javaagent\target\base-javaagent-1.0-SNAPSHOT-jar-with-dependencies.jar=service.include=org.lachesis.springboot.web.service.*
```

打印日志：

```
{"serviceName":"org.lachesis.springboot.web.service.UserService","simpleName":"UserService","methodName":"testReturnObj","beginTime":1698139791971,"endTime":0,"useTime":2012}
```


# 小结
