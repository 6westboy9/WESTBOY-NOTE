
# jmap

描述：生成堆转储快照文件（也叫dump文件）。

```sh
jmap -dump:format=b,file=heapdump.hprof 16371
jmap -dump:format=b,file=heapdump.hprof 29060
```


> [!caution] 使用技巧和注意事项

1. 注意对运行进程的性能影响：Heap dump时会先进行Full GC，另外为保证对象数据视图一致，需要在安全点Stop The World暂停响应，<font color="#f79646">线上服务进行务必注意性能影响</font>。可以采取以下技巧减少影响：
	- 先禁用入口流量，再执行dump动作。
	- 选择影响较小时dump内存。
	- 使用脚本捕获指定时间的dump内存。
2. 快照文件及建立的索引文件可能较大，如果开发机配置不足无法分析，可在服务器先执行分析后，基于分析后的索引文件直接查看结果，另外也需要注意磁盘占用问题：
	* 大文件分析方法：<font color="#f79646">一般dump文件不高于分析机主存1.2倍可直接在开发机分析</font>；若dump文件过大，可以使用MAT提供的脚本在配置高的高配机器先建立索引再直接展现索引分析结果。<font color="#ffc000">--- 后续补充TODO</font>
		* MAT工具使用见：[[04.使用_内存分析工具]]
	* 如果不关注堆中不可达对象，使用`live`参数可以减小文件大小，命令是`jmap -dump:live,format=b,file=<dumpfile> <pid>`
	* 在dump前主动手动执行一次FULLGC，去除无效对象进一步减少dump堆转储及建立索引的时间。--- <font color="#ffc000">貌似执行jmap的时候会自动执行一次FGC，所以此步骤用意为何呢？</font>
	* 快照文件巨大，建立索引后发现主视图中对象占用内存均较小，这是因为绝大部分对象未被GCRoots引用可释放。
	* 在dump时注意指定到空间较大的磁盘位置，避免打满分区影响服务。
	* 建立快照文件索引机器的磁盘空间需要足够大，一般至少是快照文件的两倍。
 3. 其它
	* JDK版本问题（即JDK版本不匹配问题）：如遇`VMVersionMismatchException`，使用启动目标进程的JDK版本即可。
	* 配置了HeapDumpOnOutOfMemoryError参数，但OutOfMemoryError时但没有自动生成dump文件，可能原因有三个：
		- 应用程序自行创建并抛出OutOfMemoryError；
		- 进程的其他资源（如线程）已用尽；
		- C代码（如JVM源码）中堆耗尽，这种可能由于不同的原因而出现，例如在交换空间不足的情况下，进程限制用尽或仅地址空间的限制，此时dump文件分析并无实质性帮助。