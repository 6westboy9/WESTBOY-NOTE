>Java 8

# Class文件格式


```
ClassFile {
    u4             magic;
    u2             minor_version;
    u2             major_version;
    u2             constant_pool_count;
    cp_info        constant_pool[constant_pool_count-1];
    u2             access_flags;
    u2             this_class;
    u2             super_class;
    u2             interfaces_count;
    u2             interfaces[interfaces_count];
    u2             fields_count;
    field_info     fields[fields_count];
    u2             methods_count;
    method_info    methods[methods_count];
    u2             attributes_count;
    attribute_info attributes[attributes_count];
}
```

![[Pasted image 20231115175043.png|550]]

## 1.魔数与版本

每个Class文件的头4个字节称为魔数，它的唯一作用是确定这个文件是否为一个能被虚拟机接受的Class文件。

紧接着魔数的4个字节存储的是Class文件的版本号：第5和第6个字节是次版本号，第7和第8个字节是主版本号。Java的版本号是从45开始的，JDK 1.1之后的每个JDK大版本发布主版本号向上加1（JDK 1.0～1.1使用了45.0～45.3的版本号），高版本的JDK能向下兼容以前版本的Class文件。

## 2.常量池


紧接着主次版本号之后的是常量池入口，<font color="#f79646">常量池可以理解为Class文件之中的资源仓库</font>，它是Class文件结构中与其他项目关联最多的数据类型，也是占用Class文件空间最大的数据项目之一，同时它还是在Class文件中第一个出现的表类型数据项目。

由于常量池中常量的数量是不固定的，所以在常量池的入口需要放置一项u2类型的数据，代表常量池容量计数值。与Java中语言习惯不一样的是，这个<font color="#f79646">容量计数是从1而不是0开始的</font>。

>在Class文件格式规范制定之时，设计者将第0项常量空出来是有特殊考虑的，这样做的目的在于满足后面某些指向常量池的索引值的数据在特定情况下需要表达“不引用任何一个常量池项目”的含义，这种情况就可以把索引值置为0来表示。

常量池中主要存放两大类常量：<font color="#f79646">字面量</font>和<font color="#f79646">符号引用</font>~

* 字面量（Literal）比较接近于Java语言层面的常量概念，如文本字符串、声明为final的常量值等。
* 符号引用（Symbolic References）则属于编译原理方面的概念，包括了下面三类常量：
	* 类和接口的全限定名（Fully Qualified Name）
	* 字段的名称和描述符（Descriptor）
	* 方法的名称和描述符

## 3.访问标志


## 4.类索引、父类索引与接口索引集合


## 5.字段表集合


## 6.方法表集合


## 7.属性表集合


[Chapter 4. The class File Format (oracle.com)](https://docs.oracle.com/javase/specs/jvms/se8/html/jvms-4.html#jvms-4.7)

属性格式

```
attribute_info {
    u2 attribute_name_index;
    u4 attribute_length;
    u1 info[attribute_length];
}
```



### 1.Code属性


### 2.Exceptions属性


### 3.LineNumberTable属性


### 4.LocalVariableTable属性


### 5.SourceFile属性


### 6.ConstantValue属性


### 7.InnerClasses属性


### 8.Deprecated及Synthetic属性


### 9.StackMapTable属性

在《深入理解Java虚拟机》第二版中的描述：

![[Pasted image 20231120153434.png|500]]

### 10.Signature属性


### 11.BootstrapMethods属性


# 概念扩展


## 全限定名

首先来说全限定名，一个类的全限定名是将类全名的`.`全部替换为`/`，示例如下：

```
me/mingshan/cglib/SampleClass
```

## 简单名称

简单名称是指没有类型和参数修饰的方法或字段名称，比如一个类的test()方法，它的简单名称是test。

## 描述符

>注意描述符的概念是针对Java字节码的。描述符的作用是用来描述字段的数据类型、方法的参数列表（包括数量、类型以及顺序）和返回值。在JVM规范中，定义了两种类型的描述符，字段描述符和方法描述符。

在ClassFile当中，描述符（descriptor）是对类型的简单化描述。

* 对于字段（field）来说，描述符就是对字段本身的类型进行简单化描述。
* 对于方法（method）来说，描述符就是对方法的接收参数的类型和返回值的类型进行简单化描述。

字段描述符包含BaseType、ObjectType、ArrayType三部分。

|            | FieldType term | Type      | Interpretation                                                                    |
| ---------- | -------------- | --------- | --------------------------------------------------------------------------------- |
| <font color="#f79646">BaseType</font>   | Z              | boolean   | true or false                                                                     |
| <font color="#f79646">BaseType</font>   | C              | char      | Unicode character code point in the Basic Multilingual Plane, encoded with UTF-16 |
| <font color="#f79646">BaseType</font>   | F              | float     | single-precision floating-point value                                             |
| <font color="#f79646">BaseType</font>   | D              | double    | double-precision floating-point value                                             |
| <font color="#f79646">BaseType</font>   | B              | byte      | signed byte                                                                       |
| <font color="#f79646">BaseType</font>   | S              | short     | signed short                                                                      |
| <font color="#f79646">BaseType</font>   | I              | int       | integer                                                                           |
| <font color="#f79646">BaseType</font>   | J              | long      | long integer                                                                      |
| <font color="#4bacc6">ObjectType</font> | L ClassName ;  | reference | an instance of class ClassName                                                    |
| <font color="#9bbb59">ArrayType</font>  | \[             | reference | one array dimension                                                               |

### 字段描述符

示例

| 字段                       | 字段描述符             |
| -------------------------- | ---------------------- |
| boolean flag               | Z                      |
| byte byteValue             | B                      |
| int intValue               | I                      |
| float floatValue           | F                      |
| double doubleValue         | D                      |
| String strValue            | Ljava/lang/String;     |
| Object objValue            | Ljava/lang/Object;     |
| byte\[\] bytes             | \[B                    |
| String\[\] array           | \[Ljava/lang/String;   |
| Object\[\]\[\] twoDimArray | \[\[Ljava/lang/Object; |

### 方法描述符

格式

方法描述符用来描述方法，一个方法既有参数，又有返回值，那么在用描述符描述方法时，按照先参数列表，后返回值的顺序描述。参数列表按照参数的严格顺序放在一组小括号。

>注意如果返回值为void，那么就是一个大写字母V表示。


```
({ParameterDescriptor})ReturnDescriptor
```

示例

| 方法                        | 方法描述符              |
| --------------------------- | ----------------------- |
| int add(int a, int b)       | (II)I                   |
| void test(int a, int b)     | (II)V                   |
| boolean compare(Object obj) | (Ljava/lang/Object;)Z   |
| void main(String\[\] args)  | (\[Ljava/lang/String;)V |


