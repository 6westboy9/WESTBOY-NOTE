# 根据进程查看活跃连接数

在Linux上，使用`ss -natp|grep pid=1`可以查看1号进程的TCP连接，如下：

比如若redis数据库端口是6379的话，那么可这样查看redis连接池中连接数量，如下：

```bash
$ ss -natp | grep pid=1 | awk '$5~/:6379$/' | wc -l
20
```

可见当前有20个redis网络连接，那同样的，其中有多少个是活跃的呢？

添加`-i`选项后，ss会输出tcp连接中的一些额外信息，其中lastsnd表示最后一次发送包到当前所经历的毫秒数，lastrcv表示最后一次接收包到当前所经历的毫秒数。


有了这个信息后，就可以通过awk过滤出lastsnd或lastrcv小于1000的tcp连接，这些连接即是1秒内活跃过的连接了，因此我又编写了如下命令脚本。

```bash
$ ss -natpi | sed '1!{N;s/\n//;}' | grep pid=1 | awk -v t=1000 'match($0,/lastsnd:(\w+) lastrcv:(\w+)/,a) && (a[1]<t || a[2]<t) && match($4,/(.+):(\w+)$/,s) && match($5,/(.+):(\w+)$/,d) && s[2]>=32768{print d[2]}' |sort |uniq -c |sort -nk2
      8 80
      3 3306
      7 3307
      6 6379
      1 7916
```


# 查看活跃线程数与连接数

## 1.SpringBoot内嵌Tomcat线程池

获取SpringBoot内置Tomcat线程池的活跃情况：

```bash
# --action getInstances：表示获取对象实例
# --classLoaderClass：指定类加载器
# --className：指定要获取哪个类的实例
# --express：指定ognl表达式，用来从对象上获取信息
[arthas@1249]$ vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className org.apache.tomcat.util.threads.ThreadPoolExecutor  --express 'instances.{ #{"ActiveCount":getActiveCount(),"LargestPoolSize":getLargestPoolSize(),"CorePoolSize":getCorePoolSize(),"MaximumPoolSize":getMaximumPoolSize(),"QueueSize":getQueue().size(),"ThreadName":getThreadFactory().namePrefix }}' -x 2
@ArrayList[
    @LinkedHashMap[
        @String[ActiveCount]:@Integer[18],
        @String[LargestPoolSize]:@Integer[200],
        @String[CorePoolSize]:@Integer[10],
        @String[MaximumPoolSize]:@Integer[200],
        @String[QueueSize]:@Integer[5],
        @String[ThreadName]:@String[http-nio-9099-exec-],
    ],
]

# HtmlToPdfAcceptor
[arthas@1249]$ vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className  com.lachesis.windranger.doc.component.htmltopdf.HtmlToPdfAcceptor --express 'instances[0].pdfAcceptor{ #{"ActiveCount":getActiveCount(),"LargestPoolSize":getLargestPoolSize(),"CorePoolSize":getCorePoolSize(),"MaximumPoolSize":getMaximumPoolSize(),"QueueSize":getQueue().size(),"ThreadName":getThreadFactory().namePrefix }}' -x 3
@ArrayList[
    @LinkedHashMap[
        @String[ActiveCount]:@Integer[18],
        @String[LargestPoolSize]:@Integer[200],
        @String[CorePoolSize]:@Integer[10],
        @String[MaximumPoolSize]:@Integer[200],
        @String[QueueSize]:@Integer[5],
        @String[ThreadName]:@String[http-nio-9099-exec-],
    ],
]
```


## 2.Druid数据库连接池

```bash
# 获取druid连接池的使用情况
[arthas@1]$ vmtool --action getInstances --classLoaderClass org.springframework.boot.loader.LaunchedURLClassLoader --className com.alibaba.druid.pool.DruidDataSource  --express 'instances.{ #{"url":#this.getUrl().split("\\?")[0], "username":#this.getUsername(),"PoolingCount":#this.getPoolingCount(),"ActiveCount":#this.getActiveCount(),"MaxActive":#this.getMaxActive(),"WaitThreadCount":#this.getWaitThreadCount(),"MaxWaitThreadCount":#this.getMaxWaitThreadCount()} }' -x 2
```