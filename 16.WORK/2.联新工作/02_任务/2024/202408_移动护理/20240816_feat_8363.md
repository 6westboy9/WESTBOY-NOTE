# 1.CR

>Java群

项目：mnis  
内容：8363【规划】生命体征录入后，自动同步到护记录单
分支：feat_release_mnis_v3.8_wpb_8363_01 into qa_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/5659

* qa_mnis_v3.8_wpb_8363_02


项目：mnis  
内容：8363规划需求问题修复.CA签名后明细变更未发送文书信息至CA厂商
分支：fix_release_mnis_v3.8_wpb_240912 into qa_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/5750
# 2.脚本

>邮件

> [!danger] 注意事项
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况
> 1.开关，默认应为关闭（根据实际情况而定）
> 2.IP地址，默认应为127.0.0.1（一般情况）

---

宝哥麻烦归档下脚本：

测试环境：10.2.3.170
项目：mnis
服务：mnis
冲刺版本：移动护理迭代50
故事编号：8363
版本号：MNIS V3.8.111
分支：feat_release_mnis_v3.8_wpb_8363_01



MySQL脚本

```sql
USE `windranger_mnis`;
-- 删除之前废弃表
DROP TABLE IF EXISTS `doc_data_nurse_record_detail_source`;
-- 重新创建表
CREATE TABLE `doc_data_nurse_record_detail_source` (  
  `seq_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '自增长流水号',  
  `detail_seq_id` bigint(20) unsigned NOT NULL COMMENT '自增长流水号',  
  `source_code` int(10) NOT NULL DEFAULT '0' COMMENT '10.患者体征',  
  `source_link_value` varchar(50) NOT NULL COMMENT '数据来源关联值',  
  `create_person` varchar(50) NOT NULL COMMENT '创建人',  
  `create_time` datetime NOT NULL COMMENT '创建时间',  
  `update_person` varchar(50) DEFAULT NULL COMMENT '修改人',  
  `update_time` datetime DEFAULT NULL COMMENT '修改时间',  
  PRIMARY KEY (`seq_id`),  
  UNIQUE KEY `uq_detail_seq_id` (`detail_seq_id`)  
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='护理记录明细来源';

CREATE TABLE `doc_data_nurse_record_source` (
  `seq_id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT '自增长流水号',
  `record_seq_id` bigint(20) unsigned NOT NULL COMMENT '记录自增长流水号',
  `source_code` int(10) NOT NULL DEFAULT '0' COMMENT '10.患者体征',
  `source_link_value` varchar(50) NOT NULL COMMENT '数据来源关联值',
  `create_person` varchar(50) NOT NULL COMMENT '创建人',
  `create_time` datetime NOT NULL COMMENT '创建时间',
  `update_person` varchar(50) DEFAULT NULL COMMENT '修改人',
  `update_time` datetime DEFAULT NULL COMMENT '修改时间',
  PRIMARY KEY (`seq_id`),
  UNIQUE KEY `uq_record_seq_id` (`record_seq_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='护理记录来源';
```

> [!danger] 注意事项
> 脚本后不要带 `;` ~

MongDB脚本

```js
use coms
db.sysConfigFile.updateMany({ 'key': 'skinTestOfTemperatureFormConfig' }, { "$pull": { 'children': { 'key': { $in: ['isAutoSyncToNurseRecord','autoSyncToNurseRecordTemplateCodes'] } } } })
db.sysConfigFile.updateMany({ 'key': 'skinTestOfTemperatureFormConfig' }, {
    "$push": {
        "children":
        {
            $each: [{
                "_id": "65095edbcf1fe2309d010608-Mon Aug 19 2024 09:55:15 GMT+0800",
                "key": "isAutoSyncToNurseRecord",
                "pattern": {
                    "componentType": "Switch",
                    "label": "体温单体征是否自动同步到护记单"
                },
                "value": false
            },
            {
                "_id": "17248372404531",
                "key": "autoSyncToNurseRecordTemplateCodes",
                "pattern": {
                    "description": "多个英文逗号分隔",
                    "componentType": "Input",
                    "label": "体温单体征自动同步护记单模板编号"
                },
                "value": ""
            }]
        }
    }
})
```

# 3.提测单

>提测群

http://183.62.162.28:1024/zentao/testtask-view-8201.html
8363【规划】生命体征录入后，自动同步到护记录单 --- 已提测

# 4.其它


## 1.配置

主要新增了两个配置

* 体温单体征是否自动同步到护记单
* 体温单体征自动同步护记单模板编号（增加该配置出于两方面考虑）
	* 方便测试
	* 性能考虑，公司内部测试环境护记单很多，越多性能同步性能越差

![[Pasted image 20240829141540.png|1100]]

## 2.同步来源

* PC端来源2个
	* 文书管理 - 患者体温单查询 - 保存（<font color="#c0504d">单个患者维度</font>）
		* 后端接口：POST http://10.2.3.172:86/api/windranger/patientVitalSign
	* 体征管理 - 体征批量录入 - 保存（<font color="#c0504d">多个患者维度</font>）
		* 后端接口：POST http://10.2.3.172:86/api/windranger/batchPatientVitalSign
* PDA端来源1个（同体征批量录入接口）
## 3.体征时间转换

* 当天24点需转换成第二天0点
## 4.护记单过滤

* 已经归档的文书排除
* 已经打印的表头排除（注意这里是<font color="#c0504d">表头</font>过滤，除非所有的表头都打印了，那么改护记单文书整体将会被过滤）
* 支持配置护记单文书模板（见配置部分）

## 5.找表头

* 单个表头
	* 没得选
* 多个表头（3个表头，就有2的3次方=8种情况）
	1. 表1有记录 & 表2有记录 & 表3有记录
	2. 表1有记录 & 表2有记录 & <font color="#8064a2">表3没记录</font>
	3. 表1有记录 & <font color="#8064a2">表2没记录</font> & 表3有记录
	4. 表1有记录 & <font color="#8064a2">表2没记录</font> & <font color="#8064a2">表3没记录</font>
	5. <font color="#8064a2">表1没记录</font> & 表2有记录 & 表3有记录
	6. <font color="#8064a2">表1没记录</font> & 表2有记录 & <font color="#8064a2">表3没记录</font>
	7. <font color="#8064a2">表1没记录</font> & <font color="#8064a2">表2没记录</font> & 表3有记录
	8. <font color="#8064a2">表1没记录</font> & <font color="#8064a2">表2没记录</font> & <font color="#8064a2">表3没记录</font>

归纳：

* 表头按创建时间排序
* 规则1：所有表头均无记录，取最一个表头
* 根据体征记录时间recordDate查找表头范围（<font color="#f79646">前闭后开原则</font>）
	* 规则2：范围内的<font color="#c0504d">有记录</font>表头可以找到，取该表头
	* 没找到：
		* 规则3：无前驱<font color="#c0504d">有记录</font>表头，有后继<font color="#c0504d">有记录</font>表头：<font color="#9bbb59">取后继有记录表头前的第一个表头（默认取后继有记录表头，依次往前找）</font>
		* 规则4：有前驱<font color="#c0504d">有记录</font>表头，有后继<font color="#c0504d">有记录</font>表头：<font color="#9bbb59">取前驱有记录表头后的第一个表头（默认取前驱有记录表头，依次往后找）</font>
		* 规则5：有前驱<font color="#c0504d">有记录</font>表头，无后继<font color="#c0504d">有记录</font>表头：<font color="#9bbb59">取前驱有记录表头后的第一个表头（默认取前驱有记录表头，依次往后找）</font>

![[16.WORK/2.联新工作/02_任务/2024/202408_移动护理/附件/企业微信截图_17248233757650.png|1600]]

> [!danger] 共计8×7=56个用例场景
## 6.同步护记单记录

行操作定义

* 删除行：查询来源于体征同步的记录，所有体征项清空时
* 新增行：查询来源于体征同步的记录，不存在（护记单页面护士更新过之后会清空来源）
* 更新行：查询来源于体征同步的记录，存在，包括6种情况
	* 新增列（存在记录列没有）
	* 删除列（存在记录列有）
	* 更新列（存在记录列有）
	* 新增列 + 删除列
	* 新增列 + 更新列
	* 更新列 + 删除列
	* 新增列 + 更新列 + 删除列

行操作也包括种6情况

* 新增行（列操作包括1种=1）
* 更新行（列操作包括6种=6）
* 删除行（列操作包括1种=1）
* 新增行 + 更新行（1×6=6）
* 新增行 + 删除行（1×1=1）
* 更新行 + 删除行（6×1=6）
* 新增行 + 更新行 + 删除行（1×6×1=6）

>[!danger] 共计1+6+1+6+1+6+6=31个用例场景


|     |     | 昨天                                                  | 今天                                          | 风险                                                                     |
| --- | --- | --------------------------------------------------- | ------------------------------------------- | ---------------------------------------------------------------------- |
| 1   | 侯长源 | 8729、8728联调提测，8740血糖单调整开发                           | 8740血糖单开发、8741需求开发                          | 确信CA有一定风险，现在环境还没弄好                                                     |
| 1   | 王鹏博 | 8363.生命体征录入后，自动同步到护记录单开发+自测+提测                      | 【河南科技大学第一附属医院（开元院区）】8726:PC端-护理文书增加更新表头按钮功能 | 8363耽搁本迭代一天时间                                                          |
| 1   | 沈鹏  |                                                     |                                             |                                                                        |
| 1   | 王冰  | 8731、8719、8618，昨天验证了这三个需求，8731需求沈鹏还要修改，后面还需继续验证     | 今天优先验证体征自动同步                                |                                                                        |
| 1   | 莫丽梅 | 【梧州市工人医院】-体温单同一个时间点显示两个两个体温和脉搏<br>护理记录单的自动化测试完成度40% | 【昆山市第一人民医院】-执行单回退功能增加时间限制，超过10分钟不允许回退       |                                                                        |
| 1   | 汪洋  | 解决血糖单字体自适应无效的线上bug<br>自测+提测部分需求                     | 关联数据更新以及血糖异常范围两个任务等后端设计，前端已经做了一大部分          | 关联数据更新以及血糖异常范围两个任务预计延期到下周一完成<br><font color="#c0504d">王鹏博这边延误导致</font> |
|     | 周胜国 | 处理线上问题，梧州单点登录<br>安装手写板插件报错阻塞                        | 继续处理手写板软件安装问题                               | 由于处理线上问题占用比较多时间，手写板开发延后                                                |
| 2   | 莫雷雷 | 手术室要只显示各自院区的手术患者联调提测                                | 手术闭环后续迭代功能开发                                |                                                                        |
| 2   | 刘业荣 | 开发并提测手术闭环的 8649【益阳市中心医院】两院区两手术室要只显示各自院区的手术患者        | 处理手术闭环迭代测试问题                                |                                                                        |
