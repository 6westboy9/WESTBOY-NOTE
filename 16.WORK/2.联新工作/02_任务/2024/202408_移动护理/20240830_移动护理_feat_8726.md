# 1.CR

>Java群

项目：mnis  
内容：8726:PC端【河南科技大学第一附属医院（开元院区）】护理文书增加更新表头按钮功能
分支：feat_qa_mnis_v3.8_wpb_8726 into qa_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/5709

修复分支
* fix_qa_mnis_v3.8_wpb_8726_01

# 2.脚本

>邮件

> [!danger] 注意事项
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况
> 1.开关，默认应为关闭（根据实际情况而定）
> 2.IP地址，默认应为127.0.0.1（一般情况）

---

宝哥麻烦归档下脚本：

测试环境：10.2.3.170
项目：mnis
服务：mnis
冲刺版本：移动护理迭代51
故事编号：8726
版本号：MNIS V3.8.113
分支：feat_qa_mnis_v3.8_wpb_8726

MySQL脚本

```sql
use windranger_mnis;
create index idx_item_code on doc_template_item (item_code);

drop index idx_template_code on doc_template_item;  
create index idx_template_code_item_code on doc_template_item (template_code, item_code);

create index idx_template_code on doc_data_nurse_header (template_code);
create index idx_template_code on doc_data_evaluate_header (template_code);
create index idx_template_code on doc_data_ordinary (template_code);
```

> [!danger] 注意事项
> 脚本后不要带 `;` ~

MongDB脚本

```js

```

# 3.提测单

>提测群


8726:PC端【河南科技大学第一附属医院（开元院区）】护理文书增加更新表头按钮功能 --- 已提测

# 4.其它

>1.配置为历史数据全部更新，<font color="#f79646">触发时机？</font>患者的医嘱、体征和手术发生变更后？

比如护记单的体征自动同步？这不就与这个类似？

![[Pasted image 20240901180454.png|400]]

![[Pasted image 20240901182735.png|800]]

* 体征
	* InhosCode
		* TemplateCode
			* DocumentCode
				* HeaderCode
					* ItemCode
* 患者
* 医嘱


>2.还有一点，怎么防止循环问题？需要调研

![[Pasted image 20240901182520.png]]

>3.细节注意点

* 更新数据时，需要校验文书状态，比如：已归档，已打印的是否支持更新呢？应该是需要的
	* <font color="#f79646">操作的数据面向所有项目</font>
		* header
		* body
* 保证最终链路统一路径（搜索关键词@LachesisEntryLog）
	* 普通文书：
		* 保存：com.lachesis.windranger.doc.service.impl.DocDataOrdinaryRecordService#saveOrdinaryRecord
		* 删除：com.lachesis.windranger.doc.service.impl.DocDataOrdinaryRecordService#deleteOrdinaryRecordByDocument
	* 护理评估：
		* 保存/更新：com.lachesis.windranger.doc.service.impl.DocDataEvaluateRecordService#saveEvaluateRecord
		* 删除：
	* 护理记录：
		* 保存：com.lachesis.windranger.doc.service.IDocDataNurseRecordService#saveDocNurseRecord
		* 批量保存/更新：com.lachesis.windranger.doc.service.impl.DocDataNurseRecordService#batchSaveDocNurseRecord
		* 更新：com.lachesis.windranger.doc.service.impl.DocDataNurseRecordService#updateDocNurseRecord
		* 删除
		* 如果护记单配置了体温项数据源，护记单配置所有时间点体温均取最新值？比如
			* 01:00 = 36
			* 02:00 = 37
		* 护记单有四条均取最新数据
			* 00:00 = 37
			* 01:00 = 37
			* 02:00 = 37
			* 03:00 = 37

之前护记单的数据源更新逻辑有以下三种情况

* diagnosisDesc、surgeryWay、surgeryName值为空时，才更新
* bedCode值不相等时，才更新
* weight、height没有更新时间，或者更新时间≤创建时间，且为空时，才更新

非以上数据源，且更新时间不为空，更新时间大于创建时间 不更新

对于历史数据更新仍然维持这个判断逻辑？

![[Pasted image 20240901174645.png|1000]]

>护记单

```sql
# 护记单
select * from doc_template_item where template_code = 'T001402' and source_table is not null order by item_type;

select * from doc_data_nurse_header ddeh
left join doc_template_item dti on ddeh.template_code = dti.template_code
left join doc_data_nurse_header_detail ddehd on ddeh.inhos_code = ddehd.inhos_code and ddeh.header_code = ddehd.header_code and ddehd.item_code = dti.item_code
 where ddeh.inhos_code = '43017851' and ddeh.template_code = 'T001402' and dti.source_table = 'vitalSign';

select * from doc_data_nurse_record ddeh
left join doc_data_nurse_record_detail ddehd on ddeh.inhos_code = ddehd.inhos_code and ddeh.record_code = ddehd.record_code
where ddeh.inhos_code = '43017851' and ddeh.template_code = 'T001402';
```

* updateHeaderSource
* updateBodySource

|                | 页头  | 表体  |
| -------------- | --- | --- |
| 新建时取旧值         | ✓   | ✓   |
| 新建时取最新值，历史数据不变 | ✓   | ✓   |
| 所有数据实时变更为最新    | ✓   | ✓   |

>评估单 ing

|                | 页头  | 表体  |
| -------------- | --- | --- |
| 新建时取旧值         | ✓   | ✓   |
| 新建时取最新值，历史数据不变 | ✓   | ✓   |
| 所有数据实时变更为最新    | ✓   | ✓   |

>普通文书

|                | 页头  | 表体  |
| -------------- | --- | --- |
| 新建时取旧值         | ✓   | ✓   |
| 新建时取最新值，历史数据不变 | ✓   | ✓   |
| 所有数据实时变更为最新    | ✓   | ✓   |

发送体征消息关键词：发送体征变更事件