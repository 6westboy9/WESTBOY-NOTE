# 1.CR  
  
>Java群  

项目：mnis  
内容：37808【梧州市工人医院】-部分患者无法自动生成入院日程
分支：fix_release_mnis_v3.8_wpb_37808 into qa_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/7683

* 37808【梧州市工人医院】-部分患者无法自动生成入院日程
	* 复现：一次性转抄2000条患者事件（可以更多些）
	* 解决：转抄过来的体征数据，分批处理
	* 测试：转抄事件核心功能回归

# 2.脚本  
  
>邮件  
  
> [!danger] 注意事项  
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况  
> 1.开关，默认应为关闭（根据实际情况而定）  
> 2.IP地址，默认应为127.0.0.1（一般情况）  
  
---  
  
宝哥麻烦归档下脚本：  
  
测试环境：10.2.3.170  
项目：mnis
单号：37808  
版本号：MNIS V3.8.157
分支：fix_release_mnis_v3.8_wpb_37808
  
MySQL脚本  
  
```sql

```  
  
  
> [!danger] 注意事项  
> 脚本后不要带 `;` ~  
  
MongDB脚本  
  
```js  
use mnis

var collectionName = "patEventRecordReq";
var indexes = [
    {
        name: "idx_inhosCode",
        key: { "inhosCode": 1 }
    },
    {
        name: "idx_createTime",
        key: { "createTime": 1 },
        expireAfterSeconds: 604800 // 7天
    }
];

function createIndexIfNotExists(collection, indexConfig) {
    try {
        var existingIndexes = collection.getIndexes();
        var indexExists = false;

        // 检查索引是否已存在
        for (var i = 0; i < existingIndexes.length; i++) {
            if (existingIndexes[i].name === indexConfig.name) {
                indexExists = true;
                break;
            }
        }

        if (!indexExists) {
            // 创建索引选项
            var options = { name: indexConfig.name };
            if (indexConfig.expireAfterSeconds) {
                options.expireAfterSeconds = indexConfig.expireAfterSeconds;
            }

            // 创建索引
            collection.createIndex(indexConfig.key, options);

            if (indexConfig.expireAfterSeconds) {
                var days = Math.round(indexConfig.expireAfterSeconds / 86400);
                print("✓ 创建TTL索引 " + indexConfig.name + " (" + days + "天自动删除)");
            } else {
                print("✓ 创建索引 " + indexConfig.name);
            }
        } else {
            print("✓ 索引 " + indexConfig.name + " 已存在");
        }

        return true;
    } catch (error) {
        print("✗ 创建索引 " + indexConfig.name + " 失败: " + error.message);
        return false;
    }
}

function main() {
    print("开始为 " + collectionName + " 集合创建索引...");

    try {
        var collection = db.getCollection(collectionName);
        var successCount = 0;

        // 逐个创建索引
        for (var i = 0; i < indexes.length; i++) {
            if (createIndexIfNotExists(collection, indexes[i])) {
                successCount++;
            }
        }

        print("✓ 索引创建完成 (" + successCount + "/" + indexes.length + ")");

    } catch (error) {
        print("✗ 脚本执行失败: " + error.message);
    }
}

// 执行主函数
main();
```  
  
# 3.提测单  
  
>提测群  

fix：37808【梧州市工人医院】-部分患者无法自动生成入院日程
http://183.62.162.28:1024/zentao/testtask-view-10351.html#app=execution
  
# 4.其它