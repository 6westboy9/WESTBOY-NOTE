# 1.CR  
  
>Java群  

项目：mnis  
内容：10769【江门市中心医院】-病房巡视页面：pda巡视后，其他护士可以修改患者的巡视记录，不合理优化
分支：feat_release_mnis_v3.8_wpb_10769 into qa_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/7523

# 2.脚本  
  
>邮件  
  
> [!danger] 注意事项  
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况  
> 1.开关，默认应为关闭（根据实际情况而定）  
> 2.IP地址，默认应为127.0.0.1（一般情况）  
  
---  
  
宝哥麻烦归档下脚本：  
  
测试环境：10.2.3.170  
项目：mnis
单号：10769  
版本号：MNIS V3.8.153
分支：feat_release_mnis_v3.8_wpb_10769
  
MySQL脚本  
  
```sql

```  
  
  
> [!danger] 注意事项  
> 脚本后不要带 `;` ~  
  
MongDB脚本  
  
```js  
use coms

var config = db.sysConfigFile.findOne({ 'key': 'patrolConfig' });

print("=== 开始执行备份操作")

// 检查是否找到配置数据
if (config) {
    // 备份配置数据到sysConfigFilePatrolConfigBackup集合
    db.sysConfigFilePatrolConfigBackup.drop()
    db.sysConfigFilePatrolConfigBackup.insert(config);
    print('备份成功！配置数据已保存到sysConfigFilePatrolConfigBackup集合');
    print('备份数据的_id:', config._id);
} else {
    print('错误：未找到key为\'patrolConfig\'的配置数据');
}

print("=== 开始执行更新操作")

// 检查是否找到配置数据
if (config) {
    // 初始化v1为默认值true
    var v1 = true;
    
    // 遍历children数组，查找key为'patrolSupportsAddEdit'的元素
    if (config.children && Array.isArray(config.children)) {
        for (var i = 0; i < config.children.length; i++) {
            var child = config.children[i];
            if (child.key === 'patrolSupportsAddEdit') {
                // 获取v1的值，如果child.value为null或undefined，默认值为false
                v1 = child.value !== null && child.value !== undefined ? child.value : false;
                // 删除旧的元素
                config.children.splice(i, 1);
                break;
            }
        }
    }
    
    // 生成新的patrolSupportsAddEdit对象
    var newPatrolSupportsAddEditObj = {
        "_id": "17612055874371",
        "key": "patrolSupportsAddEdit",
        "pattern": {
            "componentType": "Map",
            "label": "巡视是否支持新增编辑",
            "urlOptionSourceDetail": {},
            "optionSourceDetail": "",
            "optionSource": "options",
            "options": [
                {
                    "sortedIndex": 1,
                    "code": "pc",
                    "name": "PC端"
                },
                {
                    "sortedIndex": 2,
                    "code": "pda",
                    "name": "PDA端"
                }
            ],
            "optionKeyAttrs": [
                {
                    "horizontalLayout": true,
                    "componentType": "Checkbox"
                }
            ]
        },
        "value": {
            "pc": v1,
            "pda": true
        }
    };
    
    // 确保children数组存在
    if (!config.children) {
        config.children = [];
    }
    
    // 添加新对象到children数组
    config.children.push(newPatrolSupportsAddEditObj);
    
    // 更新数据库中的配置
    var result = db.sysConfigFile.update(
        { 'key': 'patrolConfig' },
        { $set: config }
    );
    
    if (result.nModified > 0) {
        print('更新成功！已将patrolSupportsAddEdit配置更新为新格式');
        print('PC端值(pc):', v1);
        print('PDA端值(pda):', true);
    } else {
        print('警告：更新操作未修改任何文档');
    }
} else {
    print('错误：未找到key为\'patrolConfig\'的配置数据');
}
```  
  
# 3.提测单  
  
>提测群  

http://183.62.162.28:1024/zentao/testtask-view-10172.html#app=execution
10769【江门市中心医院】-病房巡视页面：pda巡视后，其他护士可以修改患者的巡视记录，不合理优化

注意：此需求需要额外注意验证的是配置的变化：

PC 的开启需要验证线上配置开启和关闭两种情况：

* 开启：PC 端开启
* 关闭：PC 端关闭

归档脚本是正向流程，如果需要还原之前线上的配置使用以下脚本：

```js
use coms

// 从备份集合中查找key为'patrolConfig'的配置数据
var config = db.sysConfigFilePatrolConfigBackup.findOne({ 'key': 'patrolConfig' });

// 检查是否找到备份数据
if (config) {
    // 恢复备份数据到sysConfigFile集合
    var result = db.sysConfigFile.update(
        { 'key': 'patrolConfig' },
        { $set: config }
    );
    
    if (result.nModified > 0) {
        print('回滚成功！已从备份恢复配置数据');
        print('恢复数据的_id:', config._id);
    } else {
        // 如果update没有修改任何文档，尝试插入
        if (result.nUpserted === 0) {
            // 先删除可能存在的文档
            db.sysConfigFile.remove({ 'key': 'patrolConfig' });
            // 然后插入备份数据
            var insertResult = db.sysConfigFile.insert(config);
            print('回滚成功！已重新插入配置数据');
            print('恢复数据的_id:', config._id);
        }
    }
} else {
    print('错误：未找到备份数据，请确保已运行备份脚本');
}
```

> 需要注意顺序：先执行归档脚本，再执行回滚脚本
  
# 4.其它