# 测试

## 数据准备与恢复

```sql
-- 原始遗嘱
SELECT * FROM windranger_emr.pat_inhos_order WHERE order_group_no IN (SELECT order_group_no FROM windranger_emr.pat_inhos_order_group WHERE orderbar IN ('zpsy@122954512205090800833622136'));
-- 拆分医嘱批次
SELECT * FROM windranger_emr.pat_inhos_order_group WHERE orderbar IN ('zpsy@122954512205090800833622136');

-- 回滚
DELETE FROM windranger_mnis.`pat_inhos_order_process` WHERE order_bar IN ('zpsy@122954512205090800833622136');
UPDATE windranger_emr.`pat_inhos_order_group` SET execute_status = 0, execute_person = NULL, execute_date = NULL, reason=NULL, execute_type = 0 WHERE orderbar IN  ('zpsy@122954512205090800833622136');
DELETE FROM windranger_mnis.`mnis_infu_monitor` WHERE orderbar IN  ('zpsy@122954512205090800833622136');
```

>原始医嘱

```sql
SELECT order_code,inhos_code,pat_code,order_group_no,order_sub_no,repeat_indicator,administration_code,order_text, order_status
FROM windranger_emr.pat_inhos_order WHERE order_group_no IN (SELECT order_group_no FROM windranger_emr.pat_inhos_order_group WHERE orderbar IN ('zpsy@122954512205090800833622136'));
```

| order\_code | inhos\_code | pat\_code | order\_group\_no | order\_sub\_no | repeat\_indicator | administration\_code | order\_text                     | order\_status |
| :---------- | :---------- | :-------- | :--------------- | :------------- | :---------------- | :------------------- | :------------------------------ | :------------ |
| 1012784073  | 12295451    | 1133443   | 833622136        | 1012784073     | 1                 | 3                    | 0.9%氯化钠注射液\(直软）100ml:0.9g/瓶-输液  | 2             |
| 1012784075  | 12295451    | 1133443   | 833622136        | 1012784075     | 1                 | 3                    | 注射用丁二磺酸腺苷蛋氨酸0.5g/瓶-皮试71         | 2             |
| 2112784073  | 12295451    | 1133443   | 833622136        | 1012784073     | 1                 | 7                    | 0.9%氯化钠注射液\(直软）50ml:0.9g/瓶-注射   | 2             |
| 9112784073  | 12295451    | 1133443   | 833622136        | 1012784073     | 1                 | 28                   | 0.9%氯化钠注射液\(直软）50ml:0.9g/瓶-鼻饲口服 | 2             |
| 9212784073  | 12295451    | 1133443   | 833622136        | 1012784073     | 1                 | 18                   | 0.9%氯化钠注射液\(直软）50ml:0.9g/瓶-雾化   | 2             |
| 9312784073  | 12295451    | 1133443   | 833622136        | 1012784073     | 1                 | 4                    | 0.9%氯化钠注射液\(直软）50ml:0.9g/瓶-外用治疗 | 2             |
| 1915626738  | 12295451    | 1090551   | 833622136        | 1915626738     | 1                 | A3                   | 5%葡萄糖注射液（双阀）100ml：5g/瓶-肌注       | 2             |

>拆分医嘱批次

```sql
SELECT group_unique_code,order_group_no,inhos_code,orderbar,plan_time,isprint,execute_status,is_dispensed
FROM windranger_emr.pat_inhos_order_group WHERE orderbar IN ('zpsy@122954512205090800833622136');
```

| group\_unique\_code | order\_group\_no | inhos\_code | orderbar | plan\_time | isprint | execute\_status | is\_dispensed |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 122954512205090800833622136 | 833622136 | 12295451 | zpsy@122954512205090800833622136 | 2024-06-18 08:00:00 | 1 | 0 | 0 |
| 922954512205090800833622136 | 833622136 | 12295451 | zpsy@122954512209251200833626651 | 2024-06-18 23:59:59 | 1 | 0 | 0 |
| 942954512205090800833622136 | 833622136 | 12295451 | zpsy@932954512209251200833626651 | 2024-06-18 08:03:00 | 1 | 0 | 0 |

## 操作过程


## 输液列表

![[Pasted image 20250212142244.png|300]]


```js
curl 'http://10.2.3.170:86/windranger/mnis/infusionsInfo/nda?wardCode=309&isStar=0' \
  -H 'Authorization: eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc01vYmxlIjoxLCJhcHBJZCI6Ik1OSVMiLCJpcEFkZHJlc3MiOiIxMC4yLjMuMTcwIiwiZXhwaXJlU2Vjb25kcyI6NzIwMCwidXNlckNvZGUiOiIxMjMifQ.cFXi3wShGuWHKAv1s0eRslvrrw6s0Ou1QNlyiFNDZF4' \
  -H 'CurrentWardCode: 309' \
  -H 'platform: pda' \
  -H 'mac: 00:DB:DE:E6:45:BF' \
  -H 'Connection: Keep-Alive' \
  -H 'User-Agent: okhttp/4.2.2' \
  --compressed
```

>[!danger] 果流程节点上没有开启输液巡视，此处的列表不会有对应的信息

### 扫码 <font color="#9bbb59">扫描医嘱条码</font>

> [!info]- 请求结果
> ```json
> {
>     "orderDetails": [
>       {
>         "items": [
>           {
>             "dosage": 100,
>             "dosageUnits": "ml",
>             "orderText": "0.9%氯化钠注射液(直软）100ml:0.9g/瓶-输液",
>             "itemCode": "123031",
>             "itemSpecification": "100ml:0.9g",
>             "isSpecialDrug": false,
>             "frequencyCode": "QD",
>             "frequency": "qd",
>             "administrationCode": "3",
>             "administration": "静滴",
>             "executeStatus": 0,
>             "orderStatus": null,
>             "execTypeCode": null,
>             "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>             "specialSymbolPrefix": null,
>             "symbolPrefixColor": null
>           },
>           {
>             "dosage": 100,
>             "dosageUnits": "g",
>             "orderText": "（GPO）注射用丁二磺酸腺苷蛋氨酸0.5g/瓶-皮试71",
>             "itemCode": "4528",
>             "itemSpecification": "100ml：5g",
>             "isSpecialDrug": false,
>             "frequencyCode": "QD",
>             "frequency": "qd",
>             "administrationCode": "3",
>             "administration": "静滴",
>             "executeStatus": 0,
>             "orderStatus": null,
>             "execTypeCode": null,
>             "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>             "specialSymbolPrefix": null,
>             "symbolPrefixColor": null
>           },
>           {
>             "dosage": 50,
>             "dosageUnits": "ml",
>             "orderText": "0.9%氯化钠注射液(直软）50ml:0.9g/瓶-注射",
>             "itemCode": "123041",
>             "itemSpecification": "50ml:0.9g",
>             "isSpecialDrug": false,
>             "frequencyCode": "QD",
>             "frequency": "qd",
>             "administrationCode": "7",
>             "administration": "注射",
>             "executeStatus": 0,
>             "orderStatus": null,
>             "execTypeCode": null,
>             "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>             "specialSymbolPrefix": null,
>             "symbolPrefixColor": null
>           },
>           {
>             "dosage": 50,
>             "dosageUnits": "ml",
>             "orderText": "0.9%氯化钠注射液(直软）50ml:0.9g/瓶-鼻饲口服",
>             "itemCode": "123051",
>             "itemSpecification": "50ml:0.9g",
>             "isSpecialDrug": false,
>             "frequencyCode": "QD",
>             "frequency": "qd",
>             "administrationCode": "28",
>             "administration": "鼻饲口服",
>             "executeStatus": 0,
>             "orderStatus": null,
>             "execTypeCode": null,
>             "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>             "specialSymbolPrefix": null,
>             "symbolPrefixColor": null
>           },
>           {
>             "dosage": 50,
>             "dosageUnits": "ml",
>             "orderText": "0.9%氯化钠注射液(直软）50ml:0.9g/瓶-雾化",
>             "itemCode": "123061",
>             "itemSpecification": "50ml:0.9g",
>             "isSpecialDrug": false,
>             "frequencyCode": "QD",
>             "frequency": "qd",
>             "administrationCode": "18",
>             "administration": "雾化",
>             "executeStatus": 0,
>             "orderStatus": null,
>             "execTypeCode": null,
>             "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>             "specialSymbolPrefix": null,
>             "symbolPrefixColor": null
>           },
>           {
>             "dosage": 50,
>             "dosageUnits": "ml",
>             "orderText": "0.9%氯化钠注射液(直软）50ml:0.9g/瓶-外用治疗",
>             "itemCode": "123071",
>             "itemSpecification": "50ml:0.9g",
>             "isSpecialDrug": false,
>             "frequencyCode": "QD",
>             "frequency": "qd",
>             "administrationCode": "4",
>             "administration": "外用治疗",
>             "executeStatus": 0,
>             "orderStatus": null,
>             "execTypeCode": null,
>             "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>             "specialSymbolPrefix": null,
>             "symbolPrefixColor": null
>           },
>           {
>             "dosage": 100,
>             "dosageUnits": "ml",
>             "orderText": "5%葡萄糖注射液（双阀）100ml：5g/瓶-肌注",
>             "itemCode": "407641",
>             "itemSpecification": "100ml：5g",
>             "isSpecialDrug": false,
>             "frequencyCode": "QD",
>             "frequency": "qd",
>             "administrationCode": "A3",
>             "administration": "肌注",
>             "executeStatus": 0,
>             "orderStatus": null,
>             "execTypeCode": null,
>             "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>             "specialSymbolPrefix": null,
>             "symbolPrefixColor": null
>           }
>         ],
>         "executeRecords": null,
>         "processType": null,
>         "currentProcessNode": null,
>         "currentProcessNodeName": null,
>         "newOrderStatus": false,
>         "orderGroupNo": "833622136",
>         "orderbar": "zpsy@122954512205090800833622136",
>         "inhosCode": "12295451",
>         "planTime": "2024-06-18T08:00:00.000+0800",
>         "startDateTime": "2024-06-12T01:15:55.000+0800",
>         "stopDateTime": null,
>         "administration": "静滴",
>         "administrationCode": "3",
>         "repeatIndicator": 1,
>         "isDispensed": 0,
>         "isEmergent": null,
>         "isContinue": null,
>         "executeStatus": 0,
>         "orderStatus": null,
>         "infusionStatus": "",
>         "remark": "这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注这是 一个医嘱备注",
>         "frequency": "qd",
>         "drippingSpeed": "",
>         "orderCategoryCode": null,
>         "executePerson": null,
>         "executePersonName": null,
>         "executePersonCode": null,
>         "executeDate": null,
>         "executeType": 0,
>         "checkName": null,
>         "processStatus": null,
>         "startExecuteUser": null,
>         "startExecuteDate": null,
>         "startCheckUser": null,
>         "endExecuteUser": null,
>         "endExecuteDate": null,
>         "currentShift": 0
>       }
>     ],
>     "administrationCode": null,
>     "orderType": null,
>     "patName": "谢玉家tsj",
>     "patCode": "1133443",
>     "patStatus": null,
>     "wardCode": "309",
>     "inhosCode": "12295451",
>     "displayCode": "1133443",
>     "bedCode": "102免f",
>     "interceptBedCode": null,
>     "age": "91岁",
>     "gender": "M",
>     "orderbar": "zpsy@122954512205090800833622136",
>     "processId": null,
>     "processType": "infusion",
>     "executeStatus": 0,
>     "preProcessPerson": "123",
>     "preProcessNode": "medicine_prepare",
>     "preProcessNodeExecuteDate": "2024-06-18T13:36:43.000+0800",
>     "currentProcessNode": "medicine_check",
>     "currentProcessNodeName": null,
>     "orderProcessTpl": {
>       "processId": "6658487a45dd7257db9cf36d",
>       "processType": "infusion",
>       "processName": "自配输液",
>       "sortNo": 1,
>       "processNodes": [
>         {
>           "nodeKey": "medicine_prepare",
>           "nodeName": "备药",
>           "doubleCheck": false,
>           "remindOpen": false,
>           "personCheck": false,
>           "remindRule": null,
>           "remindValue": null
>         },
>         {
>           "nodeKey": "medicine_check",
>           "nodeName": "备药审核",
>           "doubleCheck": false,
>           "remindOpen": false,
>           "personCheck": false,
>           "remindRule": null,
>           "remindValue": null
>         },
>         {
>           "nodeKey": "dispensing",
>           "nodeName": "配药",
>           "doubleCheck": false,
>           "remindOpen": false,
>           "personCheck": false,
>           "remindRule": null,
>           "remindValue": null
>         },
>         {
>           "nodeKey": "dispensing_check",
>           "nodeName": "配药审核",
>           "doubleCheck": false,
>           "remindOpen": false,
>           "personCheck": false,
>           "remindRule": null,
>           "remindValue": null
>         },
>         {
>           "nodeKey": "order_execute",
>           "nodeName": "医嘱执行",
>           "doubleCheck": false,
>           "remindOpen": false,
>           "personCheck": false,
>           "remindRule": null,
>           "remindValue": null
>         },
>         {
>           "nodeKey": "infusion_inspect",
>           "nodeName": "输液巡视",
>           "doubleCheck": false,
>           "remindOpen": false,
>           "personCheck": false,
>           "remindRule": null,
>           "remindValue": null
>         }
>       ],
>       "current": true,
>       "usageCode": null,
>       "usageName": null
>     },
>     "receiveStatus": null,
>     "currentShiftOrderDetails": [],
>     "newOrderStatus": false,
>     "isNightTime": true,
>     "isContinue": null
>   }
> ```

PDA端样式

![[e5a59d7a-2a13-4cbc-9177-ab41b9afcb32.jpg|L|300]]

### 备药

点击「完成备药1」执行接口

```json
// POST /WRMSMnis/dispense/dispense

{
    "executeItems": [
        {
            "inhosCode": "12295451",
            "orderBar": "zpsy@122954512205090800833622136",
            "orderGroupNo": "833622136",
            "processId": "6658487a45dd7257db9cf36d",
            "processNode": "medicine_prepare",
            "processType": "infusion"
        }
    ],
    "wardCode": "309"
}
```

### 备药审核 <font color="#c0504d">接口同上</font>

```json
// POST /WRMSMnis/dispense/dispense
{
    "executeItems": [
        {
            "inhosCode": "12295451",
            "orderBar": "zpsy@122954512205090800833622136",
            "orderGroupNo": "833622136",
            "processId": "6658487a45dd7257db9cf36d",
            "processNode": "medicine_check",
            "processType": "infusion"
        }
    ],
    "wardCode": "309"
}
```


### 配药 <font color="#c0504d">接口同上</font>

```json
// POST /WRMSMnis/dispense/dispense
{
    "executeItems": [
        {
            "inhosCode": "12295451",
            "orderBar": "zpsy@122954512205090800833622136",
            "orderGroupNo": "833622136",
            "processId": "6658487a45dd7257db9cf36d",
            "processNode": "dispensing",
            "processType": "infusion"
        }
    ],
    "wardCode": "309"
}
```

### 配药审核 <font color="#c0504d">接口同上</font>

```json
// POST /WRMSMnis/dispense/dispense

{
    "executeItems": [
        {
            "inhosCode": "12295451",
            "orderBar": "zpsy@122954512205090800833622136",
            "orderGroupNo": "833622136",
            "processId": "6658487a45dd7257db9cf36d",
            "processNode": "dispensing_check",
            "processType": "infusion"
        }
    ],
    "wardCode": "309"
}
```

### 医嘱执行 <font color="#9bbb59">扫描患者腕带</font>


1. 先获取进行中医嘱列表（方便第3步骤展示，调用`/WRMSMnis/order/drug/execution/list`接口）
2. 在执行医嘱（调用`/WRMSMnis/order/drug/execute`接口）
3. 展示进行中的医嘱并执行（调用`/WRMSMnis/orderPatrol/infusion/batch/add`巡视接口）
4. 补充执行额外信息（调用`/WRMSMnis/order/drug/execute/extra`接口）

```json
// GET /WRMSMnis/order/drug/execution/list?wardCode=309&inhosCode=12295451
```

```sql
-- 底层查询拆分医嘱批次的核心SQL
SELECT DISTINCT B.*
FROM windranger_emr.pat_inhos_order A
INNER JOIN windranger_emr.pat_inhos_order_group B ON A.inhos_code = B.inhos_code AND A.order_group_no = B.order_group_no
WHERE b.execute_status = '1'
  AND A.ordering_dept = '309'
  AND A.inhos_code = '12295451'
  AND A.administration_code IN ('25','3','22','74','001','003','0027','11030000106','0022','0020','0220','0004','4566','infsn_0001')
ORDER BY B.plan_time desc;
```


```json
// POST /WRMSMnis/order/drug/execute

{
    "executeItems": [
        {
            "inhosCode": "12295451",
            "orderBar": "zpsy@122954512205090800833622136",
            "orderGroupNo": "833622136",
            "processId": "6658487a45dd7257db9cf36d",
            "processNode": "order_execute",
            "processType": "infusion"
        }
    ],
    "wardCode": "309"
}
```

![[4941df12-6c30-4ef5-87b4-4f21e5ac9047.jpg|L|300]]

```json
// 执行时后
// POST /WRMSMnis/orderPatrol/infusion/batch/add

[
    {
        "orderGroupNo": "833622136",
        "inhosCode": "12295451",
        "wardCode": "309",
        "orderbar": "zpsy@122954512405120800833622136",
        "monitorNurseCode": "123",
        "monitorNurseName": "李",
        "abnormal": 0,
        "infuStatus": "F",
        "rowStatus": 0
    }
]
```



```
// 保存医嘱执行的额外信息（目前主要是滴速和备注信息）
// POST /WRMSMnis/order/drug/execute/extra

```

