# 归档逻辑

## 无纸化归档流程

![[05.文书_归档.excalidraw|L|1200]]

## 归档状态流转

![[Pasted image 20240720103938.png|L|600]]


## 归档文书类型

| 序号  | template_code取值类型                | 对应template_name取值规则  | 对应document_code取值规则                                | 住院号与归档文书关系                       |
| --- | -------------------------------- | -------------------- | -------------------------------------------------- | -------------------------------- |
| 1   | docChildbirth（旧版分娩记录单：具体取决于实际配置） | 分娩记录单（具体取决于实际配置）     | Dxxxxxx                                            | 1:1                              |
| 2   | nursePlan（护理计划）                  | 护理计划                 | <font color="#ff0000">nursePlan</font>${inhosCode} | 1:1                              |
| 3   | Temperature（体温单）                 | 体温单                  | ${inhosCode}                                       | 1:1                              |
| 4   | Txxxxxx（护理记录）                    | ${templateInfo.name} | Dxxxxxx                                            | 1:1                              |
| 5   | Txxxxxx（护理评估）                    | ${templateInfo.name} | Dxxxxxx                                            | 1:1                              |
| 6   | Txxxxxx（普通文书）                    | ${templateInfo.name} | Dxxxxxx                                            | <font color="#ff0000">1:n</font> |
| 7   | Txxxxxx（Lina）                    | ${templateInfo.name} | Dxxxxxx                                            | <font color="#ff0000">1:n</font> |

归档文书类型有7种：

1. 普通文书
2. 护理记录
3. 风险评估
4. 分娩记录单（旧版） -- [[05.文书管理_1.基础知识#分娩记录单]]
5. Lina文书
6. 体温单
7. 护理计划（是否允许归档依赖于配置，配置入口：<font color="#9bbb59">配置中心 - 移动护理 - 护理计划配置 - 是否允许归档</font>）

# 无纸化归档问题排查

## 查看补偿相关


```js
grep "BROWSER" log_info.log

db.htmlToPdfLog.find({tLogTraceId:'3be7629a610e4825a1dc6fa45136fa24'}).sort({ submitTime: -1 })

use mnis
db.htmlToPdfLog.find({inhosCode:'015001-170144'}).sort({ submitTime: -1 })

// 根据状态分组，查看不同状态的数量
db.htmlToPdfLog.aggregate([
    { $match: {tLogTraceId:'5451d82a51ca4533a30b2f4127326102'} },
    {
        $group: {
            _id: {
                status: "$status",
            },
            count: { $sum: 1 }
        }
    }]
)
```

## 查看归档失败的文书

```sql
select * from windranger_mnis.doc_data_filing_record where status = 2
```

```js
use mnis
db.htmlToPdfLog.aggregate([
    { $match: { status: 'onFailed' } },
    {
        $group: {
            _id: {
                inhosCode: "$inhosCode",
                templateCode: "$templateCode"
            },
            count: { $sum: 1 },
            maxSubmitTime: { $max: "$submitTime" }
        }
    },
    {
        $sort: {
            count: - 1
        }
    }]
)
```


## 查看归档成功和失败的比率V1

```js
use mnis
db.htmlToPdfLog.aggregate([
	// 匹配所有文档
	{ $match: {} },
	// 按状态分组并计算每组数量
	{
		$group: {
			_id: "$status",
			count: { $sum: 1 }
		}
	},
	// 计算总记录数并将分组数据存入数组
	{
		$group: {
			_id: null,
			total: { $sum: "$count" },
			statuses: { $push: { status: "$_id", count: "$count" } }
		}
	},
	// 展开数组
	{ $unwind: "$statuses" },
	// 计算比率（不进行四舍五入和格式化）
	{
		$project: {
			_id: 0,
			status: "$statuses.status",
			count: "$statuses.count",
			total: 1,
			ratio: {
				$multiply: [
					{ $divide: ["$statuses.count", "$total"] },
					100
				]
			}
		}
	},
	// 按状态排序
	{ $sort: { status: 1 } }
])
```

## 查看归档成功和失败的比率V2（真实成功率）

```js
use mnis
db.htmlToPdfLog.aggregate([
  // 按 inhousCode 和 templateCode 分组，找出每个组合的最新记录（按照 submitTime 顺序排序，然后取 last 即就是最后一次操作日志了）
  {
    $sort: { submitTime: 1 }
  },
  {
    $group: {
      _id: {
        inhosCode: "$inhosCode",
        templateCode: "$templateCode"
      },
      lastRecord: { $last: "$$ROOT" }
    }
  },
  // 解构 lastRecord 字段以获取实际字段
  {
    $replaceRoot: {
      newRoot: "$lastRecord"
    }
  },
  // 按 status 分组并计数
  {
    $group: {
      _id: "$status",
      count: { $sum: 1 }
    }
  },
  // 计算总数并将分组数据存入数组
  {
    $group: {
      _id: null,
      total: { $sum: "$count" },
      statuses: { $push: { status: "$_id", count: "$count" } }
    }
  },
  // 展开数组
  { $unwind: "$statuses" },
  // 计算比率（不进行四舍五入和格式化）
  {
    $project: {
      _id: 0,
      status: "$statuses.status",
      count: "$statuses.count",
      total: 1,
      ratio: {
        $multiply: [
          { $divide: ["$statuses.count", "$total"] },
          100
        ]
      }
    }
  },
  // 按状态排序
  { $sort: { status: 1 } }
])

```


![[Pasted image 20250728141251.png|L|600]]

## 查询最终一直没成功的文书

>注意这里都是基于归档操作日志进行计算的，归档操作日志只会保留 7 天，也就是基于最近 7 天内的数据进行计算的

```js
use mnis
db.htmlToPdfLog.aggregate([
  // 按 submitTime 升序排序
  {
    $sort: { submitTime: 1 }
  },
  // 按 inhosCode 和 templateCode 分组，获取每个文书组合的最新记录
  {
    $group: {
      _id: {
        inhosCode: "$inhosCode",
        templateCode: "$templateCode"
      },
      lastRecord: { $last: "$$ROOT" }
    }
  },
  // 解构 lastRecord 字段
  {
    $replaceRoot: {
      newRoot: "$lastRecord"
    }
  },
  // 筛选最终状态为失败的记录
  {
    $match: {
      status: { $eq: "onFailed" }  // onFailed 表示失败状态
    }
  },
  // 可选：按 submitTime 降序排列，显示最近失败的记录
  {
    $sort: { submitTime: -1 }
  }
])
```


## 查看归档人分布情况

```js
db.htmlToPdfLog.aggregate([
  {
    $group: {
      _id: "$submitHisCode",
      count: { $sum: 1 }
    }
  },
  {
    $sort: { count: -1 }
  },
  {
    $limit: 10
  }
])
```

## 查看每天自动出院归档数量

>相同文书失败会重试，所以存在归档重试的情况

```js
db.getCollection('htmlToPdfLog').aggregate([
  {
    $match: {
      "submitHisCode": "auto"
    }
  },
  {
    $project: {
      "submitTime": 1,
      "year": { $year: "$submitTime" },
      "month": { $month: "$submitTime" },
      "day": { $dayOfMonth: "$submitTime" }
    }
  },
  {
    $group: {
      _id: {
        year: "$year",
        month: "$month",
        day: "$day"
      },
      count: { $sum: 1 },
      records: { $push: "$$ROOT" }
    }
  },
  {
    $sort: {
      "_id.year": 1,
      "_id.month": 1,
      "_id.day": 1
    }
  }
])
```

## 查看每天自动出院归档的患者数量

```js
db.getCollection('htmlToPdfLog').aggregate([
  {
    $match: {
      "submitHisCode": "auto"
    }
  },
  {
    $project: {
      "inhosCode": 1,
      "submitTime": 1,
      "year": { $year: "$submitTime" },
      "month": { $month: "$submitTime" },
      "day": { $dayOfMonth: "$submitTime" }
    }
  },
  {
    $group: {
      _id: {
        inhosCode: "$inhosCode",
      },
      // 去重
      doc: { $first: "$$ROOT" }
    }
  },
  {
    $project: {
      "inhosCode": "$_id.inhosCode",
      "year": { $year: "$doc.submitTime" },
      "month": { $month: "$doc.submitTime" },
      "day": { $dayOfMonth: "$doc.submitTime" }
    }
  },
  {
    $group: {
      _id: {
        year: "$year",
        month: "$month",
        day: "$day"
      },
      count: { $sum: 1 },
      records: { $push: {
        inhosCode: "$inhosCode"
      }}
    }
  },
  {
    $sort: {
      "_id.year": 1,
      "_id.month": 1,
      "_id.day": 1
    }
  }
])
```

## 查看每天自动出院归档的文书数量

```js
db.getCollection('htmlToPdfLog').aggregate([
  {
    $match: {
      "submitHisCode": "auto"
    }
  },
  {
    $project: {
      "inhosCode": 1,
      "templateCode": 1,
      "documentCodes": 1,
      "submitTime": 1,
      "year": { $year: "$submitTime" },
      "month": { $month: "$submitTime" },
      "day": { $dayOfMonth: "$submitTime" }
    }
  },
  {
    $group: {
      _id: {
        inhosCode: "$inhosCode",
        templateCode: "$templateCode",
        documentCodes: "$documentCodes"
      },
      // 去重
      doc: { $first: "$$ROOT" }
    }
  },
  {
    $project: {
      "inhosCode": "$_id.inhosCode",
      "templateCode": "$_id.templateCode",
      "documentCodes": "$_id.documentCodes",
      "year": { $year: "$doc.submitTime" },
      "month": { $month: "$doc.submitTime" },
      "day": { $dayOfMonth: "$doc.submitTime" }
    }
  },
  {
    $group: {
      _id: {
        year: "$year",
        month: "$month",
        day: "$day"
      },
      count: { $sum: 1 },
      records: { $push: {
        inhosCode: "$inhosCode",
        templateCode: "$templateCode",
        documentCodes: "$documentCodes"
      }}
    }
  },
  {
    $sort: {
      "_id.year": 1,
      "_id.month": 1,
      "_id.day": 1
    }
  }
])
```

## 查看等待时长分布

```js
// 按区间查看 waitMs 的分布情况
db.getCollection('htmlToPdfLog').aggregate([
  {
    $match: {
      "submitHisCode": "auto",
      "submitTime": {$gte: ISODate("2025-08-01T00:00:00.000+08:00")},
      "waitMs": { $gte: 0 }
    }
  },
  {
    $bucket: {
      groupBy: "$waitMs",
      boundaries: [0, 1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000, 1000000, 2000000, 5000000, 10000000, 20000000],
      default: "其他",
      output: {
        count: { $sum: 1 },
        avg: { $avg: "$waitMs" }
      }
    }
  },
  {
    $sort: {
      "_id": 1
    }
  }
])
```


## 查看执行时长分布

```js
// 按区间查看 consumeMs 的分布情况
db.getCollection('htmlToPdfLog').aggregate([
  {
    $match: {
      "submitHisCode": "auto",
      "submitTime": {$gte: ISODate("2025-08-01T00:00:00.000+08:00")},
      "waitMs": { $gte: 0 }
    }
  },
  {
    $bucket: {
      groupBy: "$consumeMs",
      boundaries: [0, 1000, 2000, 5000, 10000, 20000, 50000, 100000, 200000, 500000, 1000000, 2000000, 5000000, 10000000, 20000000],
      default: "其他",
      output: {
        count: { $sum: 1 },
        avg: { $avg: "$consumeMs" }
      }
    }
  },
  {
    $sort: {
      "_id": 1
    }
  }
])
```

# 无纸化归档场景

* 仅生成PDF
* 手动归档（一般为页面用户操作）
* 医院外部调用归档接口
* 患者出院自动归档
* 补偿归档（手动补偿处理）

>目前3.8只有一个入口，3.7貌似有自动回档~****

文书归档相关接口类：`com.lachesis.windranger.controller.doc.DocFilingController`


## 无纸化归档-出院自动逻辑

![[05.文书管理_6.归档文书_出院自动归档_V1.excalidraw|L|1400]]




# 无纸化归档存储

* 文书归档表：windranger_mnis.doc_data_filing_record `MySQL`
* 文书无纸化归档日志记录：mnis.htmlToPdfLog `MongoDB`

# 无纸化归档文书类型

## 1.普通文书

```json
// POST http://10.2.3.170:86/api/windranger/doc/filing/operateDocFiling
// com.lachesis.windranger.controller.doc.DocFilingController#operateDocFiling

// 请求体
{
    "wardCode": "310",
    "docFilingInfos": [
        {
            "documentCodes": [
                "D00072722"
            ],
            "templateCode": "T000405",
            "totalPage": null,
            "templateName": "住院患者首次护理评估单",
            "href": "http://10.2.3.79:86/meepo_v2/#/MNIS_IN_V2/horizontal/mnis-react/docsManage/docsEdit?inhosCode=15472450&patCode=undefined&templateCode=T000405&documentCode=D00072722&startDate=&endDate=&currentType=undefined&openOuter=1&onlyShowDoc=1&wardCode=310"
        }
    ],
    "inhosCode": "15472450",
    "type": "0"
}
```

## 2.护理记录

```json
// POST http://10.2.3.170:86/api/windranger/doc/filing/operateDocFiling
// com.lachesis.windranger.controller.doc.DocFilingController#operateDocFiling

// 请求体
{
    "wardCode": "310",
    "docFilingInfos": [
        {
            "documentCodes": [
                "D00072546"
            ],
            "templateCode": "T000094",
            "totalPage": null,
            "templateName": "护理记录单3",
            "href": "http://10.2.3.79:86/meepo_v2/#/MNIS_IN_V2/horizontal/mnis-react/docsManage/docsEdit?inhosCode=15472450&patCode=undefined&templateCode=T000094&documentCode=D00072546&startDate=&endDate=&currentType=undefined&openOuter=1&onlyShowDoc=1&wardCode=310"
        }
    ],
    "inhosCode": "15472450",
    "type": "0"
}
```

## 3.风险评估

```json
// POST http://10.2.3.170:86/api/windranger/doc/filing/operateDocFiling
// com.lachesis.windranger.controller.doc.DocFilingController#operateDocFiling

// 请求体
{
    "wardCode": "310",
    "docFilingInfos": [
        {
            "documentCodes": [
                "D00072721"
            ],
            "templateCode": "T1111113",
            "totalPage": null,
            "templateName": "疼痛评估护理记录单",
            "href": "http://10.2.3.79:86/meepo_v2/#/MNIS_IN_V2/horizontal/mnis-react/docsManage/docsEdit?inhosCode=15472450&patCode=undefined&templateCode=T1111113&documentCode=D00072721&startDate=&endDate=&currentType=undefined&openOuter=1&onlyShowDoc=1&wardCode=310"
        }
    ],
    "inhosCode": "15472450",
    "type": "0"
}
```

## 4.分娩记录单归档

```json
// POST http://10.2.3.170:86/api/windranger/doc/filing/operateDocFiling
// com.lachesis.windranger.controller.doc.DocFilingController#operateDocFiling

// 请求体
{
    "wardCode": "310",
    "docFilingInfos": [
        {
            "documentCodes": [
                "D00072754"
            ],
            "templateCode": "docChildbirth",
            "totalPage": null,
            "templateName": "分娩记录单",
            "href": "http://10.2.3.79:86/meepo_v2/#/MNIS_IN_V2/horizontal/mnis-react/docsManage/docsEdit?inhosCode=15472450&patCode=undefined&templateCode=docChildbirth&documentCode=D00072754&startDate=&endDate=&currentType=undefined&openOuter=1&onlyShowDoc=1&wardCode=310"
        }
    ],
    "inhosCode": "15472450",
    "type": "0"
}
```


## 5.Lina文书

```json
// POST http://10.2.3.170:86/api/windranger/doc/filing/operateDocFiling
// com.lachesis.windranger.controller.doc.DocFilingController#operateDocFiling

// 请求体
{
    "wardCode": "310",
    "docFilingInfos": [
        {
            "documentCodes": [
                "D00072783"
            ],
            "templateCode": "T000225",
            "totalPage": null,
            "templateName": "梧州模板-已完成-勿动-出院患者随访档案",
            "href": "http://10.2.3.79:86/meepo_v2/#/MNIS_IN_V2/horizontal/mnis-react/docsManage/docsEdit?inhosCode=15472450&patCode=undefined&templateCode=T000225&documentCode=D00072783&startDate=&endDate=&currentType=undefined&openOuter=1&onlyShowDoc=1&wardCode=310"
        }
    ],
    "inhosCode": "15472450",
    "type": "0"
}
```

## 6.体温单

```json
// POST http://10.2.3.170:86/api/windranger/doc/filing/operateDocFiling
// com.lachesis.windranger.controller.doc.DocFilingController#operateDocFiling

// 请求体
{
    "wardCode": "310",
    "docFilingInfos": [
        {
            "documentCodes": [
                "15472450"
            ],
            "templateCode": "Temperature",
            "totalPage": null,
            "templateName": "体温单",
            "href": "http://10.2.3.79:86/meepo_v2/#/MNIS_IN_V2/horizontal/mnis-react/docsManage/docsEdit?inhosCode=15472450&patCode=undefined&templateCode=Temperature&documentCode=15472450&startDate=&endDate=&currentType=undefined&openOuter=1&onlyShowDoc=1&wardCode=310"
        }
    ],
    "inhosCode": "15472450",
    "type": "0"
}
```

## 7.护理计划

```json
// POST http://10.2.3.170:86/api/windranger/doc/filing/operateDocFiling
// com.lachesis.windranger.controller.doc.DocFilingController#operateDocFiling

// 请求体
{
    "wardCode": "310",
    "docFilingInfos": [
        {
            "documentCodes": [
                "nursePlan15472450"
            ],
            "templateCode": "nursePlan",
            "totalPage": null,
            "templateName": "护理计划",
            "href": "http://10.2.3.79:86/meepo_v2/#/MNIS_IN_V2/horizontal/mnis-react/docsManage/docsEdit?inhosCode=15472450&patCode=undefined&templateCode=nursePlan&documentCode=nursePlan15472450&startDate=&endDate=&currentType=undefined&openOuter=1&onlyShowDoc=1&wardCode=310"
        }
    ],
    "inhosCode": "15472450",
    "type": "0"
}
```

