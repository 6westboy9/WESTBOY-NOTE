# 医嘱执行

## 原始统计医嘱数据


```sql
-- PatInhosOrderGroup
select a.* from (  
select piog.inhos_code, piog.orderbar as order_bar, ifnull((select piop.ward_code from windranger_mnis_170.pat_inhos_order_process piop where piop.order_bar = piog.orderbar and (process_node like '%execute%' or process_node like '%check_collect_start%')), pio.ordering_dept) exec_ward_code  
from windranger_emr_170.pat_inhos_order_group piog  
left join windranger_emr_170.pat_inhos_order pio on piog.inhos_code = pio.inhos_code and piog.order_group_no = pio.order_group_no  
where piog.plan_time >= '2025-07-01 00:00:00'  
  and piog.plan_time < '2025-07-10 00:00:00') as a where a.exec_ward_code = '310'  
  
union all  
-- PatLabMaster
select a.* from (  
select piog.inhos_code, piog.order_code as order_bar, ifnull((select piop.ward_code from windranger_mnis_170.pat_inhos_order_process piop where piop.order_bar = piog.bar_code and (process_node like '%execute%' or process_node like '%check_collect_start%')), piog.ordering_dept) exec_ward_code  
from windranger_emr_170.pat_lab_master piog  
where piog.requested_date_time >= '2025-07-01 00:00:00'  
  and piog.requested_date_time < '2025-07-10 00:00:00') as a where a.exec_ward_code = '310'  
  
union all  

-- PatEmrBloodTransfusion
select a.* from (  
select piog.inhos_code, piog.blood_transfusion_code as order_bar, ifnull((select piop.ward_code from windranger_mnis_170.pat_inhos_order_process piop where piop.order_bar = piog.blood_transfusion_code and (process_node like '%execute%' or process_node like '%check_collect_start%')), piog.ward_code) exec_ward_code  
from windranger_emr_170.pat_emr_blood_transfusion piog  
where piog.blood_use_date >= '2025-07-01 00:00:00'  
  and piog.blood_use_date < '2025-07-10 00:00:00') as a where a.exec_ward_code = '310'
```

## 缓存统计医嘱任务

```js
use mnis
db.fatOrderGroupCacheJob.find({isDeleted:false}).sort({cacheDate:-1})
```

## 缓存统计医嘱数据

```js
use mnis
db.fatOrderGroup.find({
    execWardCode: '310',
    planTime: { $gte: ISODate('2025-07-01T00:00:00.000+08:00'), $lt: ISODate('2025-07-10T00:00:00.000+08:00') },
    orderStatus: { $ne: 4 }, // 排除掉原始医嘱的状态已经作废的数据
    executeStatus: { $nin: [3, 4] } // 排除掉已经停止/作废拆分医嘱
})
```

## 缓存统计医嘱数据统计明细

```js
use mnis
db.execStatFatOrderGroup.find({
    reportWardCode: '310',
    reportDate: { $gte: ISODate('2025-07-01T00:00:00.000+08:00'), $lt: ISODate('2025-07-10T00:00:00.000+08:00') },
})
```


## 统计医嘱数据

```js
use mnis
db.mnisOrderReport.find({
    wardCode: '310',
    reportDate: { $gte: ISODate('2025-07-01T00:00:00.000+08:00'), $lt: ISODate('2025-07-10T00:00:00.000+08:00') }
})
```


## 页面

```sql
select * from exec_stat_fat_order_group_view where exec_ward_code = '312'
and order_category_code in ('otherOrder','nursingOrder','transfusionOrder','testOrder','examinationOrder')
union all
select * from exec_stat_fat_order_group_view where exec_ward_code = '312'
and order_category_code = 'medicationOrder' and exec_type_code in ('ATOMIZING','BLOOD','INFUSION','INJECT','ORAL','LAB','SKINTEST','UZ','INFUSION_OTHER');
```

## 其它

```js
db.fatOrderGroup.find({
//orderingDept: '006',
execWardCode: '313',
//administrationCode: {$in: ['LAB']},
// planTime: {$gte: ISODate('2025-03-21T00:00:00.000+08:00'), $lt: ISODate('2025-03-22T00:00:00.000+08:00')},
execTime: {$gte: ISODate('2025-07-02T00:00:00.000+08:00'), $lt: ISODate('2025-07-03T00:00:00.000+08:00')},
//orderStatus: {$nin: ['4']},
// executeStatus: {$in: [4]},
//orderCategoryCode: 'testOrder',
//sourceName: 'LAB_MASTER',
//orderCategoryCode: {$exists: true}
//orderbar: '10180189242025032116'
},{orderbar:1,execTypeCode:1,cacheTime:1,orderCategoryCode:1,planTime:1,execTime:1,sourceName:1,orderStatus:1,executeStatus:1,orderClassCode:1,orderCategoryCode:1,administrationCode:1}).sort({orderbar:1})
```




```js
use mnis

// 初步筛选出来的需要统计的医嘱（参与统计的数据）
db.fatOrderGroup.find({
    execWardCode: '310',
    planTime: { $gte: ISODate('2025-07-01T00:00:00.000+08:00'), $lt: ISODate('2025-07-10T00:00:00.000+08:00') },
    orderStatus: { $ne: 4 }, // 排除掉原始医嘱的状态已经作废的数据
    executeStatus: { $nin: [3, 4] } // 排除掉已经停止/作废拆分医嘱
})


// 参与统计的数据会另存至mnis.execStatFatOrderGroup
db.execStatFatOrderGroup.find({
    reportWardCode: '310',
    reportDate: { $gte: ISODate('2025-07-01T00:00:00.000+08:00'), $lt: ISODate('2025-07-10T00:00:00.000+08:00') },
})
```


## 过滤逻辑

```java
public class FatOrderGroupProcessorChain implements IFatOrderGroupProcessor {

    private final List<IFatOrderGroupProcessor> processors;

    public FatOrderGroupProcessorChain() {
        processors = Lists.newArrayList();
        processors.add(new SortFatOrderGroupProcessor());
        processors.add(new ExcludeNotInShowClassesFatOrderGroupProcessor());
        processors.add(new ExcludeSameBarFatOrderGroupProcessor());
        processors.add(new ExcludeStopFatOrderGroupProcessor()); // 停止医嘱过滤器
        processors.add(new StatFatOrderGroupProcessor());
        processors.add(new ExcludeKeywordFatOrderGroupProcessor());
    }

    @Override
    public void process(FatOrderGroupContext context) {
        for (IFatOrderGroupProcessor processor : processors) {
            processor.process(context);
        }
    }
}
```


### 停止医嘱过滤

查看停止医嘱数量

```js
db.fatOrderGroup.count({
    execWardCode: '313',
    orderStatus: {$in: ['3']},
    executeStatus: 0,
    execTime: {$gte: ISODate('2025-07-02T00:00:00.000+08:00'), $lt: ISODate('2025-07-03T00:00:00.000+08:00')}
})
```

* $ 3.7的配置搜：showStopOrder

![[Pasted image 20250703151834.png|L|1200]]


## 手动执行

* 重新缓存：`/WRMSMnis/stats/order/cacheByPlanTimeRange` → <font color="#ff0000">所有病区</font>
* 重新统计-配药管理：`/WRMSMnis/stats/order/genDispenseStats` → 可指定病区
* 重新统计-医嘱执行：`/WRMSMnis/stats/order/genOrderExecutionStats` → 可指定病区
* 重新统计-标本送检：`/WRMSMnis/stats/order/genSpecimenStats` → 可指定病区
* 重新缓存&统计：`/WRMSMnis/stats/order/genDeptStats` → 相当于上述所有步骤汇总一起（<font color="#ff0000">且是所有病区</font>）


# 配药管理


# 标本送检


# 病房巡视


# 医嘱执行及时率
