# 配置详述

配置入口：<font color="#9bbb59">实施配置 - 智能提醒配置</font>

![[Pasted image 20240703141312.png|1600]]

## 前置条件

><font color="#f79646">适用年龄</font>

><font color="#f79646">触发事件</font>

|     | 触发事件      |                       | 补充条件是否必须 | 补充条件              |
| --- | --------- | --------------------- | -------- | ----------------- |
|     | 手术        |                       |          |                   |
|     | 入院        |                       |          |                   |
|     | 体温        |                       |          |                   |
|     | 病重        |                       |          |                   |
|     | 病危        |                       |          |                   |
|     | 三日无大便     |                       |          |                   |
|     | 体重下降      |                       |          |                   |
|     | 预手术       |                       |          |                   |
|     | 测血氧       |                       |          |                   |
|     | 测血压bid    |                       |          |                   |
|     | 体温不降反升    |                       |          |                   |
|     | 术后患者体温    |                       |          |                   |
|     | 出院评估      |                       |          |                   |
|     | 转入        |                       |          |                   |
| 1   | 高热转正常     |                       |          |                   |
| 1   | 发热转正常     |                       |          |                   |
| 2   | 风险评估单首次记录 | `evalFirstRecord`     |          |                   |
| 2   | 风险评估单分数   | `total`               |          |                   |
| 2   | 风险评估等级    | `riskEvaluationLevel` | 必须       | 补充等级条件：无、低、中、高、极高 |
| 3   | 一级护理转二级护理 |                       |          |                   |
| 3   | 二级护理转一级护理 |                       |          |                   |
| 3   | 二级护理转三级护理 |                       |          |                   |
| 3   | 三级护理转二级护理 |                       |          |                   |
| 3.1 | 特级护理      |                       |          |                   |
| 3.2 | 一级护理      |                       |          |                   |
| 3.3 | 二级护理      |                       |          |                   |
来自系统字典表

```sql
use windranger_foundation;
select * from windranger_foundation.sys_dic where dic_type = 'taskRemindEvent';
```

><font color="#f79646">补充条件</font>


## 任务详情

><font color="#f79646">任务类型</font>

| 任务类型 | 对应配置中字段取值（`ruleType`） |
| ---- | --------------------- |
| 体征   | `vitalSign`           |
| 评估   | `evaluate`            |
| 评估性质 | `evaluateNature`      |

><font color="#f79646">任务项目</font>

根据任务类型决定任务项目

><font color="#f79646">提示语句</font>


## 执行计划

><font color="#f79646">任务性质</font>

列表是前端写死，当然后端代码也维护了对应的常量

|     |                        | 是否在用 |
| --- | ---------------------- | ---- |
| `S` | 单次                     | ✓    |
| `C` | 连续多次                   | ✓    |
| `F` | 复测                     | ✓    |
| `Q` | 持续多日                   | ✓    |
| `W` | 周期性重复                  | ✓    |
| `D` | 不生成新任务                 | ✓    |
| `J` | 间隔 --- 来自后端的注释，不清楚是否在用 |      |
>根据任务性质进行拆分的方法入口：com.lachesis.windranger.mnis.processer.impl.TaskRemindProcesser#getTaskRemindRecords



智能提醒


| 类型   | 监听器                             |
| ---- | ------------------------------- |
| 体征   | VitalTaskRemindEventListener    |
| 患者事件 | PatEventTaskRemindEventListener |
| 评估   | EvaluateTaskRemindEventListener |


# 存储结构

## 任务提醒配置

| 分类   | 字段                                          | 字段名称                               | 字段类型            | 字段备注                                          |
| ---- | ------------------------------------------- | ---------------------------------- | --------------- | --------------------------------------------- |
| 前置条件 | 适用年龄                                        | `ageMin`                           | `int`           | 适用年龄下限                                        |
|      |                                             | `ageMax`                           | `int`           | 适用年龄上限                                        |
|      |                                             | `ageUnit`                          | `int`           | <font color="#c0504d">没用</font>               |
|      |                                             | `eventType`                        | `String`        | **作用：双条件触发时，记录首次触发事件类型**                      |
|      | **前置条件（1+个条件）**                             | `configCondition.conditionDetails` | `List`          |                                               |
|      | ┌ 触发事件                                      | `eventType`                        | `String`        |                                               |
|      | ├ 补充条件（由选择事件决定）                             | `riskEvaluationLevels`             | `List<String>`  | 风险评估等级                                        |
|      | ├ 补充条件（由选择事件决定）                             | `ruleMin`                          | `Float`         | 补充条件数值范围下限                                    |
|      | ├ 补充条件（由选择事件决定）                             | `ruleMax`                          | `Float`         | 补充条件数值范围上限                                    |
|      | └ 补充条件（由选择事件决定）                             | `ruleTimes`                        | `Integer`       | 补充条件连续发生次数                                    |
|      | 触发时间                                        | `configCondition.triggerTime`      |                 | 1:不限制 2:24小时内 3:同时触发                          |
| 任务详情 |                                             | `ruleName`                         | `String`        | <font color="#c0504d">没用</font>               |
|      | 任务项目                                        | `bindItem`                         | `String`        | 由任务类型决定                                       |
|      | 提示语句                                        | `content`                          | `String`        |                                               |
| 执行计划 | 任务性质                                        | `periodType`                       | `String`        | S:单次 C:连续多次 F:复测 Q:持续多日 W:周期性重复 D:不生成新任务      |
|      | 连续次数 <font color="#c0504d">独立属性</font>      | `cycleTime`                        | `int`           | <font color="#9bbb59">任务性质=C:连续多次</font>      |
|      | 持续天数 <font color="#c0504d">独立属性</font>      | `duration`                         | `Integer`       | <font color="#4f81bd">任务性质=Q:连续多次</font>      |
|      | 周期天数-固定长度 <font color="#c0504d">独立属性</font> | `interval`                         | `Integer`       | <font color="#8064a2">任务性质=W:周期性重复</font>     |
|      | 周期天数-固定每周 <font color="#c0504d">独立属性</font> | `weekMeasureTimes`                 | `List<Integer>` | <font color="#8064a2">任务性质=W:周期性重复</font>     |
|      | 开始日期-触发事件发生起算第几天                            | `startDay`                         | `Integer`       |                                               |
|      | *计划时间-1.按体温单*                               | `measureTimes`                     | `List<Integer>` |                                               |
|      | *计划时间-2.按班次*                                | `shiftCodes`                       | `List<String>`  |                                               |
|      | *计划时间-3.时间点*                                | `timePoints`                       |                 |                                               |
|      | *计划时间-4.无特定*                                |                                    |                 | <font color="#c0504d">不理解啥意思</font>           |
|      | *计划时间-5.触发事件后小时间隔*                          | `intervalHour`                     | `Integer`       |                                               |
|      | 首次未满延续一天                                    | `delayOneDay`                      | `Boolean`       | <font color="#c0504d">作用：计划时间1,2,3的子属性</font> |
| 剩余字段 | 长临类型                                        | `longTerm`                         | `int`           | 1.长期 0.临时                                     |
|      | 是否可修改                                       | `visible`                          | `boolean`       |                                               |
|      | 状态                                          | `status`                           | `boolean`       | true.启用 false.关闭                              |
|      |                                             | `bindEventIds`                     | `List<String>`  |                                               |
## 任务提醒记录

```java
public class TaskRemindRecord extends ValuedBean<String> {
    @Id
    private String id;
    @ApiModelProperty(name = "inhosCode", value = "住院号")
    private String inhosCode;
    @ApiModelProperty(name = "patCode", value = "患者号")
    private String patCode;
    @ApiModelProperty(name = "planDate", value = "计划时间当天的日期")
    private Date planDate;
    @ApiModelProperty(name = "planTime", value = "计划执行时间")
    private Date planTime;
    @ApiModelProperty(name = "planStartTime", value = "计划开始执行时间")
    private Date planStartTime;
    @ApiModelProperty(name = "planEndTime", value = "计划结束执行时间")
    private Date planEndTime;
    @ApiModelProperty(name = "teamCode", value = "计划执行班次")
    private String teamCode;
    @ApiModelProperty(name = "bindItem", value = "数据触发的源类型：1.体征的项目编号，2.风险评估的性质。3、风险评估单的ID")
    private String bindItem;
    @ApiModelProperty(name = "ruleType", value = "规则类型")
    private String ruleType;
    @ApiModelProperty(name = "content", value = "智能提醒内容")
    private String content;
    @ApiModelProperty(name = "process", value = "是否已经处理, 0为未处理")
    private Integer process;
    @ApiModelProperty(name = "bindItemId", value = "关联完成该任务的唯一ID")
    private String bindItemId;
    @ApiModelProperty(name = "eventItemId", value = "关联触发该任务的数据的唯一id")
    private String eventItemId;
    @ApiModelProperty(name = "eventItemIds", value = "如果关联的事件有好几个构成的话，则需要联动的触发")
    private List<String> eventItemIds;
    @ApiModelProperty(name = "configId", value = "关联的配置唯一id")
    private String configId;
    @ApiModelProperty(name = "periodType", value = "周期类型(S-单次 C-连续多次 D-当天[不生成新任务] F-复测 W-周期性重复 J-间隔 Q-持续多日)")
    private String periodType;
    @ApiModelProperty(name = "visible", value = "是否可修改")
    private Boolean visible;
    @ApiModelProperty(name = "source", value = "来源,event,vital,evaluate")
    private String source;
    @ApiModelProperty(name = "eventType", value = "关联事件,关联数据字典eventType")
    private String eventType;
    @ApiModelProperty(name = "releatedOrderGroupNo", value = "关联医嘱的编号")
    private String releatedOrderGroupNo;
    @ApiModelProperty(name = "releatedSurgeryCode", value = "术后体温关联的手术编号")
    private String releatedSurgeryCode;
    @ApiModelProperty(name = "wardCode", value = "病区编号")
    private String wardCode;
    
	@ApiModelProperty(name = "createTime", value = "创建时间", example = "2017-01-16T15:30:19.000+0800")
    private Date createTime;
    @ApiModelProperty(name = "createPerson", value = "创建人")
    private String createPerson;
    @ApiModelProperty(name = "updateTime", value = "修改时间", example = "2017-01-16T15:30:19.000+0800")
    private Date updateTime;
    @ApiModelProperty(name = "updatePerson", value = "修改人")
    private String updatePerson;
}
```

# 事件

>事件类型

![[Pasted image 20241204104750.png|700]]

>事件监听器

![[Pasted image 20241204103312.png|700]]


|     | 事件                            | 事件监听器                                 | 事件描述 |
| --- | ----------------------------- | ------------------------------------- | ---- |
| 1   | AttendDataEvent               | AttendDataEventListener               |      |
| 2   | CopyAttendToPathEvent         | CopyAttendToPathEventListener         |      |
| 3   | CopyAttendTplToEachOtherEvent | CopyAttendTplToEachOtherEventListener |      |
| 4   | CopyEvaluateToPathEvent       | CopyEvaluateToPathEventListener       |      |
| 5   | CopyVitalToPathEvent          | CopyVitalToPathEventListener          |      |
| 6   | EvaluateDataEvent             | EvaluateDataEventListener             |      |
| 7   | EvaluateTaskRemindEvent       | EvaluateTaskRemindEventListener       |      |
| 8   | InfusionInoutEvent            | InfusionInoutEventListener            |      |
| 9   | OrderInoutEvent               | OrderInoutEventListener               |      |
| 10  | PatEventTaskRemindEvent       | PatEventTaskRemindEventListener       |      |
| 11  | VitalTaskRemindEvent<br>      | VitalTaskRemindEventListener          |      |
| 12  | VitalsignEvent                | VitalsignEventListener                | 体征事件 |

>页面配置事件与上述事件的区别是？




## 体征事件

```js
// 查询配置
db.taskRemindConfig.find({ "wardCodes": { "$in": ["309"] }, "eventType": "temperature", "status": true })
```





## 风险评估事件

```json
{
    "evaluateRiskExt": {
        "archived": false,
        "seqId": 386494,
        "wardCode": "309",
        "inhosCode": "99548448",
        "templateCode": "T001027",
        "documentCode": "D00332058",
        "recordCode": "1809166037061603328-663656",
        "evaluateNature": "pressureSore",
        "riskLevel": "02",
        "showName": "中度风险",
        "recordDate": 1720173720000,
        "rate": "12",
        "createPerson": "123",
        "createTime": 1720173771000,
        "updatePerson": "123",
        "updateTime": 1720173946670,
        "primaryKey": 386494
    },
    "operation": "save",
    "timestamp": 1720173946976
}
```


1.查询所有评估数据，按照`record_date`倒序排序，取第一个评估数据（即最近一条评估数据）

```sql
select * from doc_data_evaluate_risk where inhos_code = '99548448' and evaluate_nature = 'pressureSore';
```


```js
db.taskRemindConfig.find({ "wardCodes": { "$in": ["309"] }, "eventType": "total", "bindItem": { "$in": ["pressureSore", "T001027"] }, "status": true })
```

风险评估`eventType`类型：

* total：风险评估单分数
* riskEvaluationLevel：风险评估等级

```java
com.lachesis.windranger.mnis.event.taskremind.EvaluateTaskRemindEventListener#onApplicationEvent
com.lachesis.windranger.mnis.event.taskremind.EvaluateTaskRemindEventListener#saveEvalTaskByData
com.lachesis.windranger.mnis.event.taskremind.EvaluateTaskRemindEventListener#createNextTaskRemindByTotalOrLevel
com.lachesis.windranger.mnis.event.taskremind.EvaluateTaskRemindEventListener#createTotalTaskRemind
com.lachesis.windranger.mnis.service.ITaskRemindService#saveNextTaskByEvalScoreOrRiskLevel
com.lachesis.windranger.mnis.service.impl.TaskRemindService#buildNextTaskByEvalScoreOrLevel // 创建任务核心方法
```

com.lachesis.windranger.mnis.service.impl.TaskRemindService#buildNextTaskByEvalScoreOrLevel

### 新增提醒任务核心逻辑


> [!danger] 按照任务类型，只有评估和评估性质才能配置按班次进行配置，两者的处理逻辑是一致的~

![[Pasted image 20240708160402.png|400]]

说明：
* 任务性质：没有用到（除了不生成新任务选项）
* 开始日期：触发事件发生起算第几天
* 计划时间：这里我们选择按照班次

规则

![[Pasted image 20240708160809.png|400]]


>护理排班非跨天的情况

![[Pasted image 20240708160608.png|1000]]

>护理排班跨天的情况

![[Pasted image 20240708160745.png|1000]]


# 查看提醒任务

