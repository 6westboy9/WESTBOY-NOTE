# 流程

![[04.医嘱_新医嘱提醒.excalidraw|1000]]

# 过程

## 1.医嘱变更消息推送 - 同步程序

>提醒的前提：同步程序推送医嘱变更消息至队列：sync_data_pat_inhos_order_exchange

具体推送有没有找对应同事确认。

## 2.原始医嘱过滤 

### 新医嘱过滤

>[!warning] 只会处理新增的原始医嘱数据

 1. 原始医嘱表字段必须存在：
	1. orderingDept（开立病区）
	2. inhosCode（住院号）
	3. orderStatus（原始医嘱状态）
	4. enterDateTime（开立时间）
2. 当前时间-1天 < 开立时间 < 当前时间

```sh
# 借助Arthas工具查看过滤后的结果
$ watch com.lachesis.windranger.mnis.listener.mq.PatInhosOrderListener getNewOrderCodes '{params,returnObj,throwExp}'  -n 5  -x 3 
```

### 停医嘱过滤

> [!warning] 只会处理更新的原始医嘱数据

1. 原始医嘱表字段必须存在：
	1. orderingDept = 开立病区
	2. inhosCode = 住院号
	3. orderStatus = 原始医嘱状态
2. orderStatus = 3 或者 当前时间-1天 < stopDateTime < 当前时间

```sh
# 借助Arthas工具查看过滤后的结果
$ watch com.lachesis.windranger.mnis.listener.mq.PatInhosOrderListener getStopOrders '{params,returnObj,throwExp}'  -n 5  -x 3 
```

## 3.配置检查

新医嘱开关必须开启：**业务配置 -> 移动护理 -> 医嘱提醒配置 -> 新医嘱推送**

![[Pasted image 20250821152905.png|L|1000]]

## 4.推送提醒用户

如何查看推送医护人员？

在移动护理后端应用所在服务器上执行如下命令：

```sh
# 使用Redis提供的工具
$ redis-cli
> auth lx_1234
> get WARD_CACHE_KEY:{wardCode} # 记得替换患者病区，看看有没有要推送给医护人员的userCode
```

>[!warning] 送的医护人员userCode必须满足的条件：对应windranger_hospital.hos_user表数据的user_type必须是01或者02其中一个

如果不是，在数据库中改完数据之后，清空缓存：

```sh
> del WARD_CACHE_KEY:{wardCode} # 清空缓存
```

然后，需要**重新触发同步程序推送医嘱变更消息**。

>[!danger] 如何确认消息发送给消息中心？

```sh
watch com.lachesis.molecule.msgcenter.api.ICenterMsgApi sendWithUsersAndWard '{params,returnObj,throwExp}'  -n 5  -x 3 
```

## 5.消息中心推送至PDA

```sh
# 具体这里的Y是几安装系统而异，正常都是一个数字，是几不重要
$ cd /usr/local/springboot/springbootY_msgcenter/MsgCenter/LOGS
# 999903546234991对应原始医嘱的orderGroupNo
# 123对应发送给哪个医护人员
$ grep "999903546234991" log_info.log | grep "消息发送成功" | grep "123"
```

如果发送成功了，消息大致如下：

```
08/21 15:58:53.346 [DubboServerHandler-10.2.3.170:20583-thread-193] INFO  c.l.m.msgcenter.service.impl.MnisMessageService - 消息发送成功，userCode:123，wardCode:310,msgJson：{"msg":{"bedCode":"104免f","orderGroupNo":"999903546234991","overtime":0,"patName":"谢玉家3335","time":1755763133,"title":"新医嘱提醒","inhosCode":"93295451"},"msgType":"new_order_type","recordId":"new_order_999903546234991","time":1755763133}
```

## 6.PDA处理接受到的消息

推送给PDA之后，PDA提示不提示，还有对应的流程，需要PDA端同事补充逻辑

TODO补充 @刘泽霖



# 手动补偿
## 接口

接口：`/WRMSMnis/mnis/testNewOrder`

```json
{
  "insertList": [
    "9999251247834991" 
  ],
  "updateList": [
    "1014800919",
    "1015214029",
    "1015182605",
    "1013666491",
    "1015182705",
    "1013666492",
    "1014800920",
    "1013666493",
    "1015384805",
    "1015438755",
    "1013666489",
    "1014767002",
    "1015438753",
    "1015214031",
    "1015214032"
  ]
}
```

* 新医嘱提醒就将orderCode放置在`insertList`中
* 停医嘱提醒就将orderCode放置在`updateList`中

## 新医嘱提醒相关日志

>通过traceId就可以串起来查询整个链路！

>`from mnis`

```
2025-08-25 10:41:45.683 mnis [http-nio-9099-exec-5] INFO  c.l.w.mnis.listener.mq.PatInhosOrderListener - <0><43c6f65f4aa146a3923cb4222c6b9f0c> 新增医嘱消息处理开始:insertSize=1,insertList=["9999251247834991"]
2025-08-25 10:41:45.696 mnis [http-nio-9099-exec-5] INFO  c.l.w.mnis.listener.mq.PatInhosOrderListener - <0><43c6f65f4aa146a3923cb4222c6b9f0c> 新医嘱筛选前:size=1
2025-08-25 10:41:45.696 mnis [http-nio-9099-exec-5] INFO  c.l.w.mnis.listener.mq.PatInhosOrderListener - <0><43c6f65f4aa146a3923cb4222c6b9f0c> 新医嘱筛选后:invalidSize=0,invalidStatusSize=0,timeOutOfRangeSize=0,size=1
2025-08-25 10:41:45.696 mnis [http-nio-9099-exec-5] INFO  c.l.windranger.mnis.service.impl.PushMsgService - <0><43c6f65f4aa146a3923cb4222c6b9f0c> 推送服务开始处理医嘱消息:messageTitle=新医嘱提醒,orderSize=1
2025-08-25 10:41:45.760 mnis [http-nio-9099-exec-5] INFO  c.l.windranger.mnis.service.impl.PushMsgService - <0><43c6f65f4aa146a3923cb4222c6b9f0c> 推送消息:wardCode=310,inhosCode=93295451,orderGroupNo=999903546234991
2025-08-25 10:41:47.191 mnis [http-nio-9099-exec-5] INFO  c.l.windranger.mnis.service.impl.PushMsgService - <0><43c6f65f4aa146a3923cb4222c6b9f0c> 消息推送完成:successSize=1,stOrderSize=0
```

>`from msgcenter`

```
2025-08-25 10:41:46.427 msgcenter [DubboServerHandler-10.2.43.39:20583-thread-11] INFO  c.l.m.msgcenter.service.impl.MnisMessageService - <0.4><43c6f65f4aa146a3923cb4222c6b9f0c> 用户不在线缓存消息:{"forceCache":2,"mnisMsgVo":{"msg":{"bedCode":"104免f","orderGroupNo":"999903546234991","overtime":0,"patName":"谢玉家3335","time":1756089705,"title":"新医嘱提醒","inhosCode":"93295451"},"msgType":"new_order_type","recordId":"new_order_999903546234991","time":1756089705},"userCodes":["9999","123","8097","111471","4505","1011","1007","4512","G013","1014","3207","3203","G032","3221","G037","G038","1034","5874","8920","5895","G024","3231","8918","111495","111493","8911","G050","7600","3241","1061","8929","8924","5897","8921","8922","5415","8928","8925","8926","G040","8942","8940","G046","G049","3248","8934","8938","8939","5441","111056","8950","5444","8945","7615","8962","G067","8957","7625","8965","7639","7651","G081","7653","8985","7652","G086","3299","G089","8978","7649","8993","8511","7665","8506","7659","8509","8507","4161","5011","7672","7674","7677","7676","7669","5022","7680","7678","4183","8545","7212","5044","4191","4192","8547","7218","7234","7236","8559","8570","8585","7257","8588","5086","7263","7266","7269","7275","7276","5091","7272","7283","7299","7294","9004","8166","9016","8162","8179","9029","8173","111892","112206","9078","111338","G118","G119","G107","9091","5978","G125","G127","G126","G129","G128","5500","G150","G152","G151","3343","3342","5996","G143","2022","G145","G144","G147","G146","G149","G148","4212","G178","G179","7717","4217","5560","5564","G180","4243","G182","G185","G184","2064","5585","7755","4247","7757","7770","7772","4263","5590","7766","8619","7781","7301","8631","8624","4284","7310","5133","7796","7788","8639","7325","7799","10","9994","7336","110815","6014","6006","8200","6020","8683","6019","111712","5187","7359","8223","5197","5198","8221","8225","111704","7384","8231","8232","8237","8228","7398","8248","9102","111753","111751","9105","8260","111739","111720","8295","8294","111769","111768","G210","G206","G208","G207","G209","111698","111685","111684","111207","3427","3424","111693","111690","5604","5619","3434","5615","5617","4300","15284","5640","5632","4301","7810","111262","5637","7817","7831","5661","4324","5673","4343","5680","4352","3022","112155","5676","112154","5690","5693","5211","112135","3029","3028","5204","112143","5205","5206","5207","7401","3040","3038","7876","8723","5219","7890","4383","4387","8736","5240","3066","112190","5238","3070","5251","7431","8764","5257","3077","3075","5249","5261","3081","8770","7441","7444","3089","7450","8781","5277","8788","5278","8785","3099","5270","5271","8310","7463","5287","8799","5289","8308","8789","5299","8323","8337","8335","8342","7016","7491","7026","7028","7018","7029","8374","7047","7057","7056","7058","111628","111627","111619","2603","2607","2604","111603","111678","111681","111680","2626","111665","111664","2630","111653","2647","2646","111644","2661","111647","2657","111598","2671","2668","0001","0009","111589","111587","1349","111593","1363","2690","1358","1354","111582","111581","111562","1370","2699","111572","111570","5723","7904","112007","1375","111165","5735","4407","7929","7928","4418","4432","3582","4422","7931","7934","5756","7936","4426","7935","7938","7951","4433","5764","8810","3120","3115","8802","112052","5786","111197","4456","8811","5308","7983","112025","7500","112024","7975","5798","5316","112031","4481","111166","8841","112023","4478","7504","8850","J001","4013","3165","112090","5335","8846","5336","112099","5337","7999","8845","5338","5339","3178","8858","4017","3181","8874","3189","112078","7535","112073","4040","7550","4041","3190","7551","7556","7555","3193","8879","7549","8897","7565","8898","8888","7559","4062","7573","5397","4059","4073","8435","7599","7108","7124","7126","4090","8468","8461","7153","8006","8007","8005","8483","8495","111512","7169","8491","8008","2708","7176","7175","8022","111501","7177","8027","7174","2713","8035","8036","7195","8041","8053","111545","111549","111548","3609","111524","8089","8083","8081","111528","111482","111481","111494","9089","111604","111584","111579","111569","111568","111559","111561","112203","5589","112114","112161","112150","112182","112001","112000","111951","111957","111927","112149","111916","111543","111657","112202","7610","8227","1000","5422","3252","4110","6789","8994","8556","8112","9090","G154","G183","7368","7394","111724","WXTEST","15117","111771","111699","5608","3426","7835","3043","5298","2627","1300","5702","2698","4431","3104","4438","3124","3157","111931","8033","3604","FC8000","JN8918","111061","WX8868","112297","JN112149","111804","1029","1048","8543","7230","8572","8573","111824","9017","9033","9080","9967","5660","8700","7412","7439","0002","5701","3109","7553","8023","5076","5079","5089","8146","5901","2015","7711","3388","7746","7763","9566","8244","8299","7809","112176","7889","8304","7039","7105","7117","7181","7199","112543","112324","112329","112372","112351","8099","00850","0005","0006","2808","0013","0015","0016","0017","niubi02","niubi01","niubi03","niubi05","niubi012","niubi10","niubi15","niubi016","niubi17","1103","5453"],"wardCode":"310"}
2025-08-25 10:41:46.957 msgcenter [DubboServerHandler-10.2.43.39:20583-thread-11] INFO  c.l.m.msgcenter.service.impl.MnisMessageService - <0.4><43c6f65f4aa146a3923cb4222c6b9f0c> 删除缓存消息:recordId=new_order_999903546234991,msgType=new_order_type,deletedCount=640
2025-08-25 10:41:47.149 msgcenter [DubboServerHandler-10.2.43.39:20583-thread-11] INFO  c.l.m.msgcenter.service.impl.MnisMessageService - <0.4><43c6f65f4aa146a3923cb4222c6b9f0c> 消息处理完成:consume=1273ms
```

![[Pasted image 20250825104318.png|L|400]]