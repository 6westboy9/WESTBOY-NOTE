# 拆分来源

1. 医院自身已经拆分好了，只需同步程序同步即可
2. 医院自身没有拆分，最要我们进行拆分

>如无特殊说明，这里的医嘱拆分主要指我们的拆分逻辑~

# 拆分种类

1. 长期医嘱拆分
2. 临时医嘱拆分

如何判断是长期医嘱和临时医嘱呢？见[[04.医嘱管理_1.基础知识#医嘱类型]]

# 拆分配置

## 瓶签拆分基础配置

配置路径：<font color="#9bbb59">配置中心 - 业务配置 - 移动护理 - 医嘱配置 - 医嘱拆分 - 瓶签拆分基础配置</font>

> [!note] 理解：瓶签的内容就是医嘱拆分，医嘱拆分等同于瓶签拆分~

![[Pasted image 20240614183455.png|L|800]]

捋一捋，可以分为<font color="#f79646">三个</font>部分

* 第一部分：是否自己拆分医嘱
* 第二部分：拆分条件
	* 条件1：时间范围（昨日、今日-<font color="#f79646">默认</font>、次日）
	* 条件2：医嘱类型（对应的就是原始医嘱上医嘱类别字段，见[[04.医嘱管理_1.基础知识#医嘱概念#医嘱类别]]）
	* 条件3：是否为静配药品
* 第三部分：拆分时机
	* 定时任务拆分
	* 打印瓶签时拆分

## 拆分类型

| 拆分类型   | 频次编号 | 频次名称 | 拆分配置                           |
| ------ | ---- | ---- | ------------------------------ |
| 立即执行   | 必填   | 选填   | <font color="#c0504d">无</font> |
| 间隔天数   | 必填   | 选填   | 必填                             |
| 间隔天数逢单 | 必填   | 选填   | 必填                             |
| 间隔天数逢双 | 必填   | 选填   | 必填                             |
| 间隔时间   | 必填   | 选填   | 必填                             |
| 间隔时间逢单 | 必填   | 选填   | 必填                             |
| 间隔时间逢双 | 必填   | 选填   | 必填                             |
| 一周多次   | 必填   | 选填   | 必填                             |
| 一天多次   | 必填   | 选填   | 必填                             |

| 配置项         | 立即执行                           | 间隔天数                                                                                                               | 间隔天数逢单                                                                                                                                                                                                    | 间隔天数逢双                                                                                                                                                                           | 间隔时间                                                    | 间隔时间逢单                                                  | 间隔时间逢双                                                  | 一周多次                                                             | 一天多次                                                    |
| ----------- | ------------------------------ | ------------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- | ------------------------------------------------------- | ------------------------------------------------------- | ---------------------------------------------------------------- | ------------------------------------------------------- |
| 临时医嘱是否拆分    | 开关                             | 开关                                                                                                                 | 开关                                                                                                                                                                                                        | 开关                                                                                                                                                                               | 开关                                                      | 开关                                                      | 开关                                                      | 开关                                                               | 开关                                                      |
| 长期医嘱首日是否拆分  | 开关                             | 开关                                                                                                                 | 开关                                                                                                                                                                                                        | 开关                                                                                                                                                                               | 开关                                                      | 开关                                                      | 开关                                                      | 开关                                                               | 开关                                                      |
| 首日拆分规则      | <font color="#c0504d">无</font> | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分                                                            | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分                                                                                                                                                   | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分                                                                                                                          | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分          | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 |
| 末日拆分规则      | <font color="#c0504d">无</font> | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分                                                            | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分                                                                                                                                                   | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分                                                                                                                          | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分          | - 全部拆分<br>- 按医嘱开立时间部分拆分<br>- 按医嘱要求次数拆分<br>- 按开立次数适配频次拆分 |
| 间隔天数规则      | <font color="#c0504d">无</font> | - 首日为第一次拆分<br>- 首日为第一次拆分（末日必拆）<br>- 次日为第一次拆分（首日拆）<br>- 次日为第一次拆分（首末日必拆）<br>- 首日是否有拆分次数定义规则<br>- 首日是否有拆分次数定义规则（末日必拆） | <font color="#c0504d">无</font>                                                                                                                                                                            | <font color="#c0504d">无</font>                                                                                                                                                   | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                                   | <font color="#c0504d">无</font>                          |
| 间隔天数逢单规则    | <font color="#c0504d">无</font> | <font color="#c0504d">无</font>                                                                                     | - 从首日开始计算（首日拆）<br>- 从首日开始计算（首末日拆）<br>- 从首日开始计算（首日不拆）<br>- 从首日开始计算（首日不拆，末日必拆）<br>- 从次日开始计算（首日必拆）<br>- 从次日开始计算（首末日必拆）<br>- 首日是否有拆分次数定义规则<br>- 日期逢单拆分<br>- 日期逢单拆分（末日必拆）<br>- 日期逢单拆分（首日必拆）<br>- 日期逢单拆分（首末日必拆） | <font color="#c0504d">无</font>                                                                                                                                                   | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                                   | <font color="#c0504d">无</font>                          |
| 间隔天数逢双规则    | <font color="#c0504d">无</font> | <font color="#c0504d">无</font>                                                                                     | <font color="#c0504d">无</font>                                                                                                                                                                            | - 从首日开始计算<br>- 从首日开始计算（末日必拆）<br>- 从次日开始计算（首日不拆）<br>- 从次日开始计算（首日不拆，末日必拆）<br>- 从次日开始计算（首日拆）<br>- 从次日开始计算（首末日必拆）<br>- 日期逢双拆分<br>- 日期逢双拆分（末日必拆）<br>- 日期逢双拆分（首日必拆）<br>- 日期逢双拆分（首末日必拆） | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                                   | <font color="#c0504d">无</font>                          |
| 次日是否从零点开始拆分 | <font color="#c0504d">无</font> | <font color="#c0504d">无</font>                                                                                     | <font color="#c0504d">无</font>                                                                                                                                                                            | <font color="#c0504d">无</font>                                                                                                                                                   | 开关                                                      | 开关                                                      | 开关                                                      | <font color="#c0504d">无</font>                                   | <font color="#c0504d">无</font>                          |
| 零点数据归属      | <font color="#c0504d">无</font> | <font color="#c0504d">无</font>                                                                                     | <font color="#c0504d">无</font>                                                                                                                                                                            | <font color="#c0504d">无</font>                                                                                                                                                   | - 零点前一天<br>- 零点当天                                       | - 零点前一天<br>- 零点当天                                       | - 零点前一天<br>- 零点当天                                       | <font color="#c0504d">无</font>                                   | <font color="#c0504d">无</font>                          |
| 一周多次拆分规则    | <font color="#c0504d">无</font> | <font color="#c0504d">无</font>                                                                                     | <font color="#c0504d">无</font>                                                                                                                                                                            | <font color="#c0504d">无</font>                                                                                                                                                   | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | <font color="#c0504d">无</font>                          | - 7天一轮<br>- 7天一轮（首末日）<br>- 按星期拆分<br>- 星期拆分（首末日）<br>- 按首日医嘱次数定义规则 | <font color="#c0504d">无</font>                          |

* 判断是否是首日规则：startDateTime 与 拆分执行时间 是同一天
* 判断是否是末日规则：stopDateTime 与 拆分执行时间 是同一天
* ! 零点数据归属：对于首日拆分无效~

| 拆分类型   | 实现                   |
| ------ | -------------------- |
| 立即执行   | `ExecuteNow`         |
| 间隔天数   | `IntervalDay`        |
| 间隔天数逢单 | `IntervalDaySingle`  |
| 间隔天数逢双 | `IntervalDayDouble`  |
| 间隔时间   | `IntervalTime`       |
| 间隔时间逢单 | `IntervalTimeSingle` |
| 间隔时间逢双 | `IntervalTimeDouble` |
| 一周多次   | `WeekManyTimes`      |
| 一天多次   | `DayManyTimes`       |

## 频次维护

配置路径：<font color="#9bbb59">配置中心 - 业务配置 - 移动护理 - 医嘱配置 - 医嘱拆分 - 频次维护</font>

![[Pasted image 20240712152940.png|L|500]]

## 首末日拆分规则

当医院要求<font color="#ff0000">首末日（第一天和最后一天）</font>拆分需要按照特定的时间拆分时，则需要在对应的类型中的首末日拆分规则中选择 按开立次数适配频次拆分， 并且需要在首末日拆分中绑定指定的拆分频次。

>首末日拆分规则操作对应mnis服务接口：com.lachesis.windranger.controller.configCenter.WardOrderSplitTimesRuleController


![[Pasted image 20250701182516.png|L|1200]]


![[Pasted image 20250701192948.png|L|400]]

* 拆分次数：指定首末日拆分的次数
* 关联频次编号：指定对应拆分规则（对应的频次编码，来自于<font color="#9bbb59">频次维护</font>中类型是<font color="#ff0000">一日多次</font>和<font color="#ff0000">间隔时间</font>的频次编码）
	* <font color="#ff0000">为啥是一日多次和间隔时间呢？</font>因为首日/末日只有一天，理所当然对应的拆分频次只会是一日多次或者间隔时间
* 使用范围：配置此拆分规则下的医嘱频次，来自于<font color="#9bbb59">频次维护</font>中<font color="#ff0000">所有类型</font>的频次编码

## 配置小结

![[04.医嘱_医嘱拆分_01.excalidraw|L|1200]]


# 拆分场景

![[04.医嘱_医嘱拆分_触发时机.excalidraw|L|1000]]

# 拆分逻辑 <font color="#f79646">TODO</font>

> [!danger] 核心方法入口：com.lachesis.windranger.mnis.service.impl.PatOrderGroupService#splitOrder


```sql
USE windranger_emr;
SELECT DISTINCT order_group_no FROM pat_inhos_order_group
WHERE plan_time >= {beginDate} -- 开始时间
AND plan_time < {endDate}; -- 结束时间
```


```sql
SELECT   
f.frequency_code frequencyCode,  
    f.frequency_split_type frequencySplitType,  
    f.frequency_split_rule frequencySplitRule,  
    o.start_date_time startDateTime,  
    o.stop_date_time stopDateTime,  
    o.inhos_code inhosCode,  
    o.order_class_code orderClassCode,  
    o.order_group_no orderGroupNo,  
    o.administration_code administrationCode,  
    o.repeat_indicator repeatIndicator,  
    o.firstday_times firstdayTimes,  
    o.lastday_times lastdayTimes  
FROM pat_inhos_order_frequency f  
INNER JOIN pat_inhos_order o ON f.frequency_code=o.frequency_code  
WHERE o.start_date_time < {endDate} -- 结束时间
AND (o.stop_date_time IS NULL OR o.stop_date_time > {beginDate} -- 开始时间
AND o.order_status != '4'  
AND o.inhos_code in {inhosCodes} -- 患者号列表  
AND o.order_class_code in {orderClassCodes} -- 医嘱类别  
AND o.repeat_indicator = {repeatIndicator}; -- 1.长期医嘱 0.临时医嘱
```

# 参考资料

http://10.2.3.159:8090/pages/viewpage.action?pageId=87360684