
# 配置

## 出入量统计时间配置

配置路径：<font color="#9bbb59">配置中心 - 业务配置 - 移动护理 - 文书配置 - 出入量配置</font>
配置路径：<font color="#9bbb59">配置中心 - 业务配置 - 移动护理 - 文书配置 - 出入量汇总配置</font>

![[Pasted image 20240603172250.png|1000]]

```js
use coms
db.sysConfigFile.find()
    .where("children.key").eq("CustomizedInputOutPutFormate")
```

```json
{
	"_id" : "65095edbcf1fe2309d010608-Mon May 27 2024 17:34:14 GMT+0800",
	"key" : "CustomizedInputOutPutFormate",
	"pattern" : {
		"description" : "",
		"componentType" : "Radio",
		"label" : "自定义时间段出入量同步格式",
		"urlOptionSourceDetail" : {
			
		},
		"optionSourceDetail" : "",
		"optionSource" : "options",
		"options" : [
			{
				"sortedIndex" : 1,
				"code" : "total",
				"name" : "总量值"
			},
			{
				"sortedIndex" : 2,
				"code" : "HourMinTotal",
				"name" : "H*min+总量值"
			},
			{
				"sortedIndex" : 3,
				"code" : "HourTotal",
				"name" : "总量值/H"
			}
		]
	},
	"value" : "total"
}
```

## 出入量类型设置

配置路径：<font color="#9bbb59">实施配置 - 出入量配置</font>

![[Pasted image 20240617160040.png|1200]]

## 出入量统计设置

配置路径：<font color="#9bbb59">实施配置 - 出入量配置</font>

![[Pasted image 20240617155902.png|1600]]

```js
use mnis
db.docInOutRuleConfig.find({_id:ObjectId('62418c5a5dc6674777fdfb8b')})

// 结果
{
    "_id" : ObjectId("62418c5a5dc6674777fdfb8b"),
    "countType" : "inout",
    "statTime" : "custom",
    "statName" : "自定义时间段",
    "statRule" : "{date} 总入量：{totalIn}ml {inDetail} 总出量：{totalOut}ml {outDetail} {outCountDetail}",
    "indexRule" : NumberInt(1),
    "matchingName" : "总入量",
    "createTime" : ISODate("2022-03-28T10:22:18.466+0000"),
    "createPerson" : "1234",
    "updateTime" : ISODate("2024-05-14T10:14:17.501+0000"),
    "updatePerson" : "123",
    "_class" : "com.lachesis.windranger.doc.dbmodel.DocInOutRuleConfig"
}
```


## 使用


![[Pasted image 20240603172743.png|800]]

![[Pasted image 20240603172258.png|1600]]

```
2023-07-21 18:10-2023-07-21 18:30 0.5小时 总入量：10ml 葡萄糖：10ml 总出量：10ml 胸水：10ml 大便次数: 0次
2023-07-21 17:20-2023-07-21 20:10 3小时 总入量：10ml 葡萄糖：10ml 总出量：10ml 胸水：10ml 大便次数: 0次
```

根据下述接口，具体的显示计算规则见：com.lachesis.windranger.doc.service.impl.DocDataNurseRecordService#injectDataToExpression

## 统计方式

![[Pasted image 20240611165545.png|220]]

> [!note]- 接口请求示例
> ```json
> // GET http://10.2.3.170:86/api/windranger/docInOutRuleConfig
> 
> {
>     "totalCnt": -1,
>     "queryResult": [
>         {
>             "id": "621876a8aa91342d48bf42b6",
>             "createTime": "2022-02-25T14:26:48.261+0800",
>             "createPerson": "123",
>             "updateTime": "2024-02-29T13:01:25.851+0800",
>             "updatePerson": "123",
>             "countType": "inout",
>             "statTime": "24-07:00:01",
>             "statName": "7点记24h",
>             "statRule": "{date} 7点 记{timeRange} 总入量：{totalIn}ml {inDetail}  总出量：{totalOut}ml {outDetail}",
>             "indexRule": 4,
>             "matchingName": "总出量,尿量,引流量,总入量,脑室引流量(A)",
>             "fontColor": "#000",
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "62187abeaa91342d48bf42b9",
>             "createTime": "2022-02-25T14:44:14.499+0800",
>             "createPerson": "123",
>             "updateTime": "2024-05-14T16:33:11.380+0800",
>             "updatePerson": "123",
>             "countType": "inout",
>             "statTime": "8-07:00:01",
>             "statName": "7点记8h",
>             "statRule": "{date} 7点 记8小时 本班入量：{totalIn}ml 本班出量：{totalOut}ml",
>             "indexRule": 4,
>             "matchingName": "",
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "62187bfbaa91342d48bf42ba",
>             "createTime": "2022-02-25T14:49:31.488+0800",
>             "createPerson": "123",
>             "updateTime": "2024-05-14T16:33:07.083+0800",
>             "updatePerson": "123",
>             "countType": "inout",
>             "statTime": "8-15:00:01",
>             "statName": "15点记8h",
>             "statRule": "{date} 15点 记8小时 本班入量：{totalIn}ml 本班出量：{totalOut}ml",
>             "indexRule": 0,
>             "matchingName": null,
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "62187c41aa91342d48bf42bb",
>             "createTime": "2022-02-25T14:50:41.191+0800",
>             "createPerson": "123",
>             "updateTime": "2024-05-14T16:33:03.688+0800",
>             "updatePerson": "123",
>             "countType": "inout",
>             "statTime": "8-23:00:01",
>             "statName": "23点记8h",
>             "statRule": "{date} 23点 记8小时 本班入量：{totalIn}ml 本班出量：{totalOut}ml",
>             "indexRule": 0,
>             "matchingName": null,
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "62187c6aaa91342d48bf42bc",
>             "createTime": "2022-02-25T14:51:22.463+0800",
>             "createPerson": "123",
>             "updateTime": "2024-05-14T18:19:59.814+0800",
>             "updatePerson": "8099",
>             "countType": "inout",
>             "statTime": "12-19:00:01",
>             "statName": "19点记12h",
>             "statRule": "{date} 19点 记{timeRange}总入量：{totalIn}ml {inDetail}  总出量：{totalOut}ml {outDetail}{outCountDetail}",
>             "indexRule": 1,
>             "matchingName": null,
>             "fontColor": "#000",
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "62418c5a5dc6674777fdfb8b",
>             "createTime": "2022-03-28T18:22:18.466+0800",
>             "createPerson": "1234",
>             "updateTime": "2024-05-14T18:14:17.501+0800",
>             "updatePerson": "123",
>             "countType": "inout",
>             "statTime": "custom",
>             "statName": "自定义时间段",
>             "statRule": "{date} 总入量：{totalIn}ml {inDetail} 总出量：{totalOut}ml {outDetail} {outCountDetail}",
>             "indexRule": 1,
>             "matchingName": "总入量",
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": null
>         },
>         {
>             "id": "626071253cc9720697cca194",
>             "createTime": "2022-04-21T04:46:29.429+0800",
>             "createPerson": "lachesis",
>             "updateTime": "2024-01-09T17:28:31.119+0800",
>             "updatePerson": "123",
>             "countType": "urine",
>             "statTime": "24-07:00:01",
>             "statName": "尿量统计7h记24h",
>             "statRule": " 尿量统计 {date} 7点 记24小时  {outDetail}",
>             "indexRule": 0,
>             "matchingName": null,
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "6285bceff526860513ac1f7b",
>             "createTime": "2022-05-19T11:43:43.904+0800",
>             "createPerson": "123",
>             "updateTime": "2024-01-09T17:28:21.038+0800",
>             "updatePerson": "123",
>             "countType": "discharge",
>             "statTime": "24-07:00:01",
>             "statName": "引流量统计",
>             "statRule": "引流量统计  {date} 7点 记24小时 总出量：{totalOut}ml {outDetail}",
>             "indexRule": 1,
>             "matchingName": "总出量,脑室引流量,腹腔",
>             "fontColor": "#000",
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "62d6ad49b59c303910f404a1",
>             "createTime": "2022-07-19T21:10:33.169+0800",
>             "createPerson": "123",
>             "updateTime": "2022-08-08T22:58:11.475+0800",
>             "updatePerson": "123",
>             "countType": "urine",
>             "statTime": "custom",
>             "statName": "自定义时间段",
>             "statRule": "{date}  总出量：{totalOut}ml {outDetail}",
>             "indexRule": 0,
>             "matchingName": "尿液",
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": null
>         },
>         {
>             "id": "62e334aab59c3043f21831c0",
>             "createTime": "2022-07-29T09:15:22.000+0800",
>             "createPerson": "123",
>             "updateTime": "2024-01-09T17:20:18.172+0800",
>             "updatePerson": "123",
>             "countType": "discharge",
>             "statTime": "custom",
>             "statName": "自定义时间段",
>             "statRule": "{date} 总入量：{totalIn}ml {inDetail} 总出量：{totalOut}ml {outDetail}",
>             "indexRule": 4,
>             "matchingName": "总入量",
>             "fontColor": "#f00",
>             "visible": null,
>             "copyToTemp": null
>         },
>         {
>             "id": "659d0b1345dd724b34b82962",
>             "createTime": "2024-01-09T17:00:03.810+0800",
>             "createPerson": "123",
>             "updateTime": "2024-01-09T18:28:42.866+0800",
>             "updatePerson": "123",
>             "countType": "amountBleeding",
>             "statTime": "24-07:00:01",
>             "statName": "7点记24h",
>             "statRule": "出血量统计 {date} 7点 记24小时 {outDetail}",
>             "indexRule": 3,
>             "matchingName": "出血,流血",
>             "fontColor": "#f00",
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "659d0b3745dd724b34b82965",
>             "createTime": "2024-01-09T17:00:39.367+0800",
>             "createPerson": "123",
>             "updateTime": "2024-01-09T17:19:32.510+0800",
>             "updatePerson": "123",
>             "countType": "amountBleeding",
>             "statTime": "custom",
>             "statName": "自定义时间段",
>             "statRule": "出血量统计 {date} 总出量：{totalOut}ml {outDetail}",
>             "indexRule": 2,
>             "matchingName": "出血,流血",
>             "fontColor": "#f00",
>             "visible": null,
>             "copyToTemp": null
>         },
>         {
>             "id": "659d1cc045dd724b34b82ac6",
>             "createTime": "2024-01-09T18:15:28.298+0800",
>             "createPerson": "123",
>             "updateTime": "2024-01-09T18:16:32.972+0800",
>             "updatePerson": "123",
>             "countType": "xxx",
>             "statTime": "24-07:00:01",
>             "statName": "7点记24h",
>             "statRule": "xxx统计 {date} 7点 记24小时 {outDetail}",
>             "indexRule": 0,
>             "matchingName": null,
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": true
>         },
>         {
>             "id": "659d1cf945dd724b34b82acb",
>             "createTime": "2024-01-09T18:16:25.397+0800",
>             "createPerson": "123",
>             "updateTime": null,
>             "updatePerson": null,
>             "countType": "xxx",
>             "statTime": "custom",
>             "statName": "自定义时间段",
>             "statRule": "xxx统计 {date} 总出量：{totalOut}ml {outDetail}",
>             "indexRule": 0,
>             "matchingName": null,
>             "fontColor": null,
>             "visible": null,
>             "copyToTemp": null
>         }
>     ]
> }
> ```

* 7点记24h：startTime=2024-06-10 07:00:01&endTime=2024-06-11 07:00:01
* 23点记8h：startTime=2024-05-27 15:00:01&endTime=2024-05-27 23:00:01

## 统计

```json
// 核心接口
// POST http://10.2.3.170:86/api/windranger/doc/nursing/count

{
    "inOutVos": [                                              // 出入量明细
        {
            "inhosCode": "12295451",
            "templateCode": "T000126",
            "recordDate": "2023-07-21T18:19:00.000+0800",
            "itemCode": "P00007954",
            "itemName": "葡萄糖",
            "itemValue": "10",
            "category": "其他",
            "inoutType": "in",
            "selected": true,
            "structCode": null,
            "structTypeCode": null
        },
        {
            "inhosCode": "12295451",
            "templateCode": "T000126",
            "recordDate": "2023-07-21T18:19:00.000+0800",
            "itemCode": "P00007955",
            "itemName": "胸水",
            "itemValue": "10",
            "category": "其他",
            "inoutType": "out",
            "selected": true,
            "structCode": null,
            "structTypeCode": null
        }
    ],
    "templateCode": "T000126",
    "inhosCode": "12295451",
    "documentCode": "D00327641",
    "countType": "inout",
    "countRuleTypeId": "62418c5a5dc6674777fdfb8b",  // 统计规则
    "copyToTemp": null,
    "statTime": "custom",
    "begin": "2023-07-21 18:10:00",
    "end": "2023-07-21 18:45:00",
    "statisticsCategory": 0
}
```


* & 核心逻辑1.先生成主记录

```sql
select * from windranger_mnis.doc_data_nurse_record
where inhos_code = '12295451' -- 取自参数inhosCode
and template_code = 'T000126' -- 取自参数templateCode
and document_code = 'D00327641' -- 取自参数documentCode
and count_type = 'inout' -- 取自参数countType
and record_date = '2023-07-21 18:45:00' -- 取自参数end
order by seq_id desc;
```

| seq\_id | inhos\_code | pat\_code | ward\_code | header\_code | document\_code | template\_code | template\_name | record\_code | record\_date | inout\_count | count\_type |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 2637734 | 12295451 | 1133443 | 309 | H00316534 | D00327641 | T000126 | 复制-护理记录单 | 1797561523179229184-894857 | 2023-07-21 18:45:00 | 1 | inout |
| 2637733 | 12295451 | 1133443 | 309 | H00316534 | D00327641 | T000126 | 复制-护理记录单 | 1797561160799752192-91535 | 2023-07-21 18:45:00 | 1 | inout |

可以看到，相同的end有两次操作，所以生成了两条，record\_code每次生成时，自动生成唯一编码。这里我们取最近一次主记录。

* & 核心逻辑2.生成出入明细

```sql
select * from windranger_mnis.doc_data_nurse_inout_detail where inhos_code = '12295451' and record_code = '1797561523179229184-894857';
```

| seq\_id | record\_code | inhos\_code | item\_code | item\_name | record\_date | item\_value | create\_person | create\_time |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 226321 | 1797561523179229184-894857 | 12295451 | input | inDetail | 2023-07-21 18:10:00 | 葡萄糖：10ml  | 123 | 2024-06-03 17:30:39 |
| 226322 | 1797561523179229184-894857 | 12295451 | output | outDetail | 2023-07-21 18:10:00 | 胸水：10ml  | 123 | 2024-06-03 17:30:39 |
| 226323 | 1797561523179229184-894857 | 12295451 | output | outCountDetail | 2023-07-21 18:10:00 | 大便次数: 0次 | 123 | 2024-06-03 17:30:39 |
| 226324 | 1797561523179229184-894857 | 12295451 | input | 葡萄糖 | 2023-07-21 18:10:00 | 10 | 123 | 2024-06-03 17:30:39 |
| 226325 | 1797561523179229184-894857 | 12295451 | input | totalIn | 2023-07-21 18:10:00 | 10 | 123 | 2024-06-03 17:30:39 |
| 226326 | 1797561523179229184-894857 | 12295451 | output | 胸水 | 2023-07-21 18:10:00 | 10 | 123 | 2024-06-03 17:30:39 |
| 226327 | 1797561523179229184-894857 | 12295451 | output | totalOut | 2023-07-21 18:10:00 | 10 | 123 | 2024-06-03 17:30:39 |

* & 3.生成主记录明细

```sql
select * from windranger_mnis.doc_data_nurse_record_detail where inhos_code = '12295451' and record_code = '1797561523179229184-894857';
```

| seq\_id  | record\_code               | inhos\_code | item\_code      | item\_name | record\_date        | struct\_code | struct\_name | item\_value                                                                           |
| :------- | :------------------------- | :---------- | :-------------- | :--------- | :------------------ | :----------- | :----------- | :------------------------------------------------------------------------------------ |
| 20534063 | 1797561523179229184-894857 | 12295451    | details         | details    | 2023-07-21 18:45:00 | null         | null         | 2023-07-21 18:10-2023-07-21 18:45 0.5小时 总入量：10ml 葡萄糖：10ml  总出量：10ml 胸水：10ml  大便次数: 0次 |
| 20534064 | 1797561523179229184-894857 | 12295451    | dateTime        | 日期时间       | 2023-07-21 18:45:00 | dateTime     | 日期时间         | 2023-07-21 18:45                                                                      |
| 20534065 | 1797561523179229184-894857 | 12295451    | countRuleTypeId | 出入量规则      | 2023-07-21 18:45:00 | null         | null         | 62418c5a5dc6674777fdfb8b                                                              |
| 20534066 | 1797561523179229184-894857 | 12295451    | timeRange       | 时间范围       | 2023-07-21 18:45:00 | null         | null         | 0.5小时                                                                                 |

<font color="#f79646">item_value生成逻辑</font>

### 统计规则

生成规则由参数传递：`countRuleTypeId`

核心方法：com.lachesis.windranger.doc.service.impl.DocDataNurseRecordService#injectDataToExpression

### 生成统计描述

![[Pasted image 20240603172250.png|1000]]

![[Pasted image 20240603172258.png|1600]]

```模板
{date} 19点 记{timeRange}总入量：{totalIn}ml {inDetail}  总出量：{totalOut}ml {outDetail}{outCountDetail}
```


```
2023-07-21 18:10-2023-07-21 18:30 0.5小时 总入量：10ml 葡萄糖：10ml 总出量：10ml 胸水：10ml 大便次数: 0次
2023-07-21 17:20-2023-07-21 20:10 3小时 总入量：10ml 葡萄糖：10ml 总出量：10ml 胸水：10ml 大便次数: 0次
```

这里关注重点是时间显示规则：

* 2023-07-21 18:10-2023-07-21 18:30，为什么等于0.5小时？
* 2023-07-21 17:20-2023-07-21 20:10，为什么等于3小时？

核心计算逻辑：com.lachesis.windranger.doc.service.impl.DocDataNurseRecordService#calTimeRange

# 体征同步

```json
// GET http://10.2.3.170:86/api/windranger/doc/nursing/inout/detail?
inhosCode=99548448&
documentCode=D00332026&
headerCode=H00320114&
recordCode=1800456796587036672-635202

{
    "inoutDetailVos": [
        {
            "inoutType": "output",
            "itemName": "尿液(9)",
            "itemValue": "22"
        },
        {
            "inoutType": "output",
            "itemName": "小便（ml）",
            "itemValue": "11"
        }
    ],
    "wardCode": "309",
    "inhosCode": "99548448",
    "patCode": "9932021",
    "signDate": "2024-05-26",
    "countType": "inout"
}
```


```json
// POST http://10.2.3.170:86/api/windranger/nurse/patientVitalSign/inout/copy/valid

{
  "inoutDetailVos": [
    {
      "inoutType": "output",
      "itemName": "尿液(9)",
      "itemValue": "22"
    },
    {
      "inoutType": "output",
      "itemName": "小便（ml）",
      "itemValue": "11"
    }
  ],
  "wardCode": "309",
  "inhosCode": "99548448",
  "patCode": "9932021",
  "signDate": "2024-05-26",  // 需要同步到的体温单日期
  "countType": "inout"
}
```

  
```json
// POST http://10.2.3.170:86/api/windranger/nurse/patientVitalSign/inout/copy

{
  "inoutDetailVos": [
    {
      "inoutType": "output",
      "itemName": "尿液(9)",
      "itemValue": "22"
    },
    {
      "inoutType": "output",
      "itemName": "小便（ml）",
      "itemValue": "11"
    }
  ],
  "wardCode": "309",
  "inhosCode": "99548448",
  "patCode": "9932021",
  "signDate": "2024-05-26",  // 需要同步到的体温单日期
  "countType": "inout"
}
```