# 1.CR

>Java群

项目: mnis  
内容: 8076【益阳市中心医院】风险评估单数据与卫宁对接
分支: feat_release_mnis_v3.8_wpb_8076 into qa_mnis_v3.8
MR: http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/5294

# 2.脚本

>邮件

```ad-error
注意提供脚本为实际<font color="#9bbb59">上线脚本</font>！

注意配置相关的默认值
 1. 开关，默认应为关闭
 2. IP地址，默认应为127.0.0.1
```

---

宝哥麻烦归档下脚本：

测试环境：10.2.3.170
项目：mnis
服务：mnis
冲刺版本：移动护理迭代44
故事编号：8076
版本号：MNIS V3.8.98
分支：feat_release_mnis_v3.8_wpb_8076

MySQL脚本

```sql
-- 无
```


```ad-error
注意脚本后不要带 `;` ~
```

MongDB脚本

```js
use coms
db.sysConfigFile.update({ 'key': 'sendBackConfig' }, { "$pull": { 'children': { 'key': 'evaluateDataPatOut' } } })
db.sysConfigFile.update({ 'key': 'sendBackConfig' }, {
    "$push": {
        "children":
            {
                "_id": "8313f9a8cc624d6cbceb0fb12c21a72f",
                "wardCode": "",
                "key": "evaluateDataPatOut",
                "pattern": {
                    "componentType": "Checkbox",
                    "label": "患者出院时护理评估单回写-evaluateDataPatOut"
                },
                "value": false
            }
    }
})


db.sysConfigFile.update({ 'key': 'sendSyncBackConfig' }, { "$pull": { 'children': { 'key': 'EVALUATE_DATA_PAT_OUT_SEND_DATA_LIST' } } })
db.sysConfigFile.update({ 'key': 'sendSyncBackConfig' }, {
    "$push": {
        "children":
        {
            "_id" : "17156580829193",
            "wardCode" : "",
            "key" : "EVALUATE_DATA_PAT_OUT_SEND_DATA_LIST",
            "pattern" : {
                "componentType" : "AddableTable",
                "label" : "患者出院时护理评估单回写-配置列表",
                "optionKeyAttrs" : [
                    {
                        "sortedIndex" : NumberInt(1),
                        "key" : "msgType",
                        "mapping" : "name",
                        "componentType" : "Input",
                        "editable" : true,
                        "display" : true,
                        "prefix" : "回写类型"
                    },
                    {
                        "sortedIndex" : NumberInt(2),
                        "key" : "templateCode",
                        "mapping" : "name",
                        "componentType" : "Input",
                        "editable" : true,
                        "display" : true,
                        "prefix" : "文书模板编号",
                        "defaultValue" : ""
                    },
                    {
                        "sortedIndex" : NumberInt(3),
                        "key" : "enable",
                        "mapping" : "name",
                        "componentType" : "Input",
                        "editable" : true,
                        "display" : true,
                        "prefix" : "是否开启",
                        "defaultValue" : "false"
                    },
                    {
                        "sortedIndex" : NumberInt(4),
                        "key" : "responseParser",
                        "mapping" : "name",
                        "componentType" : "Input",
                        "editable" : true,
                        "display" : true,
                        "prefix" : "响应结果解析组件名",
                        "defaultValue" : ""
                    },
                    {
                        "sortedIndex" : NumberInt(5),
                        "key" : "url",
                        "mapping" : "name",
                        "componentType" : "Input",
                        "editable" : true,
                        "display" : true,
                        "prefix" : "回写地址"
                    }
                ]
            },
            "value" : [
                {
                    "sortedIndex" : NumberInt(1),
                    "msgType" : "evaluateDataPatOut",
                    "templateCode" : "",
                    "responseParser" : "",
                    "url" : "http://127.0.0.1:9110/data-sync-executor/api2/receiveMessage"
                }
            ]
        }
    }
})
```

# 3.提测单

>提测群

http://10.2.3.109:1024/zentao/testtask-view-7741.html
8076【益阳市中心医院】风险评估单数据与卫宁对接 --- 已提测
# 4.其它


1. 数据需不需要加工？可以不加工，由同步程序侧加工处理~
2. 操作类型
	1. 数据页：新增、删除
	2. 数据页明细：新增、更新、删除

## 新增

```json
// POST
// http://172.16.20.17:8732/ws/NRMService/SavePatientNmrData?syxh=1294&yexh=0&bldm=7CA75D75-F2D9-4E90-9CCE-E815EFD90EA5&bllx=3

// 转换下格式后如下

// http://172.16.20.17:8732/ws/NRMService/SavePatientNmrData?
// syxh=1294&
// yexh=0&
// bldm=7CA75D75-F2D9-4E90-9CCE-E815EFD90EA5&
// bllx=3

// 请求体
{
    "WSNursingAdviceRule": null,
    "czyh": "wn3",
    "czym": "cs3",
    "data": "{  \"QT_NursingInterventionText\": \"&amp;amp;\",  \"QT_SelfCareAbility.TotalScores\": 0.0,  \"QT_AssessmentResult\": \"重度依赖\",  \"MX_1688\": \"1\",  \"MX_1691\": \"1\",  \"MX_1694\": \"1\",  \"MX_1698\": \"1\",  \"MX_1702\": \"1\",  \"MX_1706\": \"1\",  \"MX_1710\": \"1\",  \"MX_1715\": \"1\",  \"MX_1720\": \"1\",  \"MX_1724\": \"1\",  \"CS_81\": \"1\",  \"QT_QM\": \"{\\\"LRCZYH\\\":\\\"wn3\\\",\\\"LRCZYM\\\":\\\"cs3\\\",\\\"LRSJ\\\":\\\"2023111315:23:02\\\",\\\"SHCZYH\\\":null,\\\"SHCZYM\\\":null,\\\"SHSJ\\\":null,\\\"SJSHSJ\\\":null}\",  \"QT_EvTime\": \"2023111315:23:02\"}",
    "generateDate": "2023111315:23:02",
    "hlcskbldata": "{}",
    "jlsj": "2023111315:23:23",
    "kbldata": "{}",
    "mxdata": null,
    "mxxh": 0,
    "ruledata": null,
    "saveSj": null,
    "xh": -1,
    "ymjh": [
    ],
    "ymxh": 0
}

// 响应

```

移动护理数据

```json
{
    "documentCode": "D00331279",
    "showTextValue": {
        "P00025870": "",
        "P00025871": "",
        "P00025858": "√",
        "P00025837": "需部分帮助",
        "P00025859": "√",
        "P00025838": "需部分帮助",
        "P00025839": "完全独立",
        "P00025850": "",
        "P00025872": "",
        "P00025851": "",
        "P00025873": "",
        "P00025852": "√",
        "P00025874": "",
        "P00025853": "√",
        "P00025875": "",
        "P00025854": "√",
        "P00025876": "",
        "P00025833": "需部分帮助",
        "P00025855": "√",
        "P00025877": "",
        "P00025856": "√",
        "P00025835": "需部分帮助",
        "P00025857": "√",
        "P00025860": "√",
        "P00025847": "@txt_123_李",
        "P00025869": "",
        "P00025826": "2024-06-04",
        "P00025848": "",
        "P00025849": "",
        "P00025829": "14:26",
        "P00025861": "√",
        "P00025840": "完全独立 ",
        "P00025862": "",
        "P00025841": "完全独立 ",
        "P00025863": "",
        "P00025842": "完全独立  ",
        "P00025864": "",
        "P00025843": "完全独立  ",
        "P00025865": "",
        "P00025844": "完全独立  ",
        "P00025866": "",
        "P00025845": "80",
        "P00025867": "",
        "P00025846": "轻度依赖",
        "P00025868": ""
    },
    "rowValue": {
        "P00025870": "",
        "P00025871": "",
        "P00025858": "1",
        "P00025837": "P00025860",
        "P00025859": "1",
        "P00025838": "P00025861",
        "P00025839": "P00025852",
        "P00025850": "",
        "P00025872": "",
        "P00025851": "",
        "P00025873": "",
        "P00025852": "1",
        "P00025874": "",
        "P00025853": "1",
        "P00025875": "",
        "P00025854": "1",
        "P00025876": "",
        "P00025833": "P00025858",
        "P00025855": "1",
        "P00025877": "",
        "P00025856": "1",
        "P00025835": "P00025859",
        "P00025857": "1",
        "P00025860": "1",
        "P00025847": "@txt_123_李",
        "P00025869": "",
        "P00025826": "2024-06-04",
        "P00025848": "",
        "P00025849": "",
        "P00025829": "14:26",
        "P00025861": "1",
        "P00025840": "P00025853",
        "P00025862": "",
        "P00025841": "P00025854",
        "P00025863": "",
        "P00025842": "P00025855",
        "P00025864": "",
        "P00025843": "P00025856",
        "P00025865": "",
        "P00025844": "P00025857",
        "P00025866": "",
        "P00025845": "80",
        "P00025867": "",
        "P00025846": "01",
        "P00025868": ""
    },
    "templateCode": "T001241",
    "headerCode": "H00319755",
    "inhosCode": "10323462",
    "patCode": "1035406",
    "evaluateNature": "selfCare",
    "templateName": "自理能力评估单",
    "pageNo": 0,
    "wardCode": "309"
}
```


```json
{
    "WSNursingAdviceRule": null,
    "czyh": "wn3",
    "czym": "cs3",
    "data": {
        "QT_NursingInterventionText": "&amp;amp;",
        "QT_SelfCareAbility.TotalScores": 0,    // 总分 P00025845
        "QT_AssessmentResult": "重度依赖",       // 自理能力等级 P00025846
        "MX_1688": "1",                         // 进食 P00025833
        "MX_1691": "1",                         // 洗澡 P00025835
        "MX_1694": "1",                         // 修饰 P00025837
        "MX_1698": "1",                         // 穿衣 P00025838
        "MX_1702": "1",                         // 控制大便 P00025839
        "MX_1706": "1",                         // 控制小便 P00025840
        "MX_1710": "1",                         // 如厕 P00025841
        "MX_1715": "1",                         // 床椅转移 P00025842
        "MX_1720": "1",                         // 平地行走 P00025843
        "MX_1724": "1",                         // 上下楼梯 P00025844
        "CS_81": "1",                           // 
        "QT_QM": {                              // 评估分数以及结果
            "LRCZYH": "wn3",
            "LRCZYM": "cs3",
            "LRSJ": "2023111315:23:02",
            "SHCZYH": null,
            "SHCZYM": null,
            "SHSJ": null,
            "SJSHSJ": null
        },
        "QT_EvTime": "2023111315:23:02"         // 评估时间
    },
    "generateDate": "2023111315:23:02",
    "hlcskbldata": "{}",
    "jlsj": "2023111315:23:23",
    "kbldata": "{}",
    "mxdata": null,
    "mxxh": 0,
    "ruledata": null,
    "saveSj": null,
    "xh": -1,     // -1表示新增，非-1表示更新
    "ymjh": [
    ],
    "ymxh": 0
}
```


规则

|      | 完全独立    | 需部分帮助   | 需极大帮助   | 完全依赖    | 对应项       | 线上        |     |
| ---- | ------- | ------- | ------- | ------- | --------- | --------- | --- |
| 进食   | MX_1686 | MX_1687 | MX_1688 |         | P00025833 | P00000220 |     |
| 洗澡   | MX_1690 | MX_1691 |         |         | P00025835 | P00000221 |     |
| 修饰   | MX_1693 | MX_1694 |         |         | P00025837 | P00000222 |     |
| 穿衣   | MX_1696 | MX_1697 | MX_1698 |         | P00025838 | P00000230 |     |
| 控制大便 | MX_1700 | MX_1701 | MX_1702 |         | P00025839 | P00000234 |     |
| 控制小便 | MX_1704 | MX_1705 | MX_1706 |         | P00025840 | P00000238 |     |
| 如厕   | MX_1708 | MX_1709 | MX_1710 |         | P00025841 | P00000242 |     |
| 床椅转移 | MX_1712 | MX_1713 | MX_1714 | MX_1715 | P00025842 | P00000246 |     |
| 平地行走 | MX_1717 | MX_1718 | MX_1719 | MX_1720 | P00025843 | P00000251 |     |
| 上下楼梯 | MX_1722 | MX_1723 | MX_1724 |         | P00025844 | P00000256 |     |


```sql
-- 查询结构
select * from windranger_mnis.doc_template_item 
where item_code in ('P00025845','P00025846','P00025833','P00025835','P00025837','P00025838','P00025839','P00025840','P00025841','P00025842','P00025842','P00025843','P00025844')
order by field(item_code, 'P00025845','P00025846','P00025833','P00025835','P00025837','P00025838','P00025839','P00025840','P00025841','P00025842','P00025842','P00025843','P00025844');
-- 查询数据
select * from windranger_mnis.doc_data_evaluate_record_detail 
where item_code in ('P00025845','P00025846','P00025833','P00025835','P00025837','P00025838','P00025839','P00025840','P00025841','P00025842','P00025842','P00025843','P00025844')
order by field(item_code, 'P00025845','P00025846','P00025833','P00025835','P00025837','P00025838','P00025839','P00025840','P00025841','P00025842','P00025842','P00025843','P00025844');
```

## 查询

```json
// GET http://172.16.20.17:8732/ws/NRMService/GetPatientNmrData?syxh=14406&yexh=0&bldm=6D95A5BD-230D-4951-ABED-57A42DFD5C09&bllx=3

// 响应
<string xmlns="http://schemas.microsoft.com/2003/10/Serialization/">{
    "msg": "获取成功!",
    "obj": [
        {
            "WSNursingAdviceRule": null,
            "czyh": "7210",
            "czym": "曹薇",
            "data": "{  \"QT_ChokeRisk.TotalScores\": 20.0,  \"QT_AssessmentResult\": \"低危\",  \"MX_1948\": \"1\",  \"MX_1951\": \"1\",  \"MX_1954\": \"1\",  \"MX_1959\": \"1\",  \"MX_1961\": \"1\",  \"MX_1965\": \"1\",  \"QT_QM\": \"{\\\"LRCZYH\\\":\\\"7210\\\",\\\"LRCZYM\\\":\\\"曹薇\\\",\\\"LRSJ\\\":\\\"2023082922:30:08\\\",\\\"SHCZYH\\\":null,\\\"SHCZYM\\\":null,\\\"SHSJ\\\":null,\\\"SJSHSJ\\\":null}\",  \"QT_EvTime\": \"2023082922:30:08\"}",
            "generateDate": "2023082922:30:08",
            "hlcskbldata": "{}",
            "jlsj": "2023082923:28:39",
            "kbldata": "{}",
            "mxdata": null,
            "mxxh": 0,
            "ruledata": null,
            "saveSj": null,
            "xh": 50916,
            "ymjh": [],
            "ymxh": 0
        }
    ],
    "success": true
}</string>
```

## 修改

>与新增接口是相同的，只是请求体中xh参数值不同，xh=-1表示新增，xh=85659表示更新~

```json
// POS
// http://172.16.20.17:8732/ws/NRMService/SavePatientNmrData?syxh=1294&yexh=0&bldm=7CA75D75-F2D9-4E90-9CCE-E815EFD90EA5&bllx=3

// 转换下格式后如下

// http://172.16.20.17:8732/ws/NRMService/SavePatientNmrData?
// syxh=1294&
// yexh=0&
// bldm=7CA75D75-F2D9-4E90-9CCE-E815EFD90EA5&
// bllx=3

{
    "WSNursingAdviceRule": null,
    "czyh": "wn3",
    "czym": "cs3",
    "data": "{  \"QT_NursingInterventionText\": \"&amp;amp;\",  \"QT_SelfCareAbility.TotalScores\": 0.0,  \"QT_AssessmentResult\": \"重度依赖\",  \"MX_1688\": \"1\",  \"MX_1691\": \"1\",  \"MX_1694\": \"1\",  \"MX_1698\": \"1\",  \"MX_1702\": \"1\",  \"MX_1706\": \"1\",  \"MX_1710\": \"1\",  \"MX_1715\": \"1\",  \"MX_1720\": \"1\",  \"MX_1724\": \"1\",  \"CS_81\": \"1\",  \"QT_QM\": \"{\\\"LRCZYH\\\":\\\"wn3\\\",\\\"LRCZYM\\\":\\\"cs3\\\",\\\"LRSJ\\\":\\\"2023111315:23:02\\\",\\\"SHCZYH\\\":null,\\\"SHCZYM\\\":null,\\\"SHSJ\\\":null,\\\"SJSHSJ\\\":null}\",  \"QT_EvTime\": \"2023111315:23:02\"}",
    "generateDate": "2023111315:23:02",
    "hlcskbldata": "{}",
    "jlsj": "2023111315:23:23",
    "kbldata": "{}",
    "mxdata": null,
    "mxxh": 0,
    "ruledata": null,
    "saveSj": null,
    "xh": 85659,
    "ymjh": [],
    "ymxh": 0
}
```


```json
{
    "WSNursingAdviceRule": null,
    "czyh": "wn3",
    "czym": "cs3",
    "data": {
        "QT_NursingInterventionText": "&amp;amp;",
        "QT_SelfCareAbility.TotalScores": 0,
        "QT_AssessmentResult": "重度依赖",
        "MX_1688": "1",
        "MX_1691": "1",
        "MX_1694": "1",
        "MX_1698": "1",
        "MX_1702": "1",
        "MX_1706": "1",
        "MX_1710": "1",
        "MX_1715": "1",
        "MX_1720": "1",
        "MX_1724": "1",
        "CS_81": "1",
        "QT_QM": {
            "LRCZYH": "wn3",
            "LRCZYM": "cs3",
            "LRSJ": "2023111315:23:02",
            "SHCZYH": null,
            "SHCZYM": null,
            "SHSJ": null,
            "SJSHSJ": null
        },
        "QT_EvTime": "2023111315:23:02"
    },
    "generateDate": "2023111315:23:02",
    "hlcskbldata": "{}",
    "jlsj": "2023111315:23:23",
    "kbldata": "{}",
    "mxdata": null,
    "mxxh": 0,
    "ruledata": null,
    "saveSj": null,
    "xh": 85659,     // -1表示新增，85659表示更新
    "ymjh": [
    ],
    "ymxh": 0
}
```
## 删除

```json
// GET http://172.16.20.17:8732/ws/NRMService/DeletePatientNmrData?syxh=1294&yexh=0&bldm=7CA75D75-F2D9-4E90-9CCE-E815EFD90EA5&bllx=3&xh=85658&mxxh=0&czyh=wn3&czym=cs3&jlsj=2023111311:08:12

// 转换下格式后如下

// http://172.16.20.17:8732/ws/NRMService/DeletePatientNmrData?
// syxh=1294&
// yexh=0&
// bldm=7CA75D75-F2D9-4E90-9CCE-E815EFD90EA5&
// bllx=3&
// xh=85658&
// mxxh=0&
// czyh=wn3&
// czym=cs3&
// jlsj=2023111311:08:12


// 响应
<string xmlns="http://schemas.microsoft.com/2003/10/Serialization/">{
    "msg": "删除数据成功!",
    "obj": "",
    "success": true
}</string>
```

