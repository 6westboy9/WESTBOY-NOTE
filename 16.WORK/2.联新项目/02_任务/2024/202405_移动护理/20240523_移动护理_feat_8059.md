## 1.CR

>Java群

项目: mnis  
内容: 8059【烟台市口腔医院】皮试医嘱需要添加备药，备药核查，配药流程
分支: feat_release_mnis_v3.8_wpb_8059 into qa_mnis_v3.8
MR: http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/5238

项目: emr  
内容: 8059【烟台市口腔医院】皮试医嘱需要添加备药，备药核查，配药流程
分支: feat_release_mnis_v3.8_wpb_8059 into qa_mnis_v3.8
MR: http://10.2.3.111:86/backend_group/backend_application/emr/merge_requests/2486


# 2.脚本

>邮件

```ad-error
注意提供脚本为实际<font color="#9bbb59">上线脚本</font>！

注意配置相关的默认值
 1. 开关，默认应为关闭
 2. IP地址，默认应为127.0.0.1
```

---

宝哥麻烦归档下脚本：

MySQL脚本

测试环境：10.2.3.170
项目：emr
冲刺版本：移动护理迭代44
故事编号：8059
版本号：MNIS V3.8.98
分支：feat_release_mnis_v3.8_wpb_8059

```sql
use windranger_emr;
alter table pat_order_usage_config modify usage_code varchar(50) not null comment '用法编号';
```

测试环境：10.2.3.170
项目：foundation
冲刺版本：移动护理迭代44
故事编号：8059
版本号：MNIS V3.8.98
分支：feat_master_wpb_8059

```sql
use windranger_foundation;
-- 字典新增用法组
delete from sys_dic where dic_code = 'SKINTEST_MEDICINE_PREPARE';
insert into sys_dic (dic_code, dic_name, dic_type, dic_type_name, description, owner, abbreviation, create_time, create_person, update_time, update_person)
values  ('SKINTEST_MEDICINE_PREPARE', '皮试(备药)', 'orderType', '用法组', '用法组', '123', null, '2024-05-28 10:04:28', '123', '2024-05-28 10:04:42', '123');

-- 统计报表相关
delete from sys_config where CONFIG_CODE = 'dispenseOrderType';
insert into sys_config (CONFIG_CODE, config_value, status, config_desc, app_resource_id, config_type, config_type_range, config_default_value, owner, create_time, create_person, update_time, update_person, config_owner)
values  ('dispenseOrderType', 'INFUSION,ATOMIZING,INJECT,INFUSION_OTHER,ORAL,SKINTEST,SKINTEST_MEDICINE_PREPARE', '01', '需要启动配药流程的医嘱类型', 'app-platform', '0', null, 'INFUSION,ORAL,INJECT,IN_INJECT,IV_INJECT', 'admin', '2017-06-07 19:38:54', 'admin', '2024-05-28 13:59:23', '123', null);
```

```ad-error
注意脚本后不要带 `;` ~
```

MongDB脚本

```js
use mnis

// 统计报表规则配置
var cursor = db.mnisReportConfig.find({});
while (cursor.hasNext()) {
    var reportConfig = cursor.next();
    if (!reportConfig || !reportConfig.orderExecuteConfig) {
        break;
    }

    var orderExecTypes = reportConfig.orderExecuteConfig.orderExecTypes;
    var exists = false;
    orderExecTypes.forEach(function (type) {
        if (type.dicCode === "SKINTEST_MEDICINE_PREPARE") {
            exists = true;
        }
    })
    
    printjson(orderExecTypes);
    print("是否存在:" + exists);

    if (!exists) {
        var newItem = {
            "primaryKey": 287017,
            "seqId": 287017,
            "dicCode": "SKINTEST_MEDICINE_PREPARE",
            "dicName": "皮试(备药)",
            "dicType": "orderType",
            "dicTypeName": "用法组",
            "description": null,
            "owner": "admin",
            "abbreviation": "用法",
            "createTime": "2024-04-02T16:34:24.000+0800",
            "createPerson": "123",
            "updateTime": null,
            "updatePerson": null,
            "visible": true,
            "checked": true
        }
        orderExecTypes.push(newItem);
        print("新增元素");
        db.mnisReportConfig.save(reportConfig);
    }
}

// 新增皮试(备药)流程
db.getCollection("orderProcessTpl").deleteOne({"processType": "skinTestMedicinePrepare"})
db.getCollection("orderProcessTpl").insertOne({
    "processType": "skinTestMedicinePrepare",
    "processName": "皮试(备药)",
    "sortNo": 10,
    "processNodes": [
        {
            "nodeKey": "medicine_prepare",
            "nodeName": "备药",
            "doubleCheck": false,
            "remindOpen": false,
            "personCheck": false
        },
        {
            "nodeKey": "medicine_check",
            "nodeName": "备药审核",
            "doubleCheck": false,
            "remindOpen": false,
            "personCheck": false
        },
        {
            "nodeKey": "dispensing",
            "nodeName": "配药",
            "doubleCheck": false,
            "remindOpen": false,
            "personCheck": false
        },
        {
            "nodeKey": "dispensing_check",
            "nodeName": "配药审核",
            "doubleCheck": false,
            "remindOpen": false,
            "personCheck": false
        },
        {
            "nodeKey": "skinTest_execute",
            "nodeName": "皮试执行",
            "doubleCheck": true,
            "remindOpen": false
        },
        {
            "nodeKey": "skinTest_input",
            "nodeName": "皮试结果录入",
            "doubleCheck": true,
            "remindOpen": false
        }
    ],
    "current": true,
    "_class": "com.lachesis.windranger.mnis.dbmodel.order.OrderProcessTpl"
})
```

<font color="#c0504d">后面根据用法组可以判断之后，就不需要了下面的脚本了，暂时留作记录~~</font>

```js
use coms

// 新增配置，这个配置仅限于PDA端使用，当是皮试时，PDA扫码返回对应的执行流程
db.sysConfigFile.update({ 'key': 'orderExecutionConfig' }, { "$pull": { 'children': { 'key': 'enableSkinTestMedicinePrepare' } } })
db.sysConfigFile.update({ 'key': 'orderExecutionConfig' }, {
    "$push": {
        "children":
            {
			"_id" : "65095ee1cf1fe2309d010848-Thu May 23 2024 13:17:45 GMT+0800",
			"wardCode" : "",
			"key" : "enableSkinTestMedicinePrepare",
			"pattern" : {
				"componentType" : "Switch",
				"label" : "是否启用皮试（备配药）流程"
			},
			"value" : false
		}
    }
})
```

# 3.提测单

>提测群

http://10.2.3.109:1024/zentao/testtask-view-7664.html
8059【烟台市口腔医院】皮试医嘱需要添加备药，备药核查，配药流程 --- 已提测

# 4.其它

修改需回归关联其它功能测试：
* 接口：/stat/refresh  --- 重新统计，供实施|测试人员使用
* 接口：/stat/export2  --- 导出单个病区Excel-统计执行率(供实施|测试人员使用)
* 定时任务：统计医嘱执行率
	* cron配置key：stat.order.execRate

护计单医嘱执行时间展示最后一个，其它的所见即所得