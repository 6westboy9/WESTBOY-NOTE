# 1.CR

>Java群

项目：mnis  
内容：8904【山东省妇幼保健院】统计报表-科室统计-病房巡视，按照统计报表配置设置巡视时间上下限之后数据统计计算有误
分支：feat_release_mnis_v3.8_wpb_8904_01 into qa_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/5929

项目：emr  
内容：8904【山东省妇幼保健院】统计报表-科室统计-病房巡视，按照统计报表配置设置巡视时间上下限之后数据统计计算有误
分支：feat_release_mnis_v3.8_wpb_8904 into qa_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/emr/merge_requests/2643

# 2.脚本

>邮件

> [!danger] 注意事项
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况
> 1.开关，默认应为关闭（根据实际情况而定）
> 2.IP地址，默认应为127.0.0.1（一般情况）

---

宝哥麻烦归档下脚本：

测试环境：10.2.3.170
项目：mnis
服务：mnis
冲刺版本：移动护理迭代53
问题单号：8904
版本号：[MNIS V3.8.116](http://10.2.3.109:1024/zentao/build-view-6135.html "MNIS V3.8.116")
分支：feat_release_mnis_v3.8_wpb_8904_01

MySQL脚本

```sql

```

> [!danger] 注意事项
> 脚本后不要带 `;` ~

MongDB脚本

```js
use coms
var config = db.sysConfigFile.findOne({ key: 'patrolConfig' })
var children = config.children
for (var i = 0; i < children.length; i++) {
    if ("planPatrolTimeShowRule" === (children[i].key)) {
        children[i].pattern.description = '0.按医嘱开立时间；1.按整点时间'
        children[i].pattern.options[0].name = '按医嘱开立时间'
        printjson(config)
    }
}

db.sysConfigFile.save(config)
```

# 3.提测单

>提测群

8904【山东省妇幼保健院】统计报表-科室统计-病房巡视，按照统计报表配置设置巡视时间上下限之后数据统计计算有误
http://10.2.3.109:1024/zentao/testtask-view-8497.html - 已提测


初期开发估时：40h，实际耗时64h（不包括周内加班）

* 护理信息与巡视任务维护
	* 初始化护理信息和巡视任务
		* 项目启动时（初始化后不会重复初始化）
		* 患者入院
	* 更新护理巡视任务 => 护理巡视任务变更触发事件有以下情况（除了同步程序的事件，还需要考虑移动护理自身产生的事件）
		* 定时续期
		* 护理巡视配置变更
		* 患者出院：结束护理信息和巡视任务
		* 患者转入：新增护理信息和巡视任务
		* 患者转出：结束护理信息和巡视任务
* 巡视任务执行
	* 病房巡视列表-新增巡视记录：`POST` `/WRMSMnis/mnis/NursePatrols`
	* 输血医嘱执行（前提：开启转抄病房巡视）
	* 输血前巡视录入数据（前提：开启转抄病房巡视）
	* 输液医嘱巡视（前提：开启转抄病房巡视）
	* 更新巡视记录：`PUT` `/WRMSMnis/mnis/NursePatrols`
	* 按房间批量执行患者巡视：`POST` `/NursePatrols/ward/{wardCode}/room/{roomNo}`
* 巡视任务计划时间显示
	* 病房巡视列表：`/WRMSMnis/mnis/NursePatrolsByLevel`
		* 特级：特级显示文字
		* 一二三级：显示时间
	* 按房间批量执行患者巡视：`/NursePatrols/ward/{wardCode}/room/{roomNo}`
* 巡视任务统计
	* 定时统计（待测试）
	* 统计查询 `GET` `/mnis/report/nursePatrol`
	* 统计导出

后期测试期间需求规则重新明确开发与测试问题解决耗时：83h

生成护理信息和巡视任务

* 初始化护理信息和巡视任务
	* <font color="#00b050">需求变更</font>：初始化当天患者护理医嘱 → 存量数据查找患者最近一条护理医嘱（范围初步确定为1年） --- 开发补充
	* <font color="#ffc000">需求新增</font>：病房巡视时，将范围扩到到所有 --- 开发补充
	* <font color="#ffc000">需求新增</font>：转科患者护理信息继承（逻辑关系复杂） --- 测试补充
* 巡视任务配置变更 → 更新护理信息和巡视任务
	* <font color="#00b050">需求变更</font>：生成时间范围逻辑规则变更 --- 测试补充
* 继承科室配置变更 → 更新护理信息和巡视任务（逻辑关系复杂）（<font color="#ffc000">整个都属于新增</font>） --- 测试补充
* 医嘱作废 → 更新护理信息和巡视任务（<font color="#ffc000">整个都属于新增</font>）--- 测试补充

执行巡视

* <font color="#00b050">需求变更</font>：原有护理级别查询逻辑存在问题 --- 测试补充

巡视统计

* 统计规则变更 --- 测试补充

# 4.其它


* 巡视任务生成
	* 护理信息与巡视任务维护
		* <font color="#9bbb59">功能点</font>
			* 初始化护理信息和巡视任务
				* 项目启动时（初始化后不会重复初始化）
				* 患者入院
			* 更新护理巡视任务 => 护理巡视任务变更触发事件有以下情况（除了同步程序的事件，还需要考虑移动护理自身产生的事件）
				* 护理医嘱变更
					* 新增护理医嘱
					* 更新护理医嘱
					* 作废护理医嘱（<font color="#ffc000">TODO</font>）
				* 定时续期
				* 护理巡视配置变更
				* 患者出院：结束护理信息和巡视任务
				* 患者转入：新增护理信息和巡视任务
				* 患者转出：结束护理信息和巡视任务
		* <font color="#9bbb59">测试场景</font>
			* 患者没有护理医嘱 → 无巡视任务
			* 患者存量护理医嘱 → 无巡视任务
				* 病房巡视列表也展示时间，按照<font color="#c0504d">旧逻辑</font>展示（见巡视任务计划时间显示部分）
			* 患者新增护理医嘱 → 会生成巡视任务
				* 病房巡视列表也展示时间，按照<font color="#c0504d">新逻辑</font>展示
				* 护理医嘱变更 → 护理信息变更 → 重新生成巡视任务
				* 定时续期
					* 新增未来24小时巡视任务
					* 滚动新增，今天新增明天的，明天新增后天的...
				* 护理巡视配置变更
					* 重新生成巡视任务
				* 患者出院
					* 结束当前患者科室的巡视任务
				* 患者转科
					* 结束转科前的巡视任务
					* 新增转科后的巡视任务
* 巡视任务执行
	* 病房巡视列表-新增巡视记录：`POST` `/WRMSMnis/mnis/NursePatrols`
	* 输血医嘱执行（前提：开启转抄病房巡视）
	* 输血前巡视录入数据（前提：开启转抄病房巡视）
	* 输液医嘱巡视（前提：开启转抄病房巡视）
	* 更新巡视记录：`PUT` `/WRMSMnis/mnis/NursePatrols`
	* 按房间批量执行患者巡视：`POST` `/NursePatrols/ward/{wardCode}/room/{roomNo}`
* 巡视任务计划时间显示
	* 病房巡视列表：`/WRMSMnis/mnis/NursePatrolsByLevel`
		* 特级：特级显示文字
		* 一二三级：显示时间
	* 按房间批量执行患者巡视：`/NursePatrols/ward/{wardCode}/room/{roomNo}`
* 巡视任务统计
	* 定时统计（待测试）
	* 统计查询 `GET` `/mnis/report/nursePatrol`
	* 统计导出
* <font color="#c0504d">TODO</font>
	* 测试注意事项
		* <font color="#ffc000">时间边界问题</font>
	* 性能问题
		* 补充索引
	* <font color="#ffc000">补充MongoDB脚本</font>

```js
http://10.2.3.170:10000/api/windranger/mnis/report/nursePatrol?
beginDate=2024-10-17
&endDate=2024-10-17
&execTypeCodes=00:00-07:00,08:00-17:00,17:00-23:59,07:00-08:00
&timeInterval=00:00-07:00,08:00-17:00,17:00-23:59,07:00-08:00
&isCountAll=1
&wardCodes=239,303,308,309,310,3101,311,312,313,3131,314,315,316,317,318,322,324,3241,325,326,328,331,340,341,342,343,344,345,346,348,8028,998
&nurseLevel=1
&num=-1
&offset=-1

http://10.2.3.170:86/api/windranger/mnis/report/nursePatrol?
beginDate=2024-10-18
&endDate=2024-10-18
&execTypeCodes=00:00-07:59,08:00-17:59,18:00-23:59
&timeInterval=00:00-07:59,08:00-17:59,18:00-23:59
&isCountAll=1
&wardCodes=239,303,308,309,310,3101,311,312,313,3131,314,315,316,317,318,322,324,3241,325,326,328,331,340,341,342,343,344,345,346,348,8028,998
&nurseLevel=1
&num=-1
&offset=-1
```

```js
// 导出
http://10.2.43.39:9099/WRMSMnis/mnis/report/nursePatrol/exportV2?beginDate=2024-10-18&endDate=2024-10-18&timeInterval=00:00-07:59,08:00-17:59,18:00-23:59&wardCodes=309&nurseLevel=2
```
