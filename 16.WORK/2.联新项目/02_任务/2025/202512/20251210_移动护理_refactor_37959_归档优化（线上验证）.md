# 1.CR  
  
>Java群  

项目：mnis  
内容：37959【京山市人民医院】文书自动归档和手动归档不成功
分支：fix_release_mnis_v3.8_wpb_37959 into release_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/7748

# 2.脚本  
  
>邮件  
  
> [!danger] 注意事项  
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况  
> 1.开关，默认应为关闭（根据实际情况而定）  
> 2.IP地址，默认应为127.0.0.1（一般情况）  
  
---  
  
宝哥麻烦归档下脚本：  
  
测试环境：10.2.3.170  
项目：mnis
单号：37959  
版本号：MNIS V3.8.161
分支：fix_release_mnis_v3.8_wpb_37959
  
MySQL脚本  
  
```sql

```  
  
  
> [!danger] 注意事项  
> 脚本后不要带 `;` ~  
  
MongDB脚本  


```json
use coms

// ==================== 开始执行配置同步脚本 ====================
print("═══════════════════════════════════════════════════════════");
print("        配置同步脚本开始执行");
print("═══════════════════════════════════════════════════════════");

// ==================== 1. 更新 mnisApplicationConfig 的 pattern.label ====================
print("\n【步骤 1/4】更新 MNIS 应用配置 - 基础配置标签");
print("───────────────────────────────────────────────────────────");
print("配置键: mnisApplicationConfig");
print("操作: 将 pattern.label 从 '拆分医嘱过滤配置' 更新为 '基础配置'");

var result1 = db.sysConfigFile.update(
    {
        key: 'mnisApplicationConfig',
        "pattern.label": "拆分医嘱过滤配置"
    },
    {
        $set: {
            "pattern.label": "基础配置"
        }
    }
);

if (result1.nModified > 0) {
    print("✓ 更新成功: pattern.label -> '基础配置'");
} else {
    print("⚠ 未找到匹配记录或无需更新");
}

// ==================== 2. 新增 mnisApplicationConfig 配置项 ====================
print("\n【步骤 2/4】新增 MNIS 应用配置项");
print("───────────────────────────────────────────────────────────");

var mnisDoc = db.sysConfigFile.findOne({ 'key': 'mnisApplicationConfig' });
if (!mnisDoc) {
    print("✗ 错误: 未找到配置键 'mnisApplicationConfig'");
} else {
    var mnisExistingKeys = {};
    mnisDoc.children.forEach(function(child, index) {
        mnisExistingKeys[child.key] = index;
    });

    var mnisNewItems = [
        {
            "_id": "17653577271596",
            "wardCode": "",
            "key": "ftpAddress",
            "pattern": {
                "description": "IP:端口，比如：10.2.3.170:4021",
                "componentType": "Input",
                "label": "FTP地址"
            },
            "value": "127.0.0.1"
        },
        {
            "_id": "17653580208267",
            "wardCode": "",
            "key": "fileUrlPrefix",
            "pattern": {
                "description": "一般只需要替换IP即可，其他的固定，比如：http://10.2.3.170:86/api/sys/file/",
                "componentType": "Input",
                "label": "文件服务地址前缀"
            },
            "value": "http://127.0.0.1:86/api/sys/file/"
        }
    ];

    print("待检查配置项: " + mnisNewItems.length + " 个");
    var mnisItemsToAdd = [];
    var mnisExistingCount = 0;

    mnisNewItems.forEach(function(item) {
        if (!mnisExistingKeys.hasOwnProperty(item.key)) {
            mnisItemsToAdd.push(item);
            print("  [待新增] " + item.key);
        } else {
            mnisExistingCount++;
            print("  [已存在] " + item.key);
        }
    });

    if (mnisItemsToAdd.length > 0) {
        var result2 = db.sysConfigFile.updateOne(
            { 'key': 'mnisApplicationConfig' },
            {
                "$push": {
                    "children": {
                        $each: mnisItemsToAdd
                    }
                }
            }
        );
        print("✓ 新增完成: 成功添加 " + mnisItemsToAdd.length + " 个配置项");
    } else {
        print("○ 所有配置项已存在，无需新增 (已存在: " + mnisExistingCount + " 个)");
    }
}

// ==================== 3. 更新 PaperlessDocFilingSettings 的 children ====================
print("\n【步骤 3/4】更新无纸化归档配置项");
print("───────────────────────────────────────────────────────────");

var doc = db.sysConfigFile.findOne({ 'key': 'PaperlessDocFilingSettings' });

if (!doc) {
    print("✗ 错误: 未找到配置键 'PaperlessDocFilingSettings'");
} else {
    var updatesByKey = {
        "paperlessDocArchiveSleepTime": {
            "patternOnly": true,
            "pattern": {
                "description": "",
                "componentType": "Input",
                "label": "无纸化归档休眠时间(执行evaluateExportLinaPDF前等待时长)"
            }
        }
    };

    function syncChildren() {
        var existingKeys = {};
        doc.children.forEach(function(child, index) {
            existingKeys[child.key] = index;
        });

        var updatedCount = 0;
        var skippedCount = 0;
        var notFoundCount = 0;

        for (var key in updatesByKey) {
            if (existingKeys.hasOwnProperty(key)) {
                var index = existingKeys[key];
                var existingChild = doc.children[index];
                var updateData = updatesByKey[key];

                var needUpdate = false;

                if (JSON.stringify(existingChild.pattern) !== JSON.stringify(updateData.pattern)) {
                    existingChild.pattern = updateData.pattern;
                    needUpdate = true;
                }

                if (!updateData.patternOnly && JSON.stringify(existingChild.value) !== JSON.stringify(updateData.value)) {
                    existingChild.value = updateData.value;
                    needUpdate = true;
                }

                if (needUpdate) {
                    updatedCount++;
                    print("  [已更新] " + key);
                } else {
                    skippedCount++;
                    print("  [跳过] " + key + " (无变化)");
                }
            } else {
                notFoundCount++;
                print("  [未找到] " + key);
            }
        }

        var updateResult = db.sysConfigFile.updateOne(
            { _id: doc._id },
            {
                $set: {
                    children: doc.children,
                    updateTime: new Date(),
                    updatePerson: "sync_script"
                }
            }
        );

        if (updateResult.modifiedCount > 0) {
            print("✓ 同步成功完成!");
            print("  更新: " + updatedCount + " 个");
            print("  跳过: " + skippedCount + " 个");
            if (notFoundCount > 0) {
                print("  未找到: " + notFoundCount + " 个");
            }
        } else {
            print("⚠ 警告: 没有进行任何更新");
        }
    }

    syncChildren();
}

// ==================== 4. 新增 PaperlessDocFilingSettings 配置项 ====================
print("\n【步骤 4/4】新增无纸化归档配置项");
print("───────────────────────────────────────────────────────────");

var paperlessDoc = db.sysConfigFile.findOne({ 'key': 'PaperlessDocFilingSettings' });

if (!paperlessDoc) {
    print("✗ 错误: 未找到配置键 'PaperlessDocFilingSettings'");
} else {
    var paperlessExistingKeys = {};
    paperlessDoc.children.forEach(function(child, index) {
        paperlessExistingKeys[child.key] = index;
    });

    var paperlessNewItems = [
        {
            "_id": "17653534928492",
            "wardCode": "",
            "key": "paperLessWaitUntil",
            "pattern": {
                "description": "必须是：load、domcontentloaded、networkidle0、networkidle2中的选项，多个英文逗号分割",
                "componentType": "Input",
                "label": "无纸化归档页面加载时可等待的事件",
                "urlOptionSourceDetail": {},
                "optionSourceDetail": "",
                "optionSource": "options",
                "options": []
            },
            "value": "networkidle0"
        },
        {
            "_id": "17653536142713",
            "wardCode": "",
            "key": "paperLessWaitTimeout",
            "pattern": {
                "componentType": "Input",
                "label": "无纸化归档页面加载时可等待的超时时间"
            },
            "value": "30000"
        }
    ];

    print("待检查配置项: " + paperlessNewItems.length + " 个");
    var paperlessItemsToAdd = [];
    var paperlessExistingCount = 0;

    paperlessNewItems.forEach(function(item) {
        if (!paperlessExistingKeys.hasOwnProperty(item.key)) {
            paperlessItemsToAdd.push(item);
            print("  [待新增] " + item.key);
        } else {
            paperlessExistingCount++;
            print("  [已存在] " + item.key);
        }
    });

    if (paperlessItemsToAdd.length > 0) {
        var result4 = db.sysConfigFile.updateOne(
            { 'key': 'PaperlessDocFilingSettings' },
            {
                "$push": {
                    "children": {
                        $each: paperlessItemsToAdd
                    }
                }
            }
        );
        print("✓ 新增完成: 成功添加 " + paperlessItemsToAdd.length + " 个配置项");
    } else {
        print("○ 所有配置项已存在，无需新增 (已存在: " + paperlessExistingCount + " 个)");
    }
}

// ==================== 执行完成 ====================
print("\n═══════════════════════════════════════════════════════════");
print("        配置同步脚本执行完成");
print("═══════════════════════════════════════════════════════════\n");

```

# 3.提测单  
  
>提测群  

37959【京山市人民医院】-文书自动归档和手动归档不成功


  
# 4.其它