# 1.CR  
  
>Java群  

项目：mnis  
内容：37959【京山市人民医院】-文书自动归档和手动归档不成功
分支：fix_release_mnis_v3.8_wpb_37959 into release_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/7748

# 2.脚本  
  
>邮件  
  
> [!danger] 注意事项  
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况  
> 1.开关，默认应为关闭（根据实际情况而定）  
> 2.IP地址，默认应为127.0.0.1（一般情况）  
  
---  
  
宝哥麻烦归档下脚本：  
  
测试环境：10.2.3.170  
项目：mnis
单号：37808  
版本号：MNIS V3.8.157
分支：fix_release_mnis_v3.8_wpb_37808
  
MySQL脚本  
  
```sql

```  
  
  
> [!danger] 注意事项  
> 脚本后不要带 `;` ~  
  
MongDB脚本  
  
```js  
// 切换到 coms 数据库
db = db.getSiblingDB('coms');

print("数据库: coms");
print("集合: sysConfigFile");
print("任务: 将 pattern.label 从 '拆分医嘱过滤配置' 改为 '基础配置'\n");

try {
    // 1. 查找包含 '拆分医嘱过滤配置' 的文档
    print("🔍 查找 pattern.label = '拆分医嘱过滤配置' 的文档...");
    var queryDocs = db.sysConfigFile.find({
        key: 'mnisApplicationConfig',
        "pattern.label": "拆分医嘱过滤配置"
    }).toArray();

    if (queryDocs.length === 0) {
        print("⚠️  没有找到 pattern.label = '拆分医嘱过滤配置' 的文档");

        // 查看所有相关的文档
        print("\n📋 查看所有 key='mnisApplicationConfig' 的文档:");
        var allDocs = db.sysConfigFile.find({ key: 'mnisApplicationConfig' }).toArray();

        if (allDocs.length === 0) {
            print("  ⚠️  没有找到 key='mnisApplicationConfig' 的文档");
        } else {
            allDocs.forEach(function(doc, index) {
                print("\n  文档 " + (index + 1) + ":");
                print("    _id: " + doc._id);
                if (doc.pattern && doc.pattern.label) {
                    print("    pattern.label: \"" + doc.pattern.label + "\"");
                } else {
                    print("    ⚠️  没有 pattern.label 字段");
                }
            });
        }
    } else {
        print("✅ 找到 " + queryDocs.length + " 个包含 '拆分医嘱过滤配置' 的文档");

        // 显示即将被修改的文档
        queryDocs.forEach(function(doc, index) {
            print("\n  即将修改的文档 " + (index + 1) + ":");
            print("    _id: " + doc._id);
            print("    当前 pattern.label: \"" + doc.pattern.label + "\"");
        });

        // 2. 执行更新操作
        print("\n🔧 开始更新 pattern.label 的值...");
        var updateResult = db.sysConfigFile.updateMany(
            {
                key: 'mnisApplicationConfig',
                "pattern.label": "拆分医嘱过滤配置"
            },
            {
                $set: {
                    "pattern.label": "基础配置"
                }
            }
        );

        print("\n📊 更新统计:");
        print("  匹配文档数: " + updateResult.matchedCount);
        print("  实际修改数: " + updateResult.modifiedCount);

        if (updateResult.modifiedCount > 0) {
            // 3. 验证更新结果
            print("\n✅ 验证更新结果...");
            var verifiedDocs = db.sysConfigFile.find({
                key: 'mnisApplicationConfig',
                "pattern.label": "基础配置"
            }).toArray();

            print("更新后包含 '基础配置' 的文档数: " + verifiedDocs.length);

            // 确认没有遗漏的 '拆分医嘱过滤配置'
            var remainingDocs = db.sysConfigFile.find({
                key: 'mnisApplicationConfig',
                "pattern.label": "拆分医嘱过滤配置"
            }).toArray();

            print("剩余包含 '拆分医嘱过滤配置' 的文档数: " + remainingDocs.length);

            if (remainingDocs.length === 0) {
                print("✅ 所有 '拆分医嘱过滤配置' 已成功改为 '基础配置'！");
            } else {
                print("⚠️  仍有 " + remainingDocs.length + " 个文档未更新");
            }

            // 显示更新后的文档
            verifiedDocs.forEach(function(doc, index) {
                print("\n  验证文档 " + (index + 1) + ":");
                print("    _id: " + doc._id);
                print("    新的 pattern.label: \"" + doc.pattern.label + "\"");
                if (doc.pattern.label === "基础配置") {
                    print("    ✅ 更新成功！");
                }
            });
        } else {
            print("⚠️  没有文档被修改");
        }
    }

    print("\n🎉 脚本执行完成！");

} catch (error) {
    print("❌ 执行错误: " + error.message);
    print("错误详情: " + error);
}

print("\n🔌 MongoDB Shell 脚本结束");
```  



```js
// 连接到数据库
use coms // 请替换为实际的数据库名
var doc = db.sysConfigFile.findOne({ 'key': 'PaperlessDocFilingSettings' });

// 需要新增的children项目
var childrenToAdd = [
    {
        "_id": "17653534928492",
        "wardCode": "",
        "key": "paperLessWaitUntil",
        "pattern": {
            "description": "必须是：load、domcontentloaded、networkidle0、networkidle2中的选项，多个英文逗号分割",
            "componentType": "Input",
            "label": "无纸化归档页面加载时可等待的事件",
            "urlOptionSourceDetail": {},
            "optionSourceDetail": "",
            "optionSource": "options",
            "options": []
        },
        "value": "networkidle0"
    },
    {
        "_id": "17653536142713",
        "wardCode": "",
        "key": "paperLessWaitTimeout",
        "pattern": {
            "componentType": "Input",
            "label": "无纸化归档页面加载时可等待的超时时间"
        },
        "value": "30000"
    }
];

// 需要更新的children项目（根据key匹配）
var updatesByKey = {
    "paperlessDocArchiveSleepTime": {
        // 只更新pattern，不更新value
        "patternOnly": true,
        "pattern": {
            "description": "",
            "componentType": "Input",
            "label": "无纸化归档休眠时间(执行evaluateExportLinaPDF前等待时长)"
        }
    }
};

// 更新文档的函数
function syncChildren() {
    print("开始同步children数据...");

    // 获取目标文档
    print("找到目标文档，当前children数量: " + doc.children.length);

    // 创建一个map用于快速查找已存在的key
    var existingKeys = {};
    doc.children.forEach(function(child, index) {
        existingKeys[child.key] = index;
    });

    // 1. 处理需要新增的项目
    var addedCount = 0;
    childrenToAdd.forEach(function(newChild) {
        if (!existingKeys.hasOwnProperty(newChild.key)) {
            doc.children.push(newChild);
            existingKeys[newChild.key] = doc.children.length - 1;
            addedCount++;
            print("新增: " + newChild.key);
        }
    });

    // 2. 处理需要更新的项目
    var updatedCount = 0;
    for (var key in updatesByKey) {
        if (existingKeys.hasOwnProperty(key)) {
            var index = existingKeys[key];
            var existingChild = doc.children[index];
            var updateData = updatesByKey[key];

            // 检查是否需要更新
            var needUpdate = false;

            // 比较pattern
            if (JSON.stringify(existingChild.pattern) !== JSON.stringify(updateData.pattern)) {
                existingChild.pattern = updateData.pattern;
                needUpdate = true;
            }

            // 比较value（除非是只更新pattern的情况）
            if (!updateData.patternOnly && JSON.stringify(existingChild.value) !== JSON.stringify(updateData.value)) {
                existingChild.value = updateData.value;
                needUpdate = true;
            }

            if (needUpdate) {
                updatedCount++;
                print("更新: " + key);
            }
        }
    }

    // 3. 更新文档
    var updateResult = db.sysConfigFile.updateOne(
        { _id: doc._id },
        {
            $set: {
                children: doc.children,
                updateTime: new Date(),
                updatePerson: "sync_script"
            }
        }
    );

    if (updateResult.modifiedCount > 0) {
        print("同步成功完成!");
        print("- 新增项目数: " + addedCount);
        print("- 更新项目数: " + updatedCount);
        print("- 总children数量: " + doc.children.length);
    } else {
        print("警告: 没有进行任何更新");
    }
}

// 执行同步
syncChildren();

// 验证结果
print("\n验证结果:");
var updatedDoc = db.sysConfigFile.findOne({ _id: doc._id });
print("文档更新时间: " + updatedDoc.updateTime);
print("children总数: " + updatedDoc.children.length);
```
  
# 3.提测单  
  
>提测群  

37959【京山市人民医院】-文书自动归档和手动归档不成功


  
# 4.其它