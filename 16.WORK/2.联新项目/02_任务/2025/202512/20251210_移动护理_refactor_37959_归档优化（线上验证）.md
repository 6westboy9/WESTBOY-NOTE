# 1.CR  
  
>Java群  

项目：mnis  
内容：37959【京山市人民医院】文书自动归档和手动归档不成功
分支：fix_release_mnis_v3.8_wpb_37959 into release_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/7748

# 2.脚本  
  
>邮件  
  
> [!danger] 注意事项  
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况  
> 1.开关，默认应为关闭（根据实际情况而定）  
> 2.IP地址，默认应为127.0.0.1（一般情况）  
  
---  
  
宝哥麻烦归档下脚本：  
  
测试环境：10.2.3.170  
项目：mnis
单号：37959  
版本号：MNIS V3.8.161
分支：fix_release_mnis_v3.8_wpb_37959
  
MySQL脚本  
  
```sql

```  
  
  
> [!danger] 注意事项  
> 脚本后不要带 `;` ~  
  
MongDB脚本  


```json
use coms

db.sysConfigFile.update(
    {
        key: 'mnisApplicationConfig',
        "pattern.label": "拆分医嘱过滤配置"
    },
    {
        $set: {
            "pattern.label": "基础配置"
        }
    }
);

db.sysConfigFile.find({ 'key': 'mnisApplicationConfig' })
db.sysConfigFile.updateOne({ 'key': 'mnisApplicationConfig' }, { "$pull": { 'children': { 'key': { $in: ['ftpAddress', 'fileUrlPrefix'] } } } })
db.sysConfigFile.updateOne({ 'key': 'mnisApplicationConfig' }, {
    "$push": {
        "children": {
            $each: [
                {
                    "_id": "17653577271596",
                    "wardCode": "",
                    "key": "ftpAddress",
                    "pattern": {
                        "description": "IP:端口，比如：10.2.3.170:4021",
                        "componentType": "Input",
                        "label": "FTP地址"
                    },
                    "value": "127.0.0.1"
                },
                {
                    "_id": "17653580208267",
                    "wardCode": "",
                    "key": "fileUrlPrefix",
                    "pattern": {
                        "description": "一般只需要替换IP即可，其他的固定，比如：http://10.2.3.170:86/api/sys/file/",
                        "componentType": "Input",
                        "label": "文件服务地址前缀"
                    },
                    "value": "http://127.0.0.1:86/api/sys/file/"
                }
            ]
        }
    }
})



var doc = db.sysConfigFile.findOne({ 'key': 'PaperlessDocFilingSettings' });

// 需要更新的children项目（根据key匹配）
var updatesByKey = {
    "paperlessDocArchiveSleepTime": {
        // 只更新pattern，不更新value
        "patternOnly": true,
        "pattern": {
            "description": "",
            "componentType": "Input",
            "label": "无纸化归档休眠时间(执行evaluateExportLinaPDF前等待时长)"
        }
    }
};

// 更新文档的函数
function syncChildren() {
    print("开始同步children数据...");

    // 获取目标文档
    print("找到目标文档，当前children数量: " + doc.children.length);

    // 创建一个map用于快速查找已存在的key
    var existingKeys = {};
    doc.children.forEach(function(child, index) {
        existingKeys[child.key] = index;
    });

    // 2处理需要更新的项目
    var updatedCount = 0;
    for (var key in updatesByKey) {
        if (existingKeys.hasOwnProperty(key)) {
            var index = existingKeys[key];
            var existingChild = doc.children[index];
            var updateData = updatesByKey[key];

            // 检查是否需要更新
            var needUpdate = false;

            // 比较pattern
            if (JSON.stringify(existingChild.pattern) !== JSON.stringify(updateData.pattern)) {
                existingChild.pattern = updateData.pattern;
                needUpdate = true;
            }

            // 比较value（除非是只更新pattern的情况）
            if (!updateData.patternOnly && JSON.stringify(existingChild.value) !== JSON.stringify(updateData.value)) {
                existingChild.value = updateData.value;
                needUpdate = true;
            }

            if (needUpdate) {
                updatedCount++;
                print("更新: " + key);
            }
        }
    }

    // 3. 更新文档
    var updateResult = db.sysConfigFile.updateOne(
        { _id: doc._id },
        {
            $set: {
                children: doc.children,
                updateTime: new Date(),
                updatePerson: "sync_script"
            }
        }
    );

    if (updateResult.modifiedCount > 0) {
        print("同步成功完成!");
        print("更新项目数: " + updatedCount);
    } else {
        print("警告: 没有进行任何更新");
    }
}

// 执行同步
syncChildren();


db.sysConfigFile.find({ 'key': 'PaperlessDocFilingSettings' })
db.sysConfigFile.updateOne({ 'key': 'PaperlessDocFilingSettings' }, { "$pull": { 'children': { 'key': { $in: ['paperLessWaitUntil', 'paperLessWaitTimeout'] } } } })
db.sysConfigFile.updateOne({ 'key': 'PaperlessDocFilingSettings' }, {
    "$push": {
        "children": {
            $each: [
                {
                    "_id": "17653534928492",
                    "wardCode": "",
                    "key": "paperLessWaitUntil",
                    "pattern": {
                        "description": "必须是：load、domcontentloaded、networkidle0、networkidle2中的选项，多个英文逗号分割",
                        "componentType": "Input",
                        "label": "无纸化归档页面加载时可等待的事件",
                        "urlOptionSourceDetail": {

                        },
                        "optionSourceDetail": "",
                        "optionSource": "options",
                        "options": []
                    },
                    "value": "networkidle0"
                },
                {
                    "_id": "17653536142713",
                    "wardCode": "",
                    "key": "paperLessWaitTimeout",
                    "pattern": {
                        "componentType": "Input",
                        "label": "无纸化归档页面加载时可等待的超时时间"
                    },
                    "value": "30000"
                }
            ]
        }
    }
})
```

# 3.提测单  
  
>提测群  

37959【京山市人民医院】-文书自动归档和手动归档不成功


  
# 4.其它