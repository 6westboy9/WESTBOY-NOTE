# 1.CR

>Java群

项目：mnis 
内容：10285【湛江中心医院】医信签第三方签名成功后返回，移动护理自动刷新显示签名
分支：fix_release_mnis_v3.8_wpb_20250722 into release_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/7131

---

项目：mnis 
内容：10285【湛江中心医院】医信签第三方签名成功后返回，移动护理自动刷新显示签名

- 新增手动签名功能，用于处理未自动回调的情况
- 重构签名回调逻辑，优化数据处理流程

分支：fix_release_mnis_v3.8_wpb_20250722 into release_mnis_v3.8
MR：http://10.2.3.111:86/backend_group/backend_application/mnis/merge_requests/7161



# 2.脚本

>邮件

> [!danger] 注意事项
> 提供脚本为实际线上脚本，所以必须考虑实际线上情况
> 1.开关，默认应为关闭（根据实际情况而定）
> 2.IP地址，默认应为127.0.0.1（一般情况）

---

宝哥麻烦归档下脚本：

测试环境：10.2.3.170
项目：mnis
冲刺版本：10285【湛江中心医院】医信签第三方签名成功后返回，移动护理自动刷新显示签名
单号：10285
版本号：MNIS V3.8.141
分支：fix_release_mnis_v3.8_wpb_20250722

MySQL脚本

```sql

```


> [!danger] 注意事项
> 脚本后不要带 `;` ~

MongDB脚本

```js
use coms
db.sysConfigFile.updateOne({ 'key': 'CASetting' }, { "$pull": { 'children': { 'key': { $in: ['signFileByQCCodeUrl', 'getFileCodeUrl'] } } } })
db.sysConfigFile.update({ 'key': 'CASetting' }, {
    "$push": {
        "children": {
            $each: [
                {
                    "_id": "17453186856921",
                    "key": "signFileByQCCodeUrl",
                    "pattern": {
                        "componentType": "TextArea",
                        "label": "云签代理-患者电子签名"
                    },
                    "value": ""
                },
                {
                    "_id": "17453259007102",
                    "key": "getFileCodeUrl",
                    "pattern": {
                        "componentType": "TextArea",
                        "label": "云签代理-获取文档签名"
                    },
                    "value": ""
                }]
        }
    }
})

db.sysConfigFile.updateOne({ 'key': 'CASettingSub' }, { "$pull": { 'children': { 'key': { $in: ['signFileByQCCodeUrl', 'getFileCodeUrl'] } } } })
db.sysConfigFile.update({ 'key': 'CASettingSub' }, {
    "$push": {
        "children": {
            $each: [
                {
                    "_id": "17453186856921",
                    "key": "signFileByQCCodeUrl",
                    "pattern": {
                        "componentType": "TextArea",
                        "label": "云签代理-患者电子签名"
                    },
                    "value": ""
                },
                {
                    "_id": "17453259007102",
                    "key": "getFileCodeUrl",
                    "pattern": {
                        "componentType": "TextArea",
                        "label": "云签代理-获取文档签名"
                    },
                    "value": ""
                }]
        }
    }
})

use mnis

/**
 * 删除指定索引（如果存在）
 * @param {string} collection - 集合名称
 * @param {string} indexName - 索引名称
 */
function dropIndexIfExists(collection, indexName) {
    try {
        var indexes = db.getCollection(collection).getIndexes();
        var indexExists = false;
        for (let i = 0; i < indexes.length; i++) {
            if (indexes[i].name === indexName) {
                indexExists = true;
                break;
            }
        }

        if (indexExists) {
            db.getCollection(collection).dropIndex(indexName);
            print("索引已成功删除: " + collection + "." + indexName);
        } else {
            print("索引不存在，无需删除: " + collection + "." + indexName);
        }
    } catch (error) {
        print("删除索引操作失败: " + collection + "." + indexName);
    }
}

/**
 * 创建带过期时间的索引（如果不存在）
 * @param {string} collection - 集合名称
 * @param {string} indexName - 索引名称
 * @param {object} field - 索引字段，例如 {createTime: 1}
 * @param {number} expireAfterSeconds - 过期秒数
 */
function createIndexIfNotExists(collection, indexName, field, expireAfterSeconds) {
    try {
        var indexes = db.getCollection(collection).getIndexes();
        var indexExists = false;
        for (let i = 0; i < indexes.length; i++) {
            if (indexes[i].name === indexName) {
                indexExists = true;
                break;
            }
        }

        if (indexExists) {
            print("索引已存在, 无需创建: " + collection + "." + indexName);
        } else {
            print("索引不存在, 进行创建: " + collection + "." + indexName);
            db.getCollection(collection).createIndex(
                field,
                { expireAfterSeconds: expireAfterSeconds, name: indexName }
            );
        }
    } catch (error) {
        print("创建索引失败: " + collection + "." + indexName);
    }
}

// 配置参数
const indexConfig = [
    {
        // 患者签名数据
        collection: "docSignatureData",
        indexName: "idx_createTime",
        field: { createTime: 1 },
        expireAfterSeconds: 2592000 // 30天
    },
    {
        // 医护签名数据
        collection: "caExtendedData",
        indexName: "idx_createTime",
        field: { createTime: 1 },
        expireAfterSeconds: 2592000 // 30天
    },
    {
        collection: "docOperationRecord",
        indexName: "idx_createTime",
        field: { createTime: 1 },
        expireAfterSeconds: 2592000 // 30天
    }
];

// 执行索引操作
indexConfig.forEach(config => {
    dropIndexIfExists(config.collection, config.indexName);
    createIndexIfNotExists(
        config.collection,
        config.indexName,
        config.field,
        config.expireAfterSeconds
    );
});
```

# 3.提测单

>提测群

http://183.62.162.28:1024/zentao/execution-testtask-2757.html#app=execution
10285【湛江中心医院】医信签第三方签名成功后返回，移动护理自动刷新显示签名

项目：mnis   
内容：10285【湛江中心医院】医信签第三方签名成功后返回，移动护理自动刷新显示签名  
  
- 新增手动签名功能，用于处理未自动回调的情况  
- 重构签名回调逻辑，优化数据处理流程  

回调失败手动补偿接口和患者签名流程：https://lachesis-mh.feishu.cn/wiki/KHGLwN0lvinmkZkwXq6c1t9Vnwf​

# 4.其它


```yaml
feign:
  client:
    config:
      default:
        connect-timeout: 10000 #设置feign客户端的链接超时
        read-timeout: 10000 #设置feign客户端的读取超时时间
      shenZhenYunCa:
        logger-level: full
```





