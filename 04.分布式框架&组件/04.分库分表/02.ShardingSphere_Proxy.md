
https://shardingsphere.apache.org/document/legacy/1.x/cn/02-guide/sharding

[官方文档](https://shardingsphere.apache.org/document/4.1.0/cn/manual/sharding-proxy)

# 快速入门

## Docker

发现在实际安装时，发现了不同的镜像，见下三个：

* shardingsphere/sharding-proxy（官网文档，怀疑是文档没有更新，都5年前的了~）
* apache/sharding-proxy
* <font color="#f79646">apache/shardingsphere-proxy</font>（我这里使用的此镜像）

```
REPOSITORY                           TAG       IMAGE ID       CREATED         SIZE
apache/shardingsphere-proxy          latest    8e2003522bc5   2 years ago     408MB
apache/sharding-proxy                latest    c073b308b21a   2 years ago     749MB
shardingsphere/sharding-proxy        latest    7f3169fe1965   5 years ago     648MB
```

### 1.准备原生配置文件

```sh
docker run -d --name shardingsphere-proxy-tmp apache/shardingsphere-proxy:latest
mkdir -p /opt/docker-volumes/shardingsphere-proxy
docker cp sharding-proxy-tmp:/opt/shardingsphere-proxy/conf /opt/docker-volumes/shardingsphere-proxy/conf
```

```sh
docker stop shardingsphere-proxy-tmp
docker rm shardingsphere-proxy-tmp
```

### 2.编辑配置文件

**1.编辑%SHARDINGSPHERE_PROXY_HOME%/conf/server.yaml**

>%SHARDINGSPHERE_PROXY_HOME%为Proxy解压后的路径

```yaml
rules:
 - !AUTHORITY
   users:
     - root@%:root
   provider:
     type: ALL_PRIVILEGES_PERMITTED
props:
 sql-show: true
```

**2.编辑%SHARDINGSPHERE_PROXY_HOME%/conf/config-xxx.yaml**

>这里为了验证Docker安装是否成功，先演示一个简单版本水平分片案例~

在192.168.172.102:3311节点上库表的分布情况：

```
192.168.172.102:3311
	demo_ds_0
		t_order_0
		t_order_1
		t_order_item_0
		t_order_item_1  
	demo_ds_1
		t_order_0
		t_order_1
		t_order_item_0
		t_order_item_1  
```

水平分片配置：

```yaml
schemaName: sharding_db

dataSources:
 ds_0:
   url: 'jdbc:mysql://192.168.172.102:3311/demo_ds_0?serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true'
   username: root
   password: 123456
   connectionTimeoutMilliseconds: 30000
   idleTimeoutMilliseconds: 60000
   maxLifetimeMilliseconds: 1800000
   maxPoolSize: 50
   minPoolSize: 1
 ds_1:
   url: 'jdbc:mysql://192.168.172.102:3311/demo_ds_1?serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true'
   username: root
   password: 123456
   connectionTimeoutMilliseconds: 30000
   idleTimeoutMilliseconds: 60000
   maxLifetimeMilliseconds: 1800000
   maxPoolSize: 50
   minPoolSize: 1

rules:
- !SHARDING
 tables:
   t_order:
     actualDataNodes: ds_${0..1}.t_order_${0..1}
     tableStrategy:
       standard:
         shardingColumn: order_id
         shardingAlgorithmName: t_order_inline
     keyGenerateStrategy:
       column: order_id
       keyGeneratorName: snowflake
   t_order_item:
     actualDataNodes: ds_${0..1}.t_order_item_${0..1}
     tableStrategy:
       standard:
         shardingColumn: order_id
         shardingAlgorithmName: t_order_item_inline
     keyGenerateStrategy:
       column: order_item_id
       keyGeneratorName: snowflake
 bindingTables:
   - t_order,t_order_item
 defaultDatabaseStrategy:
   standard:
     shardingColumn: user_id
     shardingAlgorithmName: database_inline
 defaultTableStrategy:
   none:
 
 shardingAlgorithms:
   database_inline:
     type: INLINE
     props:
       algorithm-expression: ds_${user_id % 2}
   t_order_inline:
     type: INLINE
     props:
       algorithm-expression: t_order_${order_id % 2}
   t_order_item_inline:
     type: INLINE
     props:
       algorithm-expression: t_order_item_${order_id % 2}
 
 keyGenerators:
   snowflake:
     type: SNOWFLAKE
     props:
       worker-id: 123
```

### 3.引入依赖

* 如果后端连接PostgreSQL或openGauss数据库，不需要引入额外依赖。
* 如果后端连接MySQL数据库，请下载[mysql-connector-java-5.1.49.jar](https://repo1.maven.org/maven2/mysql/mysql-connector-java/5.1.49/mysql-connector-java-5.1.49.jar)或者[mysql-connector-java-8.0.11.jar](https://repo1.maven.org/maven2/mysql/mysql-connector-java/8.0.11/mysql-connector-java-8.0.11.jar)，并将其放入<font color="#f79646">%SHARDINGSPHERE_PROXY_HOME%/ext-lib</font>目录。

上传jar包只ext-lib目录下：

```shell
[root@localhost ext-lib]# pwd
/opt/docker-volumes/shardingsphere-proxy/ext-lib
[root@localhost ext-lib]# ll
total 1992
-rw-r--r--. 1 root root 2036609 Jan  3 13:28 mysql-connector-java-8.0.11.jar
```

### 4.启动服务

```shell
docker run -d -e PORT=3308 -p13308:3308 --name shardingsphere-proxy \
-v /opt/docker-volumes/shardingsphere-proxy/conf:/opt/shardingsphere-proxy/conf \
-v /opt/docker-volumes/shardingsphere-proxy/ext-lib:/opt/shardingsphere-proxy/ext-lib \
apache/shardingsphere-proxy:latest
```

这里设置容器内端口为3308，映射宿主机端口为13308，使用

### 5.MySQL CLI验证

使用MySQL客户端连接ShardingSphere-Proxy：

```
mysql -h${proxy_host} -P${proxy_port} -u${proxy_username} -p${proxy_password}
```

```
# mysql -h172.17.0.3 -P3308 -uroot -proot
mysql> show databases;
+-------------+
| schema_name |
+-------------+
| sharding_db |
+-------------+
1 row in set (0.01 sec)

mysql> use sharding_db;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+-----------------------+------------+
| Tables_in_sharding_db | Table_type |
+-----------------------+------------+
| t_order_item          | BASE TABLE |
| t_order               | BASE TABLE |
+-----------------------+------------+
2 rows in set (0.00 sec)

mysql> select * from t_order_item;
Empty set (0.12 sec)
```

在执行上述查询SQL时，查看ShardingSphere-Proxy日志：

```
[INFO ] 2024-01-03 06:10:08.265 [ShardingSphere-Command-0] ShardingSphere-SQL - Actual SQL: ds_0 ::: SHOW COLUMNS FROM t_order_0 
[INFO ] 2024-01-03 06:10:24.987 [ShardingSphere-Command-0] ShardingSphere-SQL - Logic SQL: select * from t_order_item
[INFO ] 2024-01-03 06:10:24.987 [ShardingSphere-Command-0] ShardingSphere-SQL - SQLStatement: MySQLSelectStatement(limit=Optional.empty, lock=Optional.empty, window=Optional.empty)
[INFO ] 2024-01-03 06:10:24.987 [ShardingSphere-Command-0] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from t_order_item_0 ORDER BY id ASC 
[INFO ] 2024-01-03 06:10:24.987 [ShardingSphere-Command-0] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from t_order_item_1 ORDER BY id ASC 
[INFO ] 2024-01-03 06:10:24.987 [ShardingSphere-Command-0] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from t_order_item_0 ORDER BY id ASC 
[INFO ] 2024-01-03 06:10:24.987 [ShardingSphere-Command-0] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from t_order_item_1 ORDER BY id ASC 
```

## 二进制包

[官方说明文档](https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-proxy/startup/bin)

### 0.前提

具备Java JRE 8或更高版本~
### 1.获取发布包

省略...
### 2.编辑配置文件

1.编辑%SHARDINGSPHERE_PROXY_HOME%/conf/server.yaml

```yaml
authority:
 users:
   - user: root@%
     password: root
   - user: sharding
     password: sharding
 privilege:
   type: ALL_PERMITTED

logging:
 loggers:
 - loggerName: ShardingSphere-SQL
   additivity: true
   level: INFO
   props:
     enable: true

props:
 system-log-level: INFO
 sql-show: true
```

2.编辑%SHARDINGSPHERE_PROXY_HOME%/conf/config-xxx.yaml

```yaml
databaseName: sharding_db

dataSources:
 ds_0:
   url: jdbc:mysql://192.168.172.102:3311/demo_ds_0?serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true
   username: root
   password: 123456
   connectionTimeoutMilliseconds: 30000
   idleTimeoutMilliseconds: 60000
   maxLifetimeMilliseconds: 1800000
   maxPoolSize: 50
   minPoolSize: 1
 ds_1:
   url: jdbc:mysql://192.168.172.102:3311/demo_ds_1?serverTimezone=UTC&useSSL=false&allowPublicKeyRetrieval=true
   username: root
   password: 123456
   connectionTimeoutMilliseconds: 30000
   idleTimeoutMilliseconds: 60000
   maxLifetimeMilliseconds: 1800000
   maxPoolSize: 50
   minPoolSize: 1

rules:
- !SHARDING
 tables:
   t_order:
     actualDataNodes: ds_${0..1}.t_order_${0..1}
     tableStrategy:
       standard:
         shardingColumn: order_id
         shardingAlgorithmName: t_order_inline
     keyGenerateStrategy:
       column: order_id
       keyGeneratorName: snowflake
   t_order_item:
     actualDataNodes: ds_${0..1}.t_order_item_${0..1}
     tableStrategy:
       standard:
         shardingColumn: order_id
         shardingAlgorithmName: t_order_item_inline
     keyGenerateStrategy:
       column: order_item_id
       keyGeneratorName: snowflake
 bindingTables:
   - t_order,t_order_item
 defaultDatabaseStrategy:
   standard:
     shardingColumn: user_id
     shardingAlgorithmName: database_inline
 defaultTableStrategy:
   none:

 shardingAlgorithms:
   database_inline:
     type: INLINE
     props:
       algorithm-expression: ds_${user_id % 2}
   t_order_inline:
     type: INLINE
     props:
       algorithm-expression: t_order_${order_id % 2}
   t_order_item_inline:
     type: INLINE
     props:
       algorithm-expression: t_order_item_${order_id % 2}

 keyGenerators:
   snowflake:
     type: SNOWFLAKE
```

其实发现与Docker配置存在一些细微差异：
* 使用的databaseName，而在Docker的配置模板中为schemaName（<font color="#f79646">猜测两者的作用可能是类似的</font>）

### 3.引入依赖

同上

### 4.启动服务

```
sh start.sh
```

默认监听端口3307，默认配置目录为Proxy内的conf目录。启动脚本可以指定监听端口、配置文件所在目录，命令如下：

```
bin/start.sh [port] [/path/to/conf]
```
### 5.MySQL CLI验证

```
# mysql -h192.168.172.102 -P3307 -uroot -proot
mysql> show databases;
+--------------------+
| schema_name        |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| sharding_db        |
| shardingsphere     |
| sys                |
+--------------------+
6 rows in set (0.04 sec)

mysql> use sharding_db;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> show tables;
+-----------------------+
| Tables_in_sharding_db |
+-----------------------+
| t_order_item          |
| t_order               |
+-----------------------+
2 rows in set (0.00 sec)

mysql> select * from t_order;
Empty set (0.13 sec)
```

```
[INFO ] 2024-01-03 14:32:11.560 [ShardingSphere-Command-0] ShardingSphere-SQL - Logic SQL: select * from t_order
[INFO ] 2024-01-03 14:32:11.560 [ShardingSphere-Command-0] ShardingSphere-SQL - Actual SQL: ds_0 ::: select * from t_order_0 UNION ALL select * from t_order_1
[INFO ] 2024-01-03 14:32:11.560 [ShardingSphere-Command-0] ShardingSphere-SQL - Actual SQL: ds_1 ::: select * from t_order_0 UNION ALL select * from t_order_1
```

# DistSQL

参考资料：
* [官方文档](https://shardingsphere.apache.org/document/current/cn/user-manual/shardingsphere-proxy/distsql)
* [ShardingSphere5.3.0升级解读：DistSQL对象体系首次揭秘！](https://blog.csdn.net/ShardingSphere/article/details/128572650)

## 简单案例

### 01.准备

确保物理库存在，且存在需要分片的表。这里演示的分片表分布：

```
10.2.3.167:3306
	demo_ds_0
		t_order_0
		t_order_1
	demo_ds_1
		t_order_0
		t_order_1
```

### 02.创建逻辑库

```sql
CREATE DATABASE sharding_db;
```

>以下所有操作都是在在Proxy的MySQL CLI中操作~
### 03.选择逻辑库

```sql
USE sharding_db;
```

### 04.注册存储单元

```sql
REGISTER STORAGE UNIT ds_0 (
    HOST="10.2.3.167",
    PORT=3306,
    DB="db_0",
    USER="user",
    PASSWORD="Lachesis-mh_1024"
), ds_1 (
    HOST="10.2.3.167",
    PORT=3306,
    DB="db_1",
    USER="user",
    PASSWORD="Lachesis-mh_1024"
);
```

### 05.查询存储单元

```sql
SHOW STORAGE UNITS;
```

在DataGrip中的执行结果：

>主要是在MySQL CLI中执行结果展示太不友好了~

![[Pasted image 20240104172006.png|500]]

### 07.定义分片规则

```sql
CREATE SHARDING TABLE RULE t_order_item (
    STORAGE_UNITS(ds_0,ds_1),
    SHARDING_COLUMN=order_id,
    TYPE(NAME=MOD,PROPERTIES("sharding-count"=4)),
    KEY_GENERATE_STRATEGY(COLUMN=order_id,TYPE(NAME=SNOWFLAKE))
);
```

### 08.查询分片规则

```sql
SHOW SHARDING TABLE RULES;
```

![[Pasted image 20240104173423.png|400]]

### 09.创建分片表

```sql
CREATE TABLE `t_order_item` (  
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,  
  `order_id` bigint unsigned NOT NULL DEFAULT '0',  
  `order_item_id` bigint unsigned NOT NULL DEFAULT '0',  
  `order_item_name` varchar(100) NOT NULL DEFAULT '',  
  `create_time` bigint NOT NULL DEFAULT '0',  
  `update_time` bigint NOT NULL DEFAULT '0',  
  PRIMARY KEY (`id`)  
) ENGINE=InnoDB;
```

### 10.数据读写

**1.插入**

```sql
INSERT INTO t_order_item (order_id, order_item_id, order_item_name) VALUES 
(1000000001, 2000000001, '哈哈哈1'),
(1000000002, 2000000002, '哈哈哈2'),
(1000000003, 2000000003, '哈哈哈3'),
(1000000004, 2000000004, '哈哈哈4');
```

**2.查询**

```sql
SELECT * FROM t_order_item;
+----+------------+---------------+-----------------+-------------+-------------+
| id | order_id   | order_item_id | order_item_name | create_time | update_time |
+----+------------+---------------+-----------------+-------------+-------------+
|  1 | 1000000004 |    2000000004 | 哈哈哈4         |           0 |           0 |
|  1 | 1000000002 |    2000000002 | 哈哈哈2         |           0 |           0 |
|  1 | 1000000001 |    2000000001 | 哈哈哈1         |           0 |           0 |
|  1 | 1000000003 |    2000000003 | 哈哈哈3         |           0 |           0 |
+----+------------+---------------+-----------------+-------------+-------------+
```

**3.修改**

```sql
UPDATE t_order_item SET order_item_id = order_item_id + 10;
```

```sql
SELECT * FROM t_order_item;
+----+------------+---------------+-----------------+-------------+-------------+
| id | order_id   | order_item_id | order_item_name | create_time | update_time |
+----+------------+---------------+-----------------+-------------+-------------+
|  1 | 1000000004 |    2000000014 | 哈哈哈4         |           0 |           0 |
|  1 | 1000000002 |    2000000012 | 哈哈哈2         |           0 |           0 |
|  1 | 1000000001 |    2000000011 | 哈哈哈1         |           0 |           0 |
|  1 | 1000000003 |    2000000013 | 哈哈哈3         |           0 |           0 |
+----+------------+---------------+-----------------+-------------+-------------+
```

**4.删除**

```sql
DELETE FROM t_order_item WHERE order_id = 1000000002;
```

```sql
SELECT * FROM t_order_item;
+----+------------+---------------+-----------------+-------------+-------------+
| id | order_id   | order_item_id | order_item_name | create_time | update_time |
+----+------------+---------------+-----------------+-------------+-------------+
|  1 | 1000000004 |    2000000014 | 哈哈哈4         |           0 |           0 |
|  1 | 1000000001 |    2000000011 | 哈哈哈1         |           0 |           0 |
|  1 | 1000000003 |    2000000013 | 哈哈哈3         |           0 |           0 |
+----+------------+---------------+-----------------+-------------+-------------+
```

### 11.修改表

```sql
# 新增字段
ALTER TABLE t_order_item add remark VARCHAR(200) DEFAULT '' NOT NULL AFTER order_item_name;
# 删除字段
ALTER TABLE t_order_item DROP COLUMN remark;
```

```sql
# 查看表结构
SHOW CREATE TABLE t_order_item;
```

```sql
# 创建索引
CREATE INDEX order_item_id_index ON t_order_item (order_item_id);
```

### 12.删除表

```sql
DROP TABLE IF EXISTS t_order_item;
```

### 13.删除分片规则

```sql
DROP SHARDING TABLE RULE t_order_item;
```

### 14.移除存储单元

```sql
UNREGISTER STORAGE UNIT ds_0,ds_1;
```

### 15.删除逻辑库

```sql
DROP DATABASE sharding_db;
```


## 语法



# 实战


## 读写分离


## 垂直分片


## 水平分片


>在使用Proxy的情况下，如何自定义分片策略？

### 自定义分片策略




## 数据迁移

### 运行部署


查询配置

```SQL
mysql> SHOW MIGRATION RULE;
+--------------------------------------------------------------+--------------------------------------+-------------------------------------------------------+
| read                                                         | write                                | stream_channel                                        |
+--------------------------------------------------------------+--------------------------------------+-------------------------------------------------------+
| {"workerThread":20,"batchSize":1000,"shardingSize":10000000} | {"workerThread":20,"batchSize":1000} | {"type":"MEMORY","props":{"block-queue-size":"2000"}} |
+--------------------------------------------------------------+--------------------------------------+-------------------------------------------------------+
```

### 使用手册

目标

![[Pasted image 20240109173338.png|500]]

* <font color="#f79646">前置条件一：必须开启binlog~</font>
* <font color="#f79646">前提条件二：数据迁移必须是集群模式~</font>


**1.新建目标端逻辑数据库并配置好存储单元和规则**

```SQL
SHOW DATABASES;
-- 创建逻辑库
CREATE DATABASE windranger_emr;

USE windranger_emr;

-- 注册存储单元
REGISTER STORAGE UNIT IF NOT EXISTS ds_0 (
    URL="jdbc:mysql://10.2.3.167:3306/windranger_emr?characterEncoding=utf8&serverTimezone=GMT%2B8&allowMultiQueries=true",
    USER="user",
    PASSWORD="Lachesis-mh_1024",
    PROPERTIES("minPoolSize"="1","maxPoolSize"="20","idleTimeout"="60000")
);

-- 查询存储单元
SHOW STORAGE UNITS;

-- 定义分片规则
-- 1.标准分片规则
-- CREATE SHARDING TABLE RULE t1_pat_inhos_order_group (
--     DATANODES("ds_0"),
--     TABLE_STRATEGY(TYPE="standard",SHARDING_COLUMN=inhos_code,SHARDING_ALGORITHM(TYPE(NAME="inline",PROPERTIES("algorithm-expression"="pat_inhos_order_group_${Math.abs(inhos_code.hashCode())%4}"))))
-- );

-- 2.自动分片规则
CREATE SHARDING TABLE RULE IF NOT EXISTS pat_inhos_order_group (
    STORAGE_UNITS(ds_0),
    SHARDING_COLUMN=inhos_code,TYPE(NAME="hash_mod",PROPERTIES("sharding-count"="4"))
);

-- 查询分片规则
SHOW SHARDING TABLE RULES;

-- 创建分片表
-- 1.不能使用if not exists哦
-- 2.保证pat_inhos_order_group分片表不存在（重要！！）
CREATE TABLE IF NOT EXISTS pat_inhos_order_group (  
  seq_id bigint(20) NOT NULL AUTO_INCREMENT COMMENT '自增长编号',  
  group_unique_code varchar(60) NOT NULL COMMENT '批次唯一编号',  
  order_group_no varchar(50) DEFAULT '' COMMENT '医嘱批次编号',  
  inhos_code varchar(20) DEFAULT '' COMMENT '病人住院号',  
  orderbar varchar(40) DEFAULT '' COMMENT '医嘱条码',  
  package_bar varchar(50) DEFAULT NULL COMMENT '药箱条码',  
  plan_time datetime DEFAULT NULL COMMENT '计划执行时间',  
  order_sort_no int(11) DEFAULT NULL COMMENT '医嘱排序编号',  
  source_type varchar(20) DEFAULT '' COMMENT '数据来源',  
  isprint int(11) NOT NULL DEFAULT '0' COMMENT '是否已打印 0 否; 1 是',  
  execute_status int(11) NOT NULL DEFAULT '0' COMMENT '执行状态  0 - 未执行， 1- 执行中， 2 - 已执行， 3-停止，4-作废',  
  execute_date datetime DEFAULT NULL COMMENT '执行时间',  
  print_date datetime DEFAULT NULL COMMENT '打印时间',  
  execute_person varchar(20) DEFAULT '' COMMENT '执行人',  
  print_person varchar(20) DEFAULT '' COMMENT '打印人',  
  apply_time datetime DEFAULT NULL COMMENT '开立时间',  
  is_dispensed int(11) NOT NULL DEFAULT '0' COMMENT '是否已配药 1-是， 0 - 否',  
  remark varchar(100) DEFAULT '' COMMENT ' 医嘱备注',  
  reason varchar(100) DEFAULT NULL COMMENT '手动或作废执行的原因',  
  execute_type int(11) DEFAULT '0' COMMENT '执行方式 0-无效， 1- 扫描执行， 2 - 手动执行',  
  start_execute_user varchar(20) DEFAULT NULL COMMENT '手动补录开始执行人',  
  start_execute_date datetime DEFAULT NULL COMMENT '手动补录开始执行时间',  
  start_check_user varchar(20) DEFAULT NULL COMMENT '手动补录开始核对人',  
  end_execute_user varchar(20) DEFAULT NULL COMMENT '手动补录结束执行人',  
  end_execute_date datetime DEFAULT NULL COMMENT '手动补录结束执行时间',  
  create_time datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',  
  create_person varchar(50) NOT NULL DEFAULT '' COMMENT '创建人',  
  update_time datetime DEFAULT NULL COMMENT '修改时间',  
  update_person varchar(50) DEFAULT NULL COMMENT '修改人',  
  PRIMARY KEY (seq_id)  
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT='医嘱批次表';

create unique index uq_pat_inhos_order_group_1 on pat_inhos_order_group(group_unique_code);  
create index idx_idx_pat_inhos_order_group_5 on pat_inhos_order_group (inhos_code);  
create index idx_pat_inhos_order_group_1 on pat_inhos_order_group (order_group_no);  
create index idx_pat_inhos_order_group_2 on pat_inhos_order_group (orderbar);  
create index idx_pat_inhos_order_group_3 on pat_inhos_order_group (execute_date);  
create index idx_pat_inhos_order_group_4 on pat_inhos_order_group (plan_time);  
create index idx_pat_inhos_order_group_6 on pat_inhos_order_group (inhos_code, plan_time, execute_status);
```

>备注：之前认为创建表的同时不支持创建索引，是因为server.xml开启了props.check-table-metadata-enabled这个配置。根据官网的解释，也没明白其作用到底是什么？

**2.注册源端存储单元**

```SQL
REGISTER MIGRATION SOURCE STORAGE UNIT windranger_emr_source (
    URL="jdbc:mysql://10.2.3.167:3306/windranger_emr?characterEncoding=utf8&serverTimezone=GMT%2B8&allowMultiQueries=true",
    USER="user",
    PASSWORD="Lachesis-mh_1024",
    PROPERTIES("minPoolSize"="20","maxPoolSize"="20","idleTimeout"="60000")
);
```

**3.启动数据迁移**

```SQL
-- 启动数据迁移
MIGRATE TABLE windranger_emr_source.pat_inhos_order_group INTO windranger_emr.pat_inhos_order_group;

select * from pat_inhos_order_group_bak1 limit 10;
select * from pat_inhos_order_group limit 10;

MIGRATE TABLE windranger_emr_source.pat_inhos_order_group_bak1 INTO windranger_emr.pat_inhos_order_group;

-- 查看数据迁移作业列表
SHOW MIGRATION LIST;
+--------------------------------------------+---------------------------------------------+----------------+--------+---------------------+-----------+
| id                                         | tables                                      | job_item_count | active | create_time         | stop_time |
+--------------------------------------------+---------------------------------------------+----------------+--------+---------------------+-----------+
| j0102p0000013efc3a9791b6876cc092ed25155f84 | windranger_emr_source.pat_inhos_order_group | 1              | true   | 2024-01-08 14:57:09 | NULL      |
+--------------------------------------------+---------------------------------------------+----------------+--------+---------------------+-----------+
-- 查看数据迁移详情
-- processed_records_count       同步数据条目
-- inventory_finished_percentage 同步进度：当前同步进度为5%
SHOW MIGRATION STATUS 'j0102p0000013efc3a9791b6876cc092ed25155f84';
+------+-----------------------+---------------------------------------------+------------------------+--------+-------------------------+-------------------------------+--------------------------+---------------+
| item | data_source           | tables                                      | status                 | active | processed_records_count | inventory_finished_percentage | incremental_idle_seconds | error_message |
+------+-----------------------+---------------------------------------------+------------------------+--------+-------------------------+-------------------------------+--------------------------+---------------+
| 0    | windranger_emr_source | windranger_emr_source.pat_inhos_order_group | EXECUTE_INVENTORY_TASK | true   | 1385000                 | 5                             |                          |               |
+------+-----------------------+---------------------------------------------+------------------------+--------+-------------------------+-------------------------------+--------------------------+---------------+
```

**4.执行数据一致性校验**

```SQL
-- 执行数据一致性校验
CHECK MIGRATION 'j0102p0000013efc3a9791b6876cc092ed25155f84' BY TYPE (NAME='CRC32_MATCH');
-- 查询数据一致性校验进度
SHOW MIGRATION CHECK STATUS 'j0102p0000013efc3a9791b6876cc092ed25155f84';
+---------------------------------------------+--------+---------------------+--------+-------------------------------+-----------------------------+--------------------------+-------------------------+----------------+------------------+----------------+-----------------+---------------+
| tables                                      | result | check_failed_tables | active | inventory_finished_percentage | inventory_remaining_seconds | incremental_idle_seconds | check_begin_time        | check_end_time | duration_seconds | algorithm_type | algorithm_props | error_message |
+---------------------------------------------+--------+---------------------+--------+-------------------------------+-----------------------------+--------------------------+-------------------------+----------------+------------------+----------------+-----------------+---------------+
| windranger_emr_source.pat_inhos_order_group |        |                     | true   | 0                             | 0                           |                          | 2024-01-08 15:12:17.731 |                | 0                | CRC32_MATCH    |                 |               |
+---------------------------------------------+--------+---------------------+--------+-------------------------------+-----------------------------+--------------------------+-------------------------+----------------+------------------+----------------+-----------------+---------------+
```

**5.完成提交作业**

```SQL
-- 完成作业
COMMIT MIGRATION 'j0102p0000013efc3a9791b6876cc092ed25155f84';
```

**6.刷新元数据**

```SQL
-- 刷新元数据
REFRESH TABLE METADATA;
```



