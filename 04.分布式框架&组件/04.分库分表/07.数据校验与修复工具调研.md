>PingCAP的sync-diff-inspector工具


官方文档：[https://docs.pingcap.com/zh/tidb/stable/sync-diff-inspector-overview](https://docs.pingcap.com/zh/tidb/stable/sync-diff-inspector-overview)

# 快速使用

下载页面：[https://docs.pingcap.com/zh/tidb/stable/download-ecosystem-tools](https://docs.pingcap.com/zh/tidb/stable/download-ecosystem-tools)

这里在10.2.3.167环境已经下载并解压到tidb-community-toolkit目录下：

```shell
[root@localhost tools]# pwd
/usr/local/tools
[root@localhost tools]# ll
total 1163956
drwxr-xr-x 6 root root       4096 Jan 16 13:37 tidb-community-toolkit
-rw-r--r-- 1 root root 1191886466 Jan 12 18:27 tidb-community-toolkit-v7.5.0-linux-amd64.tar.gz
```

为了快速使用，我们这里仅先将同一个表，既作为源，又作为目标，进行校验。

## 1.配置

在tidb-community-toolkit目录下新增配置文件：

```toml
######################### Global config #########################
check-thread-count = 4             # 检查数据的线程数量
export-fix-sql = true              # 如果开启，若表数据存在不一致，则输出用于修复的SQL语句
check-struct-only = false          # 只对比表结构而不对比数据
######################### Datasource config #########################
[data-sources]                    
[data-sources.mysql1]              # 上游MySQL数据库配置（源端）
    host = "10.2.3.167"          
    port = 3306
    user = "user"
    password = "Lachesis-mh_1024"
[data-sources.mysql2]              # 下游MySQL数据库配置（目标端）
    host = "10.2.3.167"          
    port = 3306
    user = "user"
    password = "Lachesis-mh_1024"

######################### Task config #########################
[task]
    output-dir = "./output_1"
    source-instances = ["mysql1"]       # 上游数据库，内容是data-sources声明的唯一标识id，分库分表场景下支持多个上游数据库，如：["mysql10", "mysql20"]
    target-instance = "mysql2"          # 下游数据库，内容是data-sources声明的唯一标识id
    target-check-tables = ["windranger_emr.pat_inhos_order_group_bak1"]   # 需要比对的下游数据库的表，每个表需要包含数据库名和表名，两者由.隔开
```

## 2.执行

```shell
# ./sync_diff_inspector --config=./config.toml
A total of 1 tables need to be compared

Progress [>------------------------------------------------------------] 0% 0/0
Comparing the table structure of ``windranger_emr`.`pat_inhos_order_group_bak1`` ... equivalent
Comparing the table data of ``windranger_emr`.`pat_inhos_order_group_bak1`` ... equivalent
_____________________________________________________________________________
Progress [============================================================>] 100% 0/0
A total of 1 table have been compared and all are equal.
You can view the comparision details through './output_1/sync_diff.log'
```

## 3.查看结果

 输出文件：

```
# tree ./output_1
./output_1
├── checkpoint
│   └── 8cf88e35534ead7225e205a6a8ae2911df262ef67ba58083e9fe15f61f1411a8
├── fix-on-mysql2
├── summary.txt
└── sync_diff.log
```
具体说明参见：[https://docs.pingcap.com/zh/tidb/stable/sync-diff-inspector-overview#%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6](https://docs.pingcap.com/zh/tidb/stable/sync-diff-inspector-overview#%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6)

查看校验与修复的汇总输出文件：

![[Pasted image 20240124100039.png|600]]

可以看到表结构和数据是相同的。

> 是否符合预期：是！  

# 分库分表校验_场景1


前提：准备单表和分库分表，并将单表中的数据已经迁移至分库分表。

![[Pasted image 20240124100143.png|600]]

## 1.配置

在tidb-community-toolkit目录下新增配置文件：

```toml
######################### Global config #########################
check-thread-count = 4             # 检查数据的线程数量
export-fix-sql = true              # 如果开启，若表数据存在不一致，则输出用于修复的SQL语句
check-struct-only = false          # 只对比表结构而不对比数据

######################### Datasource config #########################
[data-sources.mysql1]              # 上游MySQL数据库配置（源端）
    host = "10.2.3.167"          
    port = 3306
    user = "user"
    password = "Lachesis-mh_1024"
    route-rules = ["rule1"]
[data-sources.mysql2]              # 下游MySQL数据库配置（目标端）
    host = "10.2.3.167"          
    port = 3306
    user = "user"
    password = "Lachesis-mh_1024"

########################### Routes ###########################
# 如果需要对比大量的不同库名或者表名的表的数据，或者用于校验上游多个分表与下游总表的数据，可以通过table-rule来设置映射关系
[routes.rule1]
schema-pattern = "windranger_emr"                   # 匹配数据源的库名，支持通配符"*"和"?"
table-pattern = "pat_inhos_order_group_t1_[0-3]"    # 匹配数据源的表名，支持通配符"*"和"?"
target-schema = "windranger_emr"                    # 目标库名
target-table = "pat_inhos_order_group_bak1"         # 目标表名

######################### Task config #########################
[task]
    output-dir = "./output_order_group_sharding"
    source-instances = ["mysql1"]       # 上游数据库，内容是data-sources声明的唯一标识id，分库分表场景下支持多个上游数据库，如：["mysql10", "mysql20"]
    target-instance = "mysql2"          # 下游数据库，内容是data-sources声明的唯一标识id
    target-check-tables = ["windranger_emr.pat_inhos_order_group_bak1"]   # 需要比对的下游数据库的表，每个表需要包含数据库名和表名，两者由.隔开
```

## 2.执行

```shell
# ./sync_diff_inspector --config=./config.toml
A total of 1 tables need to be compared

Progress [>------------------------------------------------------------] 0% 0/0
Comparing the table structure of ``windranger_emr`.`pat_inhos_order_group_bak1`` ... failure
Comparing the table data of ``windranger_emr`.`pat_inhos_order_group_bak1`` ... equivalent
_____________________________________________________________________________
Progress [============================================================>] 100% 0/0
The structure of `windranger_emr`.`pat_inhos_order_group_bak1` is not equal

The rest of tables are all equal.

A total of 1 tables have been compared, 0 tables finished, 1 tables failed, 0 tables skipped.
The patch file has been generated in 
	'output_order_group_sharding/fix-on-mysql2/'
You can view the comparision details through './output_order_group_sharding/sync_diff.log'
```

从上面日志看到，校验结果是：

- 表结构不相同：因为本来对比表名称就不同，所以表结构是不同的。
- 表数据相同。

## 3.查看结果

查看校验与修复的汇总输出文件：

![[Pasted image 20240124100311.png|800]]

>注意：并不是像图中红字那样理解的！而是说以下展示的相同的表结构和表数据信息，可以看到并没有。接下来，展示的是表中不一致数据信息。
>是否符合预期：是！

## 4.扩展

这里假设我改动了单表的数据，看看能否根据工具生成最终的数据修复SQL？

```SQL
UPDATE windranger_emr.pat_inhos_order_group_bak1 t SET t.create_person = 'system_001' WHERE t.seq_id = 2165679;
```

重新执行，查看结果：

```shell
# ./sync_diff_inspector --config=./config_order_group.toml
A total of 1 tables need to be compared

Progress [>------------------------------------------------------------] 0% 0/0
Comparing the table structure of ``windranger_emr`.`pat_inhos_order_group_bak1`` ... failure
Comparing the table data of ``windranger_emr`.`pat_inhos_order_group_bak1`` ... failure
_____________________________________________________________________________
Progress [============================================================>] 100% 0/0
The structure of `windranger_emr`.`pat_inhos_order_group_bak1` is not equal
The data of `windranger_emr`.`pat_inhos_order_group_bak1` is not equal

The rest of tables are all equal.

A total of 1 tables have been compared, 0 tables finished, 1 tables failed, 0 tables skipped.
The patch file has been generated in 
	'output_order_group_sharding/fix-on-mysql2/'
You can view the comparision details through './output_order_group_sharding/sync_diff.log'
```

从上面日志看到，校验结果是：

- 表结构不相同：因为本来对比表名称就不同，所以表结构是不同的。
- 表数据不相同：因为我们修改了一条记录。那具体的变动信息是哪些呢？有没有修复SQL呢？

查看校验与修复的汇总输出文件：

![[Pasted image 20240124100447.png|800]]

此时，查看数据修复SQL：

![[Pasted image 20240124100510.png|800]]

查看具体的SQL：

![[Pasted image 20240124100522.png|800]]

可以看到，是我们先前更新的数据信息，该SQL的作用是将目标表数据更新为与源表一致。

可以看到这里是以上游表为参照，所以最终的目的是让下游表与上游表数据保持一致，通过官方文档证实！

![[Pasted image 20240124100603.png|800]]

> 是否符合预期：是！

