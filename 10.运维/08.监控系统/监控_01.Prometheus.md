
- [Prometheus快速入门教程 - 随笔分类 - 陈树义 - 博客园](https://www.cnblogs.com/chanshuyi/category/1862951.html)（Java程序员的一个快速入门版本）
- [Introduction - Prometheus-Book](https://yunlzheng.gitbook.io/prometheus-book/)（推荐）
- [Prometheus中文文档](https://prometheus.fuckcloudnative.io/)（推荐）
- [Prometheus+Grafana](https://blog.csdn.net/qq_31725371/article/details/114697770)
- [Prometheus远程存储VictoriaMetrics](https://hulining.github.io/2021/11/04/victoriametrics-quick-start/)

# 基本架构


![[Pasted image 20240110091544.png|700]]

## Server

Prometheus Server是Prometheus组件中的核心部分，负责实现对监控数据的获取，存储以及查询。 Prometheus Server可以通过静态配置管理监控目标，也可以配合使用Service Discovery的方式动态管理监控目标，并从这些监控目标中获取数据。其次Prometheus Server需要对采集到的监控数据进行存储，Prometheus Server本身就是一个时序数据库，将采集到的监控数据按照时间序列的方式存储在本地磁盘当中。最后Prometheus Server对外提供了自定义的PromQL语言，实现对数据的查询以及分析。

Prometheus Server内置的Express Browser UI，通过这个UI可以直接通过PromQL实现数据的查询以及可视化。

Prometheus Server的联邦集群能力可以使其从其他的Prometheus Server实例中获取数据，因此在大规模监控的情况下，可以通过联邦集群以及功能分区的方式对Prometheus Server进行扩展。

## Exporters

Exporter将监控数据采集的端点通过HTTP服务的形式暴露给Prometheus Server，Prometheus Server通过访问该Exporter提供的Endpoint端点，即可获取到需要采集的监控数据。

一般来说可以将Exporter分为2类：

- **直接采集**：这一类Exporter直接内置了对Prometheus监控的支持，比如cAdvisor，Kubernetes，Etcd，Gokit等，都直接内置了用于向Prometheus暴露监控数据的端点。
- **间接采集**：间接采集，原有监控目标并不直接支持Prometheus，因此我们需要通过Prometheus提供的Client Library编写该监控目标的监控采集程序。例如：Mysql Exporter，JMX Exporter，Consul Exporter等。

## AlertManager

在Prometheus Server中支持基于PromQL创建告警规则，如果满足PromQL定义的规则，则会产生一条告警，而告警的后续处理流程则由AlertManager进行管理。在AlertManager中我们可以与邮件，Slack等等内置的通知方式进行集成，也可以通过Webhook自定义告警处理方式。AlertManager即Prometheus体系中的告警处理中心。

## PushGateway

由于Prometheus数据采集**基于Pull模型**进行设计，因此在网络环境的配置上必须要让Prometheus Server能够直接与Exporter进行通信。当这种网络需求无法直接满足时，就可以利用PushGateway来进行中转。可以通过PushGateway将内部网络的监控数据主动Push到Gateway当中。而Prometheus Server则可以采用同样Pull的方式从PushGateway中获取到监控数据。

# 部署安装

>使用版本：Prometheus 2.45.2

[下载地址](https://prometheus.io/download)

后台方式启动

```bash
touch  /opt/prometheus-2.45.2/prometheus.log
nohup ./prometheus --config.file=prometheus.yml --web.enable-lifecycle > /opt/prometheus-2.45.4/prometheus.log 2>&1 &
nohup ./prometheus --config.file=prometheus.yml --web.enable-lifecycle > ./prometheus.log 2>&1 &
```

>访问地址：http://10.2.43.101:9090

如果启动的时候指定配置`--web.enable-lifecycle`那么后续修改配置后，只需要调用如下接口便会重新加载。

```bash
curl -X POST http://127.0.0.1:9090/-/reload
```

# 数据采集

## Linux

### Client

```bash
nohup ./node_exporter > node_exporter.log 2>&1 &
```

### Server

新增配置：

```yml
scrape_configs:
  - job_name: 'linux'
    static_configs:
    - targets: ['10.2.3.173:9100','10.2.3.66:9100']
```

重新加载配置：

```bash
curl -X POST http://127.0.0.1:9090/-/reload
```

## MySQL

```bash
nohup ./mysqld_exporter --config.my-cnf=.my.cnf > mysqld_exporter.log 2>&1 &
```

## JVM

### Client

```bash
-javaagent:/usr/local/exporter/jvm-exporter/jmx_prometheus_javaagent-0.20.0.jar=8585:/usr/local/exporter/jvm-exporter/config.yaml
```

### Server

## Process

### Client

解压后：

```sh
[root@localhost process-exporter-0.8.4.linux-amd64]# ll
total 11044
-rw-r--r-- 1 1001  127     1076 Oct 17 17:28 LICENSE
-rwxr-xr-x 1 1001  127 11280536 Oct 17 17:29 process-exporter
-rw-r--r-- 1 1001  127    16059 Oct 17 17:28 README.md
```

创建配置文件：vim process_name.yaml

修改配置文件：

```yaml
process_names:
 - name: "{{.Comm}}"
   cmdline:
   - '.+'
```

启动

```bash
nohup ./process-exporter -config.path process_name.yaml > process.log 2>&1 &
```

### Server

修改Prometheus的配置

```yaml
scrape_configs:
  - job_name: 'process'
    static_configs:
    - targets: ['10.2.3.79:9256']
```

重启

```sh
curl -X POST http://127.0.0.1:9090/-/reload
```

```bash
nohup ./mongodb_exporter --mongodb.uri=mongodb://admin:Lachesis-mh_1024@10.2.3.173:27017/?authSource=admin&authMechanism=SCRAM-SHA-1 > mongodb_exporter.log 2>&1 &
```

# Grafana

Grafana 10.0.0

```ad-tip
记得选择Edition为OSS版本~
```

```
sudo yum install -y https://dl.grafana.com/oss/release/grafana-10.4.1-1.x86_64.rpm
systemctl status grafana-server.service
systemctl start grafana-server.service
```

访问：http://10.2.43.101:3000
账户：admin
密码：admin

# 使用VM时序数据库


TODO

